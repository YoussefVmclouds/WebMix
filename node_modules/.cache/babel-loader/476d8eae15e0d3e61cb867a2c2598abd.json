{"remainingRequest":"/Users/youssef/Downloads/WebMix/node_modules/babel-loader/lib/index.js!/Users/youssef/Downloads/WebMix/src/views/janus.js","dependencies":[{"path":"/Users/youssef/Downloads/WebMix/src/views/janus.js","mtime":1647346647085},{"path":"/Users/youssef/Downloads/WebMix/node_modules/cache-loader/dist/cjs.js","mtime":1644235715462},{"path":"/Users/youssef/Downloads/WebMix/node_modules/babel-loader/lib/index.js","mtime":1644235715748}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF90eXBlb2YgZnJvbSAiL1VzZXJzL3lvdXNzZWYvRG93bmxvYWRzL1dlYk1peC9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vdHlwZW9mLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmV4ZWMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcubWF0Y2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5wYXJzZS1pbnQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5iaW5kLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaXMtYXJyYXkuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLml0ZXJhdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5pdGVyYXRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi51cmwuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIudXJsLXNlYXJjaC1wYXJhbXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmRhdGUudG8tc3RyaW5nLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLnRpbWVycy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmpzb24uc3RyaW5naWZ5LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24ubmFtZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNvbWUuanMiOwoKLyogZXNsaW50LWRpc2FibGUgKi8KCi8qCglUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCglDb3B5cmlnaHQgKGMpIDIwMTYgTWVldGVjaG8KCglQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcKCWEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKCXRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24KCXRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLAoJYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlCglTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKCVRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCglpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCglUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwoJT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCglGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTAoJVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IKCU9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLAoJQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCglPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAqLwppbXBvcnQgYWRhcHRlciBmcm9tICd3ZWJydGMtYWRhcHRlcic7IC8vIExpc3Qgb2Ygc2Vzc2lvbnMKCkphbnVzLnNlc3Npb25zID0ge307IC8vIFNjcmVlbnNoYXJpbmcgQ2hyb21lIEV4dGVuc2lvbiBJRAoKSmFudXMuZXh0ZW5zaW9uSWQgPSAiaGFwZmdmZGtsZWlnZ2pqcGZwZW5hamdkbmZja2pwYWoiOwoKSmFudXMuaXNFeHRlbnNpb25FbmFibGVkID0gZnVuY3Rpb24gKCkgewogIGlmICh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgnQ2hyb21lJykpIHsKICAgIHZhciBjaHJvbWV2ZXIgPSBwYXJzZUludCh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvQ2hyb21lXC8oLiopIC8pWzFdLCAxMCk7CiAgICB2YXIgbWF4dmVyID0gMzM7CiAgICBpZiAod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goJ0xpbnV4JykpIG1heHZlciA9IDM1OyAvLyAia25vd24iIGNyYXNoIGluIGNocm9tZSAzNCBhbmQgMzUgb24gbGludXgKCiAgICBpZiAoY2hyb21ldmVyID49IDI2ICYmIGNocm9tZXZlciA8PSBtYXh2ZXIpIHsKICAgICAgLy8gT2xkZXIgdmVyc2lvbnMgb2YgQ2hyb21lIGRvbid0IHN1cHBvcnQgdGhpcyBleHRlbnNpb24tYmFzZWQgYXBwcm9hY2gsIHNvIGxpZQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2phbnVzLWV4dGVuc2lvbi1pbnN0YWxsZWQnKSAhPT0gbnVsbDsKICB9IGVsc2UgewogICAgLy8gRmlyZWZveCBvZiBvdGhlcnMsIG5vIG5lZWQgZm9yIHRoZSBleHRlbnNpb24gKGJ1dCB0aGlzIGRvZXNuJ3QgbWVhbiBpdCB3aWxsIHdvcmspCiAgICByZXR1cm4gdHJ1ZTsKICB9Cn07CgpKYW51cy5ub29wID0gZnVuY3Rpb24gKCkge307IC8vIEluaXRpYWxpemF0aW9uCgoKSmFudXMuaW5pdCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy5jYWxsYmFjayA9IHR5cGVvZiBvcHRpb25zLmNhbGxiYWNrID09ICJmdW5jdGlvbiIgPyBvcHRpb25zLmNhbGxiYWNrIDogSmFudXMubm9vcDsKCiAgaWYgKEphbnVzLmluaXREb25lID09PSB0cnVlKSB7CiAgICAvLyBBbHJlYWR5IGluaXRpYWxpemVkCiAgICBvcHRpb25zLmNhbGxiYWNrKCk7CiAgfSBlbHNlIHsKICAgIGlmICh0eXBlb2YgY29uc29sZSA9PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgY29uc29sZS5sb2cgPT0gInVuZGVmaW5lZCIpIGNvbnNvbGUgPSB7CiAgICAgIGxvZzogZnVuY3Rpb24gbG9nKCkge30KICAgIH07IC8vIENvbnNvbGUgbG9nZ2luZyAoYWxsIGRlYnVnZ2luZyBkaXNhYmxlZCBieSBkZWZhdWx0KQoKICAgIEphbnVzLnRyYWNlID0gSmFudXMubm9vcDsKICAgIEphbnVzLmRlYnVnID0gSmFudXMubm9vcDsKICAgIEphbnVzLnZkZWJ1ZyA9IEphbnVzLm5vb3A7CiAgICBKYW51cy5sb2cgPSBKYW51cy5ub29wOwogICAgSmFudXMud2FybiA9IEphbnVzLm5vb3A7CiAgICBKYW51cy5lcnJvciA9IEphbnVzLm5vb3A7CgogICAgaWYgKG9wdGlvbnMuZGVidWcgPT09IHRydWUgfHwgb3B0aW9ucy5kZWJ1ZyA9PT0gImFsbCIpIHsKICAgICAgLy8gRW5hYmxlIGFsbCBkZWJ1Z2dpbmcgbGV2ZWxzCiAgICAgIEphbnVzLnRyYWNlID0gY29uc29sZS50cmFjZS5iaW5kKGNvbnNvbGUpOwogICAgICBKYW51cy5kZWJ1ZyA9IGNvbnNvbGUuZGVidWcuYmluZChjb25zb2xlKTsKICAgICAgSmFudXMudmRlYnVnID0gY29uc29sZS5kZWJ1Zy5iaW5kKGNvbnNvbGUpOwogICAgICBKYW51cy5sb2cgPSBjb25zb2xlLmxvZy5iaW5kKGNvbnNvbGUpOwogICAgICBKYW51cy53YXJuID0gY29uc29sZS53YXJuLmJpbmQoY29uc29sZSk7CiAgICAgIEphbnVzLmVycm9yID0gY29uc29sZS5lcnJvci5iaW5kKGNvbnNvbGUpOwogICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9wdGlvbnMuZGVidWcpKSB7CiAgICAgIGZvciAodmFyIGkgaW4gb3B0aW9ucy5kZWJ1ZykgewogICAgICAgIHZhciBkID0gb3B0aW9ucy5kZWJ1Z1tpXTsKCiAgICAgICAgc3dpdGNoIChkKSB7CiAgICAgICAgICBjYXNlICJ0cmFjZSI6CiAgICAgICAgICAgIEphbnVzLnRyYWNlID0gY29uc29sZS50cmFjZS5iaW5kKGNvbnNvbGUpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICJkZWJ1ZyI6CiAgICAgICAgICAgIEphbnVzLmRlYnVnID0gY29uc29sZS5kZWJ1Zy5iaW5kKGNvbnNvbGUpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICJ2ZGVidWciOgogICAgICAgICAgICBKYW51cy52ZGVidWcgPSBjb25zb2xlLmRlYnVnLmJpbmQoY29uc29sZSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgImxvZyI6CiAgICAgICAgICAgIEphbnVzLmxvZyA9IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgIndhcm4iOgogICAgICAgICAgICBKYW51cy53YXJuID0gY29uc29sZS53YXJuLmJpbmQoY29uc29sZSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgImVycm9yIjoKICAgICAgICAgICAgSmFudXMuZXJyb3IgPSBjb25zb2xlLmVycm9yLmJpbmQoY29uc29sZSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlVua25vd24gZGVidWdnaW5nIG9wdGlvbiAnIiArIGQgKyAiJyAoc3VwcG9ydGVkOiAndHJhY2UnLCAnZGVidWcnLCAndmRlYnVnJywgJ2xvZycsIHdhcm4nLCAnZXJyb3InKSIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBKYW51cy5sb2coIkluaXRpYWxpemluZyBsaWJyYXJ5Iik7IC8vIEhlbHBlciBtZXRob2QgdG8gZW51bWVyYXRlIGRldmljZXMKCiAgICBKYW51cy5saXN0RGV2aWNlcyA9IGZ1bmN0aW9uIChjYWxsYmFjaywgY29uZmlnKSB7CiAgICAgIGNhbGxiYWNrID0gdHlwZW9mIGNhbGxiYWNrID09ICJmdW5jdGlvbiIgPyBjYWxsYmFjayA6IEphbnVzLm5vb3A7CiAgICAgIGlmIChjb25maWcgPT0gbnVsbCkgY29uZmlnID0gewogICAgICAgIGF1ZGlvOiB0cnVlLAogICAgICAgIHZpZGVvOiB0cnVlCiAgICAgIH07CgogICAgICBpZiAobmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgewogICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKGNvbmZpZykudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKS50aGVuKGZ1bmN0aW9uIChkZXZpY2VzKSB7CiAgICAgICAgICAgIEphbnVzLmRlYnVnKGRldmljZXMpOwogICAgICAgICAgICBjYWxsYmFjayhkZXZpY2VzKTsgLy8gR2V0IHJpZCBvZiB0aGUgbm93IHVzZWxlc3Mgc3RyZWFtCgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0cmVhbS5zdG9wKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciB0cmFja3MgPSBzdHJlYW0uZ2V0VHJhY2tzKCk7CgogICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gdHJhY2tzKSB7CiAgICAgICAgICAgICAgICB2YXIgbXN0ID0gdHJhY2tzW2ldOwogICAgICAgICAgICAgICAgaWYgKG1zdCAhPT0gbnVsbCAmJiBtc3QgIT09IHVuZGVmaW5lZCkgbXN0LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICB9KTsKICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBKYW51cy5lcnJvcihlcnIpOwogICAgICAgICAgY2FsbGJhY2soW10pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIEphbnVzLndhcm4oIm5hdmlnYXRvci5tZWRpYURldmljZXMgdW5hdmFpbGFibGUiKTsKICAgICAgICBjYWxsYmFjayhbXSk7CiAgICAgIH0KICAgIH07IC8vIEhlbHBlciBtZXRob2RzIHRvIGF0dGFjaC9yZWF0dGFjaCBhIHN0cmVhbSB0byBhIHZpZGVvIGVsZW1lbnQgKHByZXZpb3VzbHkgcGFydCBvZiBhZGFwdGVyLmpzKQoKCiAgICBKYW51cy5hdHRhY2hNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChlbGVtZW50LCBzdHJlYW0pIHsKICAgICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PT0gJ2Nocm9tZScpIHsKICAgICAgICB2YXIgY2hyb21ldmVyID0gYWRhcHRlci5icm93c2VyRGV0YWlscy52ZXJzaW9uOwoKICAgICAgICBpZiAoY2hyb21ldmVyID49IDQzKSB7CiAgICAgICAgICBlbGVtZW50LnNyY09iamVjdCA9IHN0cmVhbTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LnNyYyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIGVsZW1lbnQuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChzdHJlYW0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBKYW51cy5lcnJvcigiRXJyb3IgYXR0YWNoaW5nIHN0cmVhbSB0byBlbGVtZW50Iik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQuc3JjT2JqZWN0ID0gc3RyZWFtOwogICAgICB9CiAgICB9OwoKICAgIEphbnVzLnJlYXR0YWNoTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAodG8sIGZyb20pIHsKICAgICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PT0gJ2Nocm9tZScpIHsKICAgICAgICB2YXIgY2hyb21ldmVyID0gYWRhcHRlci5icm93c2VyRGV0YWlscy52ZXJzaW9uOwoKICAgICAgICBpZiAoY2hyb21ldmVyID49IDQzKSB7CiAgICAgICAgICB0by5zcmNPYmplY3QgPSBmcm9tLnNyY09iamVjdDsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0by5zcmMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICB0by5zcmMgPSBmcm9tLnNyYzsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoYWRhcHRlci5icm93c2VyRGV0YWlscy5icm93c2VyID09PSAnc2FmYXJpJyB8fCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvaVBhZC9pKSB8fCB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvaVBob25lL2kpKSB7CiAgICAgICAgdG8uc3JjID0gZnJvbS5zcmM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdG8uc3JjT2JqZWN0ID0gZnJvbS5zcmNPYmplY3Q7CiAgICAgIH0KICAgIH07IC8vIFByZXBhcmUgYSBoZWxwZXIgbWV0aG9kIHRvIHNlbmQgQUpBWCByZXF1ZXN0cyBpbiBhIHN5bnRheCBzaW1pbGFyIHRvIGpRdWVyeSAoYXQgbGVhc3QgZm9yIHdoYXQgd2UgY2FyZSkKCgogICAgSmFudXMuYWpheCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgICAgLy8gQ2hlY2sgcGFyYW1zCiAgICAgIGlmIChwYXJhbXMgPT09IG51bGwgfHwgcGFyYW1zID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgcGFyYW1zLnN1Y2Nlc3MgPSB0eXBlb2YgcGFyYW1zLnN1Y2Nlc3MgPT0gImZ1bmN0aW9uIiA/IHBhcmFtcy5zdWNjZXNzIDogSmFudXMubm9vcDsKICAgICAgcGFyYW1zLmVycm9yID0gdHlwZW9mIHBhcmFtcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gcGFyYW1zLmVycm9yIDogSmFudXMubm9vcDsgLy8gTWFrZSBzdXJlIHRoZXJlJ3MgYW4gVVJMCgogICAgICBpZiAocGFyYW1zLnVybCA9PT0gbnVsbCB8fCBwYXJhbXMudXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICBKYW51cy5lcnJvcignTWlzc2luZyB1cmwnLCBwYXJhbXMudXJsKTsKICAgICAgICBwYXJhbXMuZXJyb3IobnVsbCwgLTEsICdNaXNzaW5nIHVybCcpOwogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBWYWxpZGF0ZSBhc3luYwoKCiAgICAgIHBhcmFtcy5hc3luYyA9IHBhcmFtcy5hc3luYyA9PT0gbnVsbCB8fCBwYXJhbXMuYXN5bmMgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBwYXJhbXMuYXN5bmMgPT09IHRydWU7CiAgICAgIEphbnVzLmxvZyhwYXJhbXMpOyAvLyBJRSBkb2Vzbid0IGV2ZW4ga25vdyB3aGF0IFdlYlJUQyBpcywgc28gbm8gcG9seWZpbGwgbmVlZGVkCgogICAgICB2YXIgWEhSID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgIFhIUi5vcGVuKHBhcmFtcy50eXBlLCBwYXJhbXMudXJsLCBwYXJhbXMuYXN5bmMpOwogICAgICBpZiAocGFyYW1zLmNvbnRlbnRUeXBlICE9PSBudWxsICYmIHBhcmFtcy5jb250ZW50VHlwZSAhPT0gdW5kZWZpbmVkKSBYSFIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC10eXBlJywgcGFyYW1zLmNvbnRlbnRUeXBlKTsKICAgICAgaWYgKHBhcmFtcy53aXRoQ3JlZGVudGlhbHMgIT09IG51bGwgJiYgcGFyYW1zLndpdGhDcmVkZW50aWFscyAhPT0gdW5kZWZpbmVkKSBYSFIud2l0aENyZWRlbnRpYWxzID0gcGFyYW1zLndpdGhDcmVkZW50aWFsczsKCiAgICAgIGlmIChwYXJhbXMuYXN5bmMpIHsKICAgICAgICBYSFIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKFhIUi5yZWFkeVN0YXRlICE9IDQpIHJldHVybjsKCiAgICAgICAgICBpZiAoWEhSLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIC8vIEdvdCBhbiBlcnJvcj8KICAgICAgICAgICAgcGFyYW1zLmVycm9yKFhIUiwgWEhSLnN0YXR1cyAhPT0gMCA/IFhIUi5zdGF0dXMgOiAnZXJyb3InLCAiIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gLy8gR290IHBheWxvYWQKCgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcGFyYW1zLnN1Y2Nlc3MoSlNPTi5wYXJzZShYSFIucmVzcG9uc2VUZXh0KSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHBhcmFtcy5lcnJvcihYSFIsIFhIUi5zdGF0dXMsICdDb3VsZCBub3QgcGFyc2UgcmVzcG9uc2UsIGVycm9yOiAnICsgZSArICcsIHRleHQ6ICcgKyBYSFIucmVzcG9uc2VUZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICB0cnkgewogICAgICAgIFhIUi5zZW5kKHBhcmFtcy5kYXRhKTsKCiAgICAgICAgaWYgKCFwYXJhbXMuYXN5bmMpIHsKICAgICAgICAgIGlmIChYSFIuc3RhdHVzICE9PSAyMDApIHsKICAgICAgICAgICAgLy8gR290IGFuIGVycm9yPwogICAgICAgICAgICBwYXJhbXMuZXJyb3IoWEhSLCBYSFIuc3RhdHVzICE9PSAwID8gWEhSLnN0YXR1cyA6ICdlcnJvcicsICIiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSAvLyBHb3QgcGF5bG9hZAoKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBwYXJhbXMuc3VjY2VzcyhKU09OLnBhcnNlKFhIUi5yZXNwb25zZVRleHQpKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFyYW1zLmVycm9yKFhIUiwgWEhSLnN0YXR1cywgJ0NvdWxkIG5vdCBwYXJzZSByZXNwb25zZSwgZXJyb3I6ICcgKyBlICsgJywgdGV4dDogJyArIFhIUi5yZXNwb25zZVRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFNvbWV0aGluZyBicm9rZSB1cAogICAgICAgIHBhcmFtcy5lcnJvcihYSFIsICdlcnJvcicsICcnKTsKICAgICAgfQoKICAgICAgOwogICAgfTsgLy8gRGV0ZWN0IHRhYiBjbG9zZTogbWFrZSBzdXJlIHdlIGRvbid0IGxvb3NlIGV4aXN0aW5nIG9uYmVmb3JldW5sb2FkIGhhbmRsZXJzCgoKICAgIHZhciBvbGRPQkYgPSB3aW5kb3cub25iZWZvcmV1bmxvYWQ7CgogICAgd2luZG93Lm9uYmVmb3JldW5sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICBKYW51cy5sb2coIkNsb3Npbmcgd2luZG93Iik7CgogICAgICBmb3IgKHZhciBzIGluIEphbnVzLnNlc3Npb25zKSB7CiAgICAgICAgaWYgKEphbnVzLnNlc3Npb25zW3NdICE9PSBudWxsICYmIEphbnVzLnNlc3Npb25zW3NdICE9PSB1bmRlZmluZWQgJiYgSmFudXMuc2Vzc2lvbnNbc10uZGVzdHJveU9uVW5sb2FkKSB7CiAgICAgICAgICBKYW51cy5sb2coIkRlc3Ryb3lpbmcgc2Vzc2lvbiAiICsgcyk7CiAgICAgICAgICBKYW51cy5zZXNzaW9uc1tzXS5kZXN0cm95KHsKICAgICAgICAgICAgYXN5bmNSZXF1ZXN0OiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAob2xkT0JGICYmIHR5cGVvZiBvbGRPQkYgPT0gImZ1bmN0aW9uIikgb2xkT0JGKCk7CiAgICB9OwoKICAgIEphbnVzLmluaXREb25lID0gdHJ1ZTsKICAgIG9wdGlvbnMuY2FsbGJhY2soKTsKICB9Cn07IC8vIEhlbHBlciBtZXRob2QgdG8gY2hlY2sgd2hldGhlciBXZWJSVEMgaXMgc3VwcG9ydGVkIGJ5IHRoaXMgYnJvd3NlcgoKCkphbnVzLmlzV2VicnRjU3VwcG9ydGVkID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gIT09IHVuZGVmaW5lZCAmJiB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gIT09IG51bGwgJiYgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSAhPT0gdW5kZWZpbmVkICYmIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgIT09IG51bGw7Cn07IC8vIEhlbHBlciBtZXRob2QgdG8gY3JlYXRlIHJhbmRvbSBpZGVudGlmaWVycyAoZS5nLiwgdHJhbnNhY3Rpb24pCgoKSmFudXMucmFuZG9tU3RyaW5nID0gZnVuY3Rpb24gKGxlbikgewogIHZhciBjaGFyU2V0ID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5JzsKICB2YXIgcmFuZG9tU3RyaW5nID0gJyc7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIHZhciByYW5kb21Qb3ogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFyU2V0Lmxlbmd0aCk7CiAgICByYW5kb21TdHJpbmcgKz0gY2hhclNldC5zdWJzdHJpbmcocmFuZG9tUG96LCByYW5kb21Qb3ogKyAxKTsKICB9CgogIHJldHVybiByYW5kb21TdHJpbmc7Cn07IC8vIEphbnVzIHNlc3Npb24gb2JqZWN0CgoKZnVuY3Rpb24gSmFudXMoZ2F0ZXdheUNhbGxiYWNrcykgewogIGlmIChKYW51cy5pbml0RG9uZSA9PT0gdW5kZWZpbmVkKSB7CiAgICBnYXRld2F5Q2FsbGJhY2tzLmVycm9yKCJMaWJyYXJ5IG5vdCBpbml0aWFsaXplZCIpOwogICAgcmV0dXJuIHt9OwogIH0KCiAgaWYgKCFKYW51cy5pc1dlYnJ0Y1N1cHBvcnRlZCgpKSB7CiAgICBnYXRld2F5Q2FsbGJhY2tzLmVycm9yKCJXZWJSVEMgbm90IHN1cHBvcnRlZCBieSB0aGlzIGJyb3dzZXIiKTsKICAgIHJldHVybiB7fTsKICB9CgogIEphbnVzLmxvZygiTGlicmFyeSBpbml0aWFsaXplZDogIiArIEphbnVzLmluaXREb25lKTsKICBnYXRld2F5Q2FsbGJhY2tzID0gZ2F0ZXdheUNhbGxiYWNrcyB8fCB7fTsKICBnYXRld2F5Q2FsbGJhY2tzLnN1Y2Nlc3MgPSB0eXBlb2YgZ2F0ZXdheUNhbGxiYWNrcy5zdWNjZXNzID09ICJmdW5jdGlvbiIgPyBnYXRld2F5Q2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogIGdhdGV3YXlDYWxsYmFja3MuZXJyb3IgPSB0eXBlb2YgZ2F0ZXdheUNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gZ2F0ZXdheUNhbGxiYWNrcy5lcnJvciA6IEphbnVzLm5vb3A7CiAgZ2F0ZXdheUNhbGxiYWNrcy5kZXN0cm95ZWQgPSB0eXBlb2YgZ2F0ZXdheUNhbGxiYWNrcy5kZXN0cm95ZWQgPT0gImZ1bmN0aW9uIiA/IGdhdGV3YXlDYWxsYmFja3MuZGVzdHJveWVkIDogSmFudXMubm9vcDsKCiAgaWYgKGdhdGV3YXlDYWxsYmFja3Muc2VydmVyID09PSBudWxsIHx8IGdhdGV3YXlDYWxsYmFja3Muc2VydmVyID09PSB1bmRlZmluZWQpIHsKICAgIGdhdGV3YXlDYWxsYmFja3MuZXJyb3IoIkludmFsaWQgZ2F0ZXdheSB1cmwiKTsKICAgIHJldHVybiB7fTsKICB9CgogIHZhciB3ZWJzb2NrZXRzID0gZmFsc2U7CiAgdmFyIHdzID0gbnVsbDsKICB2YXIgd3NIYW5kbGVycyA9IHt9OwogIHZhciB3c0tlZXBhbGl2ZVRpbWVvdXRJZCA9IG51bGw7CiAgdmFyIHNlcnZlcnMgPSBudWxsLAogICAgICBzZXJ2ZXJzSW5kZXggPSAwOwogIHZhciBzZXJ2ZXIgPSBnYXRld2F5Q2FsbGJhY2tzLnNlcnZlcjsKCiAgaWYgKEFycmF5LmlzQXJyYXkoc2VydmVyKSkgewogICAgSmFudXMubG9nKCJNdWx0aXBsZSBzZXJ2ZXJzIHByb3ZpZGVkICgiICsgc2VydmVyLmxlbmd0aCArICIpLCB3aWxsIHVzZSB0aGUgZmlyc3QgdGhhdCB3b3JrcyIpOwogICAgc2VydmVyID0gbnVsbDsKICAgIHNlcnZlcnMgPSBnYXRld2F5Q2FsbGJhY2tzLnNlcnZlcjsKICAgIEphbnVzLmRlYnVnKHNlcnZlcnMpOwogIH0gZWxzZSB7CiAgICBpZiAoc2VydmVyLmluZGV4T2YoIndzIikgPT09IDApIHsKICAgICAgd2Vic29ja2V0cyA9IHRydWU7CiAgICAgIEphbnVzLmxvZygiVXNpbmcgV2ViU29ja2V0cyB0byBjb250YWN0IEphbnVzOiAiICsgc2VydmVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHdlYnNvY2tldHMgPSBmYWxzZTsKICAgICAgSmFudXMubG9nKCJVc2luZyBSRVNUIEFQSSB0byBjb250YWN0IEphbnVzOiAiICsgc2VydmVyKTsKICAgIH0KICB9CgogIHZhciBpY2VTZXJ2ZXJzID0gZ2F0ZXdheUNhbGxiYWNrcy5pY2VTZXJ2ZXJzOwogIGlmIChpY2VTZXJ2ZXJzID09PSB1bmRlZmluZWQgfHwgaWNlU2VydmVycyA9PT0gbnVsbCkgaWNlU2VydmVycyA9IFt7CiAgICB1cmxzOiAic3R1bjpzdHVuLmwuZ29vZ2xlLmNvbToxOTMwMiIKICB9XTsKICB2YXIgaWNlVHJhbnNwb3J0UG9saWN5ID0gZ2F0ZXdheUNhbGxiYWNrcy5pY2VUcmFuc3BvcnRQb2xpY3k7IC8vIFdoZXRoZXIgSVB2NiBjYW5kaWRhdGVzIHNob3VsZCBiZSBnYXRoZXJlZAoKICB2YXIgaXB2NlN1cHBvcnQgPSBnYXRld2F5Q2FsbGJhY2tzLmlwdjY7CiAgaWYgKGlwdjZTdXBwb3J0ID09PSB1bmRlZmluZWQgfHwgaXB2NlN1cHBvcnQgPT09IG51bGwpIGlwdjZTdXBwb3J0ID0gZmFsc2U7IC8vIFdoZXRoZXIgd2Ugc2hvdWxkIGVuYWJsZSB0aGUgd2l0aENyZWRlbnRpYWxzIGZsYWcgZm9yIFhIUiByZXF1ZXN0cwoKICB2YXIgd2l0aENyZWRlbnRpYWxzID0gZmFsc2U7CiAgaWYgKGdhdGV3YXlDYWxsYmFja3Mud2l0aENyZWRlbnRpYWxzICE9PSB1bmRlZmluZWQgJiYgZ2F0ZXdheUNhbGxiYWNrcy53aXRoQ3JlZGVudGlhbHMgIT09IG51bGwpIHdpdGhDcmVkZW50aWFscyA9IGdhdGV3YXlDYWxsYmFja3Mud2l0aENyZWRlbnRpYWxzID09PSB0cnVlOyAvLyBPcHRpb25hbCBtYXggZXZlbnRzCgogIHZhciBtYXhldiA9IG51bGw7CiAgaWYgKGdhdGV3YXlDYWxsYmFja3MubWF4X3BvbGxfZXZlbnRzICE9PSB1bmRlZmluZWQgJiYgZ2F0ZXdheUNhbGxiYWNrcy5tYXhfcG9sbF9ldmVudHMgIT09IG51bGwpIG1heGV2ID0gZ2F0ZXdheUNhbGxiYWNrcy5tYXhfcG9sbF9ldmVudHM7CiAgaWYgKG1heGV2IDwgMSkgbWF4ZXYgPSAxOyAvLyBUb2tlbiB0byB1c2UgKG9ubHkgaWYgdGhlIHRva2VuIGJhc2VkIGF1dGhlbnRpY2F0aW9uIG1lY2hhbmlzbSBpcyBlbmFibGVkKQoKICB2YXIgdG9rZW4gPSBudWxsOwogIGlmIChnYXRld2F5Q2FsbGJhY2tzLnRva2VuICE9PSB1bmRlZmluZWQgJiYgZ2F0ZXdheUNhbGxiYWNrcy50b2tlbiAhPT0gbnVsbCkgdG9rZW4gPSBnYXRld2F5Q2FsbGJhY2tzLnRva2VuOyAvLyBBUEkgc2VjcmV0IHRvIHVzZSAob25seSBpZiB0aGUgc2hhcmVkIEFQSSBzZWNyZXQgaXMgZW5hYmxlZCkKCiAgdmFyIGFwaXNlY3JldCA9IG51bGw7CiAgaWYgKGdhdGV3YXlDYWxsYmFja3MuYXBpc2VjcmV0ICE9PSB1bmRlZmluZWQgJiYgZ2F0ZXdheUNhbGxiYWNrcy5hcGlzZWNyZXQgIT09IG51bGwpIGFwaXNlY3JldCA9IGdhdGV3YXlDYWxsYmFja3MuYXBpc2VjcmV0OyAvLyBXaGV0aGVyIHdlIHNob3VsZCBkZXN0cm95IHRoaXMgc2Vzc2lvbiB3aGVuIG9uYmVmb3JldW5sb2FkIGlzIGNhbGxlZAoKICB0aGlzLmRlc3Ryb3lPblVubG9hZCA9IHRydWU7CiAgaWYgKGdhdGV3YXlDYWxsYmFja3MuZGVzdHJveU9uVW5sb2FkICE9PSB1bmRlZmluZWQgJiYgZ2F0ZXdheUNhbGxiYWNrcy5kZXN0cm95T25VbmxvYWQgIT09IG51bGwpIHRoaXMuZGVzdHJveU9uVW5sb2FkID0gZ2F0ZXdheUNhbGxiYWNrcy5kZXN0cm95T25VbmxvYWQgPT09IHRydWU7CiAgdmFyIGNvbm5lY3RlZCA9IGZhbHNlOwogIHZhciBzZXNzaW9uSWQgPSBudWxsOwogIHZhciBwbHVnaW5IYW5kbGVzID0ge307CiAgdmFyIHRoYXQgPSB0aGlzOwogIHZhciByZXRyaWVzID0gMDsKICB2YXIgdHJhbnNhY3Rpb25zID0ge307CiAgY3JlYXRlU2Vzc2lvbihnYXRld2F5Q2FsbGJhY2tzKTsgLy8gUHVibGljIG1ldGhvZHMKCiAgdGhpcy5nZXRTZXJ2ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gc2VydmVyOwogIH07CgogIHRoaXMuaXNDb25uZWN0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdGVkOwogIH07CgogIHRoaXMuZ2V0U2Vzc2lvbklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHNlc3Npb25JZDsKICB9OwoKICB0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICBkZXN0cm95U2Vzc2lvbihjYWxsYmFja3MsIHRydWUpOwogIH07CgogIHRoaXMuYXR0YWNoID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgY3JlYXRlSGFuZGxlKGNhbGxiYWNrcyk7CiAgfTsKCiAgZnVuY3Rpb24gZXZlbnRIYW5kbGVyKCkgewogICAgaWYgKHNlc3Npb25JZCA9PSBudWxsKSByZXR1cm47CiAgICBKYW51cy5kZWJ1ZygnTG9uZyBwb2xsLi4uJyk7CgogICAgaWYgKCFjb25uZWN0ZWQpIHsKICAgICAgSmFudXMud2FybigiSXMgdGhlIGdhdGV3YXkgZG93bj8gKGNvbm5lY3RlZD1mYWxzZSkiKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBsb25ncG9sbCA9IHNlcnZlciArICIvIiArIHNlc3Npb25JZCArICI/cmlkPSIgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmIChtYXhldiAhPT0gdW5kZWZpbmVkICYmIG1heGV2ICE9PSBudWxsKSBsb25ncG9sbCA9IGxvbmdwb2xsICsgIiZtYXhldj0iICsgbWF4ZXY7CiAgICBpZiAodG9rZW4gIT09IG51bGwgJiYgdG9rZW4gIT09IHVuZGVmaW5lZCkgbG9uZ3BvbGwgPSBsb25ncG9sbCArICImdG9rZW49IiArIHRva2VuOwogICAgaWYgKGFwaXNlY3JldCAhPT0gbnVsbCAmJiBhcGlzZWNyZXQgIT09IHVuZGVmaW5lZCkgbG9uZ3BvbGwgPSBsb25ncG9sbCArICImYXBpc2VjcmV0PSIgKyBhcGlzZWNyZXQ7CiAgICBKYW51cy5hamF4KHsKICAgICAgdHlwZTogJ0dFVCcsCiAgICAgIHVybDogbG9uZ3BvbGwsCiAgICAgIHdpdGhDcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzLAogICAgICBjYWNoZTogZmFsc2UsCiAgICAgIHRpbWVvdXQ6IDYwMDAwLAogICAgICAvLyBGSVhNRQogICAgICBzdWNjZXNzOiBoYW5kbGVFdmVudCwKICAgICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKFhNTEh0dHBSZXF1ZXN0LCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgewogICAgICAgIEphbnVzLmVycm9yKHRleHRTdGF0dXMgKyAiOiAiICsgZXJyb3JUaHJvd24pOwogICAgICAgIHJldHJpZXMrKzsKCiAgICAgICAgaWYgKHJldHJpZXMgPiAzKSB7CiAgICAgICAgICAvLyBEaWQgd2UganVzdCBsb3NlIHRoZSBnYXRld2F5PyA6LSgKICAgICAgICAgIGNvbm5lY3RlZCA9IGZhbHNlOwogICAgICAgICAgZ2F0ZXdheUNhbGxiYWNrcy5lcnJvcigiTG9zdCBjb25uZWN0aW9uIHRvIHRoZSBnYXRld2F5IChpcyBpdCBkb3duPykiKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50SGFuZGxlcigpOwogICAgICB9LAogICAgICBkYXRhVHlwZTogImpzb24iCiAgICB9KTsKICB9IC8vIFByaXZhdGUgZXZlbnQgaGFuZGxlcjogdGhpcyB3aWxsIHRyaWdnZXIgcGx1Z2luIGNhbGxiYWNrcywgaWYgc2V0CgoKICBmdW5jdGlvbiBoYW5kbGVFdmVudChqc29uLCBza2lwVGltZW91dCkgewogICAgcmV0cmllcyA9IDA7CiAgICBpZiAoIXdlYnNvY2tldHMgJiYgc2Vzc2lvbklkICE9PSB1bmRlZmluZWQgJiYgc2Vzc2lvbklkICE9PSBudWxsICYmIHNraXBUaW1lb3V0ICE9PSB0cnVlKSBzZXRUaW1lb3V0KGV2ZW50SGFuZGxlciwgMjAwKTsKCiAgICBpZiAoIXdlYnNvY2tldHMgJiYgQXJyYXkuaXNBcnJheShqc29uKSkgewogICAgICAvLyBXZSBnb3QgYW4gYXJyYXk6IGl0IG1lYW5zIHdlIHBhc3NlZCBhIG1heGV2ID4gMSwgaXRlcmF0ZSBvbiBhbGwgb2JqZWN0cwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpzb24ubGVuZ3RoOyBpKyspIHsKICAgICAgICBoYW5kbGVFdmVudChqc29uW2ldLCB0cnVlKTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChqc29uWyJqYW51cyJdID09PSAia2VlcGFsaXZlIikgewogICAgICAvLyBOb3RoaW5nIGhhcHBlbmVkCiAgICAgIEphbnVzLnZkZWJ1ZygiR290IGEga2VlcGFsaXZlIG9uIHNlc3Npb24gIiArIHNlc3Npb25JZCk7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAoanNvblsiamFudXMiXSA9PT0gImFjayIpIHsKICAgICAgLy8gSnVzdCBhbiBhY2ssIHdlIGNhbiBwcm9iYWJseSBpZ25vcmUKICAgICAgSmFudXMuZGVidWcoIkdvdCBhbiBhY2sgb24gc2Vzc2lvbiAiICsgc2Vzc2lvbklkKTsKICAgICAgSmFudXMuZGVidWcoanNvbik7CiAgICAgIHZhciB0cmFuc2FjdGlvbiA9IGpzb25bInRyYW5zYWN0aW9uIl07CgogICAgICBpZiAodHJhbnNhY3Rpb24gIT09IG51bGwgJiYgdHJhbnNhY3Rpb24gIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciByZXBvcnRTdWNjZXNzID0gdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uXTsKCiAgICAgICAgaWYgKHJlcG9ydFN1Y2Nlc3MgIT09IG51bGwgJiYgcmVwb3J0U3VjY2VzcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXBvcnRTdWNjZXNzKGpzb24pOwogICAgICAgIH0KCiAgICAgICAgZGVsZXRlIHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbl07CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAoanNvblsiamFudXMiXSA9PT0gInN1Y2Nlc3MiKSB7CiAgICAgIC8vIFN1Y2Nlc3MhCiAgICAgIEphbnVzLmRlYnVnKCJHb3QgYSBzdWNjZXNzIG9uIHNlc3Npb24gIiArIHNlc3Npb25JZCk7CiAgICAgIEphbnVzLmRlYnVnKGpzb24pOwogICAgICB2YXIgdHJhbnNhY3Rpb24gPSBqc29uWyJ0cmFuc2FjdGlvbiJdOwoKICAgICAgaWYgKHRyYW5zYWN0aW9uICE9PSBudWxsICYmIHRyYW5zYWN0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgcmVwb3J0U3VjY2VzcyA9IHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbl07CgogICAgICAgIGlmIChyZXBvcnRTdWNjZXNzICE9PSBudWxsICYmIHJlcG9ydFN1Y2Nlc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmVwb3J0U3VjY2Vzcyhqc29uKTsKICAgICAgICB9CgogICAgICAgIGRlbGV0ZSB0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25dOwogICAgICB9CgogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGpzb25bImphbnVzIl0gPT09ICJ3ZWJydGN1cCIpIHsKICAgICAgLy8gVGhlIFBlZXJDb25uZWN0aW9uIHdpdGggdGhlIGdhdGV3YXkgaXMgdXAhIE5vdGlmeSB0aGlzCiAgICAgIEphbnVzLmRlYnVnKCJHb3QgYSB3ZWJydGN1cCBldmVudCBvbiBzZXNzaW9uICIgKyBzZXNzaW9uSWQpOwogICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKICAgICAgdmFyIHNlbmRlciA9IGpzb25bInNlbmRlciJdOwoKICAgICAgaWYgKHNlbmRlciA9PT0gdW5kZWZpbmVkIHx8IHNlbmRlciA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLndhcm4oIk1pc3Npbmcgc2VuZGVyLi4uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGx1Z2luSGFuZGxlID0gcGx1Z2luSGFuZGxlc1tzZW5kZXJdOwoKICAgICAgaWYgKHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLmRlYnVnKCJUaGlzIGhhbmRsZSBpcyBub3QgYXR0YWNoZWQgdG8gdGhpcyBzZXNzaW9uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBwbHVnaW5IYW5kbGUud2VicnRjU3RhdGUodHJ1ZSk7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAoanNvblsiamFudXMiXSA9PT0gImhhbmd1cCIpIHsKICAgICAgLy8gQSBwbHVnaW4gYXNrZWQgdGhlIGNvcmUgdG8gaGFuZ3VwIGEgUGVlckNvbm5lY3Rpb24gb24gb25lIG9mIG91ciBoYW5kbGVzCiAgICAgIEphbnVzLmRlYnVnKCJHb3QgYSBoYW5ndXAgZXZlbnQgb24gc2Vzc2lvbiAiICsgc2Vzc2lvbklkKTsKICAgICAgSmFudXMuZGVidWcoanNvbik7CiAgICAgIHZhciBzZW5kZXIgPSBqc29uWyJzZW5kZXIiXTsKCiAgICAgIGlmIChzZW5kZXIgPT09IHVuZGVmaW5lZCB8fCBzZW5kZXIgPT09IG51bGwpIHsKICAgICAgICBKYW51cy53YXJuKCJNaXNzaW5nIHNlbmRlci4uLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHBsdWdpbkhhbmRsZSA9IHBsdWdpbkhhbmRsZXNbc2VuZGVyXTsKCiAgICAgIGlmIChwbHVnaW5IYW5kbGUgPT09IHVuZGVmaW5lZCB8fCBwbHVnaW5IYW5kbGUgPT09IG51bGwpIHsKICAgICAgICBKYW51cy5kZWJ1ZygiVGhpcyBoYW5kbGUgaXMgbm90IGF0dGFjaGVkIHRvIHRoaXMgc2Vzc2lvbiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcGx1Z2luSGFuZGxlLndlYnJ0Y1N0YXRlKGZhbHNlLCBqc29uWyJyZWFzb24iXSk7CiAgICAgIHBsdWdpbkhhbmRsZS5oYW5ndXAoKTsKICAgIH0gZWxzZSBpZiAoanNvblsiamFudXMiXSA9PT0gImRldGFjaGVkIikgewogICAgICAvLyBBIHBsdWdpbiBhc2tlZCB0aGUgY29yZSB0byBkZXRhY2ggb25lIG9mIG91ciBoYW5kbGVzCiAgICAgIEphbnVzLmRlYnVnKCJHb3QgYSBkZXRhY2hlZCBldmVudCBvbiBzZXNzaW9uICIgKyBzZXNzaW9uSWQpOwogICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKICAgICAgdmFyIHNlbmRlciA9IGpzb25bInNlbmRlciJdOwoKICAgICAgaWYgKHNlbmRlciA9PT0gdW5kZWZpbmVkIHx8IHNlbmRlciA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLndhcm4oIk1pc3Npbmcgc2VuZGVyLi4uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGx1Z2luSGFuZGxlID0gcGx1Z2luSGFuZGxlc1tzZW5kZXJdOwoKICAgICAgaWYgKHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgIC8vIERvbid0IHdhcm4gaGVyZSBiZWNhdXNlIGRlc3Ryb3lIYW5kbGUgY2F1c2VzIHRoaXMgc2l0dWF0aW9uLgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcGx1Z2luSGFuZGxlLmRldGFjaGVkID0gdHJ1ZTsKICAgICAgcGx1Z2luSGFuZGxlLm9uZGV0YWNoZWQoKTsKICAgICAgcGx1Z2luSGFuZGxlLmRldGFjaCgpOwogICAgfSBlbHNlIGlmIChqc29uWyJqYW51cyJdID09PSAibWVkaWEiKSB7CiAgICAgIC8vIE1lZGlhIHN0YXJ0ZWQvc3RvcHBlZCBmbG93aW5nCiAgICAgIEphbnVzLmRlYnVnKCJHb3QgYSBtZWRpYSBldmVudCBvbiBzZXNzaW9uICIgKyBzZXNzaW9uSWQpOwogICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKICAgICAgdmFyIHNlbmRlciA9IGpzb25bInNlbmRlciJdOwoKICAgICAgaWYgKHNlbmRlciA9PT0gdW5kZWZpbmVkIHx8IHNlbmRlciA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLndhcm4oIk1pc3Npbmcgc2VuZGVyLi4uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGx1Z2luSGFuZGxlID0gcGx1Z2luSGFuZGxlc1tzZW5kZXJdOwoKICAgICAgaWYgKHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLmRlYnVnKCJUaGlzIGhhbmRsZSBpcyBub3QgYXR0YWNoZWQgdG8gdGhpcyBzZXNzaW9uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBwbHVnaW5IYW5kbGUubWVkaWFTdGF0ZShqc29uWyJ0eXBlIl0sIGpzb25bInJlY2VpdmluZyJdKTsKICAgIH0gZWxzZSBpZiAoanNvblsiamFudXMiXSA9PT0gInNsb3dsaW5rIikgewogICAgICBKYW51cy5kZWJ1ZygiR290IGEgc2xvd2xpbmsgZXZlbnQgb24gc2Vzc2lvbiAiICsgc2Vzc2lvbklkKTsKICAgICAgSmFudXMuZGVidWcoanNvbik7IC8vIFRyb3VibGUgdXBsaW5rIG9yIGRvd25saW5rCgogICAgICB2YXIgc2VuZGVyID0ganNvblsic2VuZGVyIl07CgogICAgICBpZiAoc2VuZGVyID09PSB1bmRlZmluZWQgfHwgc2VuZGVyID09PSBudWxsKSB7CiAgICAgICAgSmFudXMud2FybigiTWlzc2luZyBzZW5kZXIuLi4iKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW3NlbmRlcl07CgogICAgICBpZiAocGx1Z2luSGFuZGxlID09PSB1bmRlZmluZWQgfHwgcGx1Z2luSGFuZGxlID09PSBudWxsKSB7CiAgICAgICAgSmFudXMuZGVidWcoIlRoaXMgaGFuZGxlIGlzIG5vdCBhdHRhY2hlZCB0byB0aGlzIHNlc3Npb24iKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHBsdWdpbkhhbmRsZS5zbG93TGluayhqc29uWyJ1cGxpbmsiXSwganNvblsibmFja3MiXSk7CiAgICB9IGVsc2UgaWYgKGpzb25bImphbnVzIl0gPT09ICJlcnJvciIpIHsKICAgICAgLy8gT29wcywgc29tZXRoaW5nIHdyb25nIGhhcHBlbmVkCiAgICAgIEphbnVzLmVycm9yKCJPb29wczogIiArIGpzb25bImVycm9yIl0uY29kZSArICIgIiArIGpzb25bImVycm9yIl0ucmVhc29uKTsgLy8gRklYTUUKCiAgICAgIEphbnVzLmRlYnVnKGpzb24pOwogICAgICB2YXIgdHJhbnNhY3Rpb24gPSBqc29uWyJ0cmFuc2FjdGlvbiJdOwoKICAgICAgaWYgKHRyYW5zYWN0aW9uICE9PSBudWxsICYmIHRyYW5zYWN0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgcmVwb3J0U3VjY2VzcyA9IHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbl07CgogICAgICAgIGlmIChyZXBvcnRTdWNjZXNzICE9PSBudWxsICYmIHJlcG9ydFN1Y2Nlc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmVwb3J0U3VjY2Vzcyhqc29uKTsKICAgICAgICB9CgogICAgICAgIGRlbGV0ZSB0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25dOwogICAgICB9CgogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGpzb25bImphbnVzIl0gPT09ICJldmVudCIpIHsKICAgICAgSmFudXMuZGVidWcoIkdvdCBhIHBsdWdpbiBldmVudCBvbiBzZXNzaW9uICIgKyBzZXNzaW9uSWQpOwogICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKICAgICAgdmFyIHNlbmRlciA9IGpzb25bInNlbmRlciJdOwoKICAgICAgaWYgKHNlbmRlciA9PT0gdW5kZWZpbmVkIHx8IHNlbmRlciA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLndhcm4oIk1pc3Npbmcgc2VuZGVyLi4uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGx1Z2luZGF0YSA9IGpzb25bInBsdWdpbmRhdGEiXTsKCiAgICAgIGlmIChwbHVnaW5kYXRhID09PSB1bmRlZmluZWQgfHwgcGx1Z2luZGF0YSA9PT0gbnVsbCkgewogICAgICAgIEphbnVzLndhcm4oIk1pc3NpbmcgcGx1Z2luZGF0YS4uLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgSmFudXMuZGVidWcoIiAgLS0gRXZlbnQgaXMgY29taW5nIGZyb20gIiArIHNlbmRlciArICIgKCIgKyBwbHVnaW5kYXRhWyJwbHVnaW4iXSArICIpIik7CiAgICAgIHZhciBkYXRhID0gcGx1Z2luZGF0YVsiZGF0YSJdOwogICAgICBKYW51cy5kZWJ1ZyhkYXRhKTsKICAgICAgdmFyIHBsdWdpbkhhbmRsZSA9IHBsdWdpbkhhbmRsZXNbc2VuZGVyXTsKCiAgICAgIGlmIChwbHVnaW5IYW5kbGUgPT09IHVuZGVmaW5lZCB8fCBwbHVnaW5IYW5kbGUgPT09IG51bGwpIHsKICAgICAgICBKYW51cy53YXJuKCJUaGlzIGhhbmRsZSBpcyBub3QgYXR0YWNoZWQgdG8gdGhpcyBzZXNzaW9uIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIganNlcCA9IGpzb25bImpzZXAiXTsKCiAgICAgIGlmIChqc2VwICE9PSB1bmRlZmluZWQgJiYganNlcCAhPT0gbnVsbCkgewogICAgICAgIEphbnVzLmRlYnVnKCJIYW5kbGluZyBTRFAgYXMgd2VsbC4uLiIpOwogICAgICAgIEphbnVzLmRlYnVnKGpzZXApOwogICAgICB9CgogICAgICB2YXIgY2FsbGJhY2sgPSBwbHVnaW5IYW5kbGUub25tZXNzYWdlOwoKICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsICYmIGNhbGxiYWNrICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBKYW51cy5kZWJ1ZygiTm90aWZ5aW5nIGFwcGxpY2F0aW9uLi4uIik7IC8vIFNlbmQgdG8gY2FsbGJhY2sgc3BlY2lmaWVkIHdoZW4gYXR0YWNoaW5nIHBsdWdpbiBoYW5kbGUKCiAgICAgICAgY2FsbGJhY2soZGF0YSwganNlcCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2VuZCB0byBnZW5lcmljIGNhbGxiYWNrICg/KQogICAgICAgIEphbnVzLmRlYnVnKCJObyBwcm92aWRlZCBub3RpZmljYXRpb24gY2FsbGJhY2siKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgSmFudXMud2FybigiVW5rb3duIG1lc3NhZ2UvZXZlbnQgICciICsganNvblsiamFudXMiXSArICInIG9uIHNlc3Npb24gIiArIHNlc3Npb25JZCk7CiAgICAgIEphbnVzLmRlYnVnKGpzb24pOwogICAgfQogIH0gLy8gUHJpdmF0ZSBoZWxwZXIgdG8gc2VuZCBrZWVwLWFsaXZlIG1lc3NhZ2VzIG9uIFdlYlNvY2tldHMKCgogIGZ1bmN0aW9uIGtlZXBBbGl2ZSgpIHsKICAgIGlmIChzZXJ2ZXIgPT09IG51bGwgfHwgIXdlYnNvY2tldHMgfHwgIWNvbm5lY3RlZCkgcmV0dXJuOwogICAgd3NLZWVwYWxpdmVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGtlZXBBbGl2ZSwgMzAwMDApOwogICAgdmFyIHJlcXVlc3QgPSB7CiAgICAgICJqYW51cyI6ICJrZWVwYWxpdmUiLAogICAgICAic2Vzc2lvbl9pZCI6IHNlc3Npb25JZCwKICAgICAgInRyYW5zYWN0aW9uIjogSmFudXMucmFuZG9tU3RyaW5nKDEyKQogICAgfTsKICAgIGlmICh0b2tlbiAhPT0gbnVsbCAmJiB0b2tlbiAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0WyJ0b2tlbiJdID0gdG9rZW47CiAgICBpZiAoYXBpc2VjcmV0ICE9PSBudWxsICYmIGFwaXNlY3JldCAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0WyJhcGlzZWNyZXQiXSA9IGFwaXNlY3JldDsKICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpOwogIH0gLy8gUHJpdmF0ZSBtZXRob2QgdG8gY3JlYXRlIGEgc2Vzc2lvbgoKCiAgZnVuY3Rpb24gY3JlYXRlU2Vzc2lvbihjYWxsYmFja3MpIHsKICAgIHZhciB0cmFuc2FjdGlvbiA9IEphbnVzLnJhbmRvbVN0cmluZygxMik7CiAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgImphbnVzIjogImNyZWF0ZSIsCiAgICAgICJ0cmFuc2FjdGlvbiI6IHRyYW5zYWN0aW9uCiAgICB9OwogICAgaWYgKHRva2VuICE9PSBudWxsICYmIHRva2VuICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbInRva2VuIl0gPSB0b2tlbjsKICAgIGlmIChhcGlzZWNyZXQgIT09IG51bGwgJiYgYXBpc2VjcmV0ICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbImFwaXNlY3JldCJdID0gYXBpc2VjcmV0OwoKICAgIGlmIChzZXJ2ZXIgPT09IG51bGwgJiYgQXJyYXkuaXNBcnJheShzZXJ2ZXJzKSkgewogICAgICAvLyBXZSBzdGlsbCBuZWVkIHRvIGZpbmQgYSB3b3JraW5nIHNlcnZlciBmcm9tIHRoZSBsaXN0IHdlIHdlcmUgZ2l2ZW4KICAgICAgc2VydmVyID0gc2VydmVyc1tzZXJ2ZXJzSW5kZXhdOwoKICAgICAgaWYgKHNlcnZlci5pbmRleE9mKCJ3cyIpID09PSAwKSB7CiAgICAgICAgd2Vic29ja2V0cyA9IHRydWU7CiAgICAgICAgSmFudXMubG9nKCJTZXJ2ZXIgIyIgKyAoc2VydmVyc0luZGV4ICsgMSkgKyAiOiB0cnlpbmcgV2ViU29ja2V0cyB0byBjb250YWN0IEphbnVzICgiICsgc2VydmVyICsgIikiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3ZWJzb2NrZXRzID0gZmFsc2U7CiAgICAgICAgSmFudXMubG9nKCJTZXJ2ZXIgIyIgKyAoc2VydmVyc0luZGV4ICsgMSkgKyAiOiB0cnlpbmcgUkVTVCBBUEkgdG8gY29udGFjdCBKYW51cyAoIiArIHNlcnZlciArICIpIik7CiAgICAgIH0KICAgIH0KCiAgICBpZiAod2Vic29ja2V0cykgewogICAgICB3cyA9IG5ldyBXZWJTb2NrZXQoc2VydmVyLCAnamFudXMtcHJvdG9jb2wnKTsKICAgICAgd3NIYW5kbGVycyA9IHsKICAgICAgICAnZXJyb3InOiBmdW5jdGlvbiBlcnJvcigpIHsKICAgICAgICAgIEphbnVzLmVycm9yKCJFcnJvciBjb25uZWN0aW5nIHRvIHRoZSBKYW51cyBXZWJTb2NrZXRzIHNlcnZlci4uLiAiICsgc2VydmVyKTsKCiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZXJ2ZXJzKSkgewogICAgICAgICAgICBzZXJ2ZXJzSW5kZXgrKzsKCiAgICAgICAgICAgIGlmIChzZXJ2ZXJzSW5kZXggPT0gc2VydmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBXZSB0cmllZCBhbGwgdGhlIHNlcnZlcnMgdGhlIHVzZXIgZ2F2ZSB1cyBhbmQgdGhleSBhbGwgZmFpbGVkCiAgICAgICAgICAgICAgY2FsbGJhY2tzLmVycm9yKCJFcnJvciBjb25uZWN0aW5nIHRvIGFueSBvZiB0aGUgcHJvdmlkZWQgSmFudXMgc2VydmVyczogSXMgdGhlIGdhdGV3YXkgZG93bj8iKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gLy8gTGV0J3MgdHJ5IHRoZSBuZXh0IHNlcnZlcgoKCiAgICAgICAgICAgIHNlcnZlciA9IG51bGw7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNyZWF0ZVNlc3Npb24oY2FsbGJhY2tzKTsKICAgICAgICAgICAgfSwgMjAwKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcigiRXJyb3IgY29ubmVjdGluZyB0byB0aGUgSmFudXMgV2ViU29ja2V0cyBzZXJ2ZXI6IElzIHRoZSBnYXRld2F5IGRvd24/Iik7CiAgICAgICAgfSwKICAgICAgICAnb3Blbic6IGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICAvLyBXZSBuZWVkIHRvIGJlIG5vdGlmaWVkIGFib3V0IHRoZSBzdWNjZXNzCiAgICAgICAgICB0cmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25dID0gZnVuY3Rpb24gKGpzb24pIHsKICAgICAgICAgICAgSmFudXMuZGVidWcoanNvbik7CgogICAgICAgICAgICBpZiAoanNvblsiamFudXMiXSAhPT0gInN1Y2Nlc3MiKSB7CiAgICAgICAgICAgICAgSmFudXMuZXJyb3IoIk9vb3BzOiAiICsganNvblsiZXJyb3IiXS5jb2RlICsgIiAiICsganNvblsiZXJyb3IiXS5yZWFzb24pOyAvLyBGSVhNRQoKICAgICAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoanNvblsiZXJyb3IiXS5yZWFzb24pOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgd3NLZWVwYWxpdmVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGtlZXBBbGl2ZSwgMzAwMDApOwogICAgICAgICAgICBjb25uZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICBzZXNzaW9uSWQgPSBqc29uLmRhdGFbImlkIl07CiAgICAgICAgICAgIEphbnVzLmxvZygiQ3JlYXRlZCBzZXNzaW9uOiAiICsgc2Vzc2lvbklkKTsKICAgICAgICAgICAgSmFudXMuc2Vzc2lvbnNbc2Vzc2lvbklkXSA9IHRoYXQ7CiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpOwogICAgICAgIH0sCiAgICAgICAgJ21lc3NhZ2UnOiBmdW5jdGlvbiBtZXNzYWdlKGV2ZW50KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBoYW5kbGVFdmVudChKU09OLnBhcnNlKGV2ZW50LmRhdGEpKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgSmFudXMuZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgZXZlbnQ6JywgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAnY2xvc2UnOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgICAgIGlmIChzZXJ2ZXIgPT09IG51bGwgfHwgIWNvbm5lY3RlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgY29ubmVjdGVkID0gZmFsc2U7IC8vIEZJWE1FIFdoYXQgaWYgdGhpcyBpcyBjYWxsZWQgd2hlbiB0aGUgcGFnZSBpcyBjbG9zZWQ/CgogICAgICAgICAgZ2F0ZXdheUNhbGxiYWNrcy5lcnJvcigiTG9zdCBjb25uZWN0aW9uIHRvIHRoZSBnYXRld2F5IChpcyBpdCBkb3duPykiKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBmb3IgKHZhciBldmVudE5hbWUgaW4gd3NIYW5kbGVycykgewogICAgICAgIHdzLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCB3c0hhbmRsZXJzW2V2ZW50TmFtZV0pOwogICAgICB9CgogICAgICByZXR1cm47CiAgICB9CgogICAgSmFudXMuYWpheCh7CiAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgdXJsOiBzZXJ2ZXIsCiAgICAgIHdpdGhDcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzLAogICAgICBjYWNoZTogZmFsc2UsCiAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpLAogICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKGpzb24pIHsKICAgICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKCiAgICAgICAgaWYgKGpzb25bImphbnVzIl0gIT09ICJzdWNjZXNzIikgewogICAgICAgICAgSmFudXMuZXJyb3IoIk9vb3BzOiAiICsganNvblsiZXJyb3IiXS5jb2RlICsgIiAiICsganNvblsiZXJyb3IiXS5yZWFzb24pOyAvLyBGSVhNRQoKICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcihqc29uWyJlcnJvciJdLnJlYXNvbik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25uZWN0ZWQgPSB0cnVlOwogICAgICAgIHNlc3Npb25JZCA9IGpzb24uZGF0YVsiaWQiXTsKICAgICAgICBKYW51cy5sb2coIkNyZWF0ZWQgc2Vzc2lvbjogIiArIHNlc3Npb25JZCk7CiAgICAgICAgSmFudXMuc2Vzc2lvbnNbc2Vzc2lvbklkXSA9IHRoYXQ7CiAgICAgICAgZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgICAgfSwKICAgICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKFhNTEh0dHBSZXF1ZXN0LCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgewogICAgICAgIEphbnVzLmVycm9yKHRleHRTdGF0dXMgKyAiOiAiICsgZXJyb3JUaHJvd24pOyAvLyBGSVhNRQoKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZXJ2ZXJzKSkgewogICAgICAgICAgc2VydmVyc0luZGV4Kys7CgogICAgICAgICAgaWYgKHNlcnZlcnNJbmRleCA9PSBzZXJ2ZXJzLmxlbmd0aCkgewogICAgICAgICAgICAvLyBXZSB0cmllZCBhbGwgdGhlIHNlcnZlcnMgdGhlIHVzZXIgZ2F2ZSB1cyBhbmQgdGhleSBhbGwgZmFpbGVkCiAgICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcigiRXJyb3IgY29ubmVjdGluZyB0byBhbnkgb2YgdGhlIHByb3ZpZGVkIEphbnVzIHNlcnZlcnM6IElzIHRoZSBnYXRld2F5IGRvd24/Iik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gLy8gTGV0J3MgdHJ5IHRoZSBuZXh0IHNlcnZlcgoKCiAgICAgICAgICBzZXJ2ZXIgPSBudWxsOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNyZWF0ZVNlc3Npb24oY2FsbGJhY2tzKTsKICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZXJyb3JUaHJvd24gPT09ICIiKSBjYWxsYmFja3MuZXJyb3IodGV4dFN0YXR1cyArICI6IElzIHRoZSBnYXRld2F5IGRvd24/Iik7ZWxzZSBjYWxsYmFja3MuZXJyb3IodGV4dFN0YXR1cyArICI6ICIgKyBlcnJvclRocm93bik7CiAgICAgIH0sCiAgICAgIGRhdGFUeXBlOiAianNvbiIKICAgIH0pOwogIH0gLy8gUHJpdmF0ZSBtZXRob2QgdG8gZGVzdHJveSBhIHNlc3Npb24KCgogIGZ1bmN0aW9uIGRlc3Ryb3lTZXNzaW9uKGNhbGxiYWNrcykgewogICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzIHx8IHt9OyAvLyBGSVhNRSBUaGlzIG1ldGhvZCB0cmlnZ2VycyBhIHN1Y2Nlc3MgZXZlbiB3aGVuIHdlIGZhaWwKCiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgdmFyIGFzeW5jUmVxdWVzdCA9IHRydWU7CiAgICBpZiAoY2FsbGJhY2tzLmFzeW5jUmVxdWVzdCAhPT0gdW5kZWZpbmVkICYmIGNhbGxiYWNrcy5hc3luY1JlcXVlc3QgIT09IG51bGwpIGFzeW5jUmVxdWVzdCA9IGNhbGxiYWNrcy5hc3luY1JlcXVlc3QgPT09IHRydWU7CiAgICBKYW51cy5sb2coIkRlc3Ryb3lpbmcgc2Vzc2lvbiAiICsgc2Vzc2lvbklkICsgIiAoYXN5bmM9IiArIGFzeW5jUmVxdWVzdCArICIpIik7CgogICAgaWYgKCFjb25uZWN0ZWQpIHsKICAgICAgSmFudXMud2FybigiSXMgdGhlIGdhdGV3YXkgZG93bj8gKGNvbm5lY3RlZD1mYWxzZSkiKTsKICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChzZXNzaW9uSWQgPT09IHVuZGVmaW5lZCB8fCBzZXNzaW9uSWQgPT09IG51bGwpIHsKICAgICAgSmFudXMud2FybigiTm8gc2Vzc2lvbiB0byBkZXN0cm95Iik7CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgIGdhdGV3YXlDYWxsYmFja3MuZGVzdHJveWVkKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBkZWxldGUgSmFudXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTsgLy8gTm8gbmVlZCB0byBkZXN0cm95IGFsbCBoYW5kbGVzIGZpcnN0LCBKYW51cyB3aWxsIGRvIHRoYXQgaXRzZWxmCgogICAgdmFyIHJlcXVlc3QgPSB7CiAgICAgICJqYW51cyI6ICJkZXN0cm95IiwKICAgICAgInRyYW5zYWN0aW9uIjogSmFudXMucmFuZG9tU3RyaW5nKDEyKQogICAgfTsKICAgIGlmICh0b2tlbiAhPT0gbnVsbCAmJiB0b2tlbiAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0WyJ0b2tlbiJdID0gdG9rZW47CiAgICBpZiAoYXBpc2VjcmV0ICE9PSBudWxsICYmIGFwaXNlY3JldCAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0WyJhcGlzZWNyZXQiXSA9IGFwaXNlY3JldDsKCiAgICBpZiAod2Vic29ja2V0cykgewogICAgICByZXF1ZXN0WyJzZXNzaW9uX2lkIl0gPSBzZXNzaW9uSWQ7CgogICAgICB2YXIgdW5iaW5kV2ViU29ja2V0ID0gZnVuY3Rpb24gdW5iaW5kV2ViU29ja2V0KCkgewogICAgICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiB3c0hhbmRsZXJzKSB7CiAgICAgICAgICB3cy5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgd3NIYW5kbGVyc1tldmVudE5hbWVdKTsKICAgICAgICB9CgogICAgICAgIHdzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBvblVuYmluZE1lc3NhZ2UpOwogICAgICAgIHdzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25VbmJpbmRFcnJvcik7CgogICAgICAgIGlmICh3c0tlZXBhbGl2ZVRpbWVvdXRJZCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHdzS2VlcGFsaXZlVGltZW91dElkKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgb25VbmJpbmRNZXNzYWdlID0gZnVuY3Rpb24gb25VbmJpbmRNZXNzYWdlKGV2ZW50KSB7CiAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpOwoKICAgICAgICBpZiAoZGF0YS5zZXNzaW9uX2lkID09IHJlcXVlc3Quc2Vzc2lvbl9pZCAmJiBkYXRhLnRyYW5zYWN0aW9uID09IHJlcXVlc3QudHJhbnNhY3Rpb24pIHsKICAgICAgICAgIHVuYmluZFdlYlNvY2tldCgpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgICAgICAgIGdhdGV3YXlDYWxsYmFja3MuZGVzdHJveWVkKCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIG9uVW5iaW5kRXJyb3IgPSBmdW5jdGlvbiBvblVuYmluZEVycm9yKGV2ZW50KSB7CiAgICAgICAgdW5iaW5kV2ViU29ja2V0KCk7CiAgICAgICAgY2FsbGJhY2tzLmVycm9yKCJGYWlsZWQgdG8gZGVzdHJveSB0aGUgZ2F0ZXdheTogSXMgdGhlIGdhdGV3YXkgZG93bj8iKTsKICAgICAgICBnYXRld2F5Q2FsbGJhY2tzLmRlc3Ryb3llZCgpOwogICAgICB9OwoKICAgICAgd3MuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uVW5iaW5kTWVzc2FnZSk7CiAgICAgIHdzLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25VbmJpbmRFcnJvcik7CiAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpOwogICAgICByZXR1cm47CiAgICB9CgogICAgSmFudXMuYWpheCh7CiAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgdXJsOiBzZXJ2ZXIgKyAiLyIgKyBzZXNzaW9uSWQsCiAgICAgIGFzeW5jOiBhc3luY1JlcXVlc3QsCiAgICAgIC8vIFNvbWV0aW1lcyB3ZSBuZWVkIGZhbHNlIGhlcmUsIG9yIGRlc3Ryb3lpbmcgaW4gb25iZWZvcmV1bmxvYWQgd29uJ3Qgd29yawogICAgICB3aXRoQ3JlZGVudGlhbHM6IHdpdGhDcmVkZW50aWFscywKICAgICAgY2FjaGU6IGZhbHNlLAogICAgICBjb250ZW50VHlwZTogImFwcGxpY2F0aW9uL2pzb24iLAogICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0KSwKICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2Vzcyhqc29uKSB7CiAgICAgICAgSmFudXMubG9nKCJEZXN0cm95ZWQgc2Vzc2lvbjoiKTsKICAgICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKICAgICAgICBzZXNzaW9uSWQgPSBudWxsOwogICAgICAgIGNvbm5lY3RlZCA9IGZhbHNlOwoKICAgICAgICBpZiAoanNvblsiamFudXMiXSAhPT0gInN1Y2Nlc3MiKSB7CiAgICAgICAgICBKYW51cy5lcnJvcigiT29vcHM6ICIgKyBqc29uWyJlcnJvciJdLmNvZGUgKyAiICIgKyBqc29uWyJlcnJvciJdLnJlYXNvbik7IC8vIEZJWE1FCiAgICAgICAgfQoKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgICAgIGdhdGV3YXlDYWxsYmFja3MuZGVzdHJveWVkKCk7CiAgICAgIH0sCiAgICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihYTUxIdHRwUmVxdWVzdCwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHsKICAgICAgICBKYW51cy5lcnJvcih0ZXh0U3RhdHVzICsgIjogIiArIGVycm9yVGhyb3duKTsgLy8gRklYTUUKICAgICAgICAvLyBSZXNldCBldmVyeXRoaW5nIGFueXdheQoKICAgICAgICBzZXNzaW9uSWQgPSBudWxsOwogICAgICAgIGNvbm5lY3RlZCA9IGZhbHNlOwogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgICAgZ2F0ZXdheUNhbGxiYWNrcy5kZXN0cm95ZWQoKTsKICAgICAgfSwKICAgICAgZGF0YVR5cGU6ICJqc29uIgogICAgfSk7CiAgfSAvLyBQcml2YXRlIG1ldGhvZCB0byBjcmVhdGUgYSBwbHVnaW4gaGFuZGxlCgoKICBmdW5jdGlvbiBjcmVhdGVIYW5kbGUoY2FsbGJhY2tzKSB7CiAgICBjYWxsYmFja3MgPSBjYWxsYmFja3MgfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLmVycm9yID0gdHlwZW9mIGNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLmVycm9yIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy5jb25zZW50RGlhbG9nID0gdHlwZW9mIGNhbGxiYWNrcy5jb25zZW50RGlhbG9nID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3MuY29uc2VudERpYWxvZyA6IEphbnVzLm5vb3A7CiAgICBjYWxsYmFja3MuaWNlU3RhdGUgPSB0eXBlb2YgY2FsbGJhY2tzLmljZVN0YXRlID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3MuaWNlU3RhdGUgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLm1lZGlhU3RhdGUgPSB0eXBlb2YgY2FsbGJhY2tzLm1lZGlhU3RhdGUgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5tZWRpYVN0YXRlIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy53ZWJydGNTdGF0ZSA9IHR5cGVvZiBjYWxsYmFja3Mud2VicnRjU3RhdGUgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy53ZWJydGNTdGF0ZSA6IEphbnVzLm5vb3A7CiAgICBjYWxsYmFja3Muc2xvd0xpbmsgPSB0eXBlb2YgY2FsbGJhY2tzLnNsb3dMaW5rID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Muc2xvd0xpbmsgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLm9ubWVzc2FnZSA9IHR5cGVvZiBjYWxsYmFja3Mub25tZXNzYWdlID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Mub25tZXNzYWdlIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy5vbmxvY2Fsc3RyZWFtID0gdHlwZW9mIGNhbGxiYWNrcy5vbmxvY2Fsc3RyZWFtID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Mub25sb2NhbHN0cmVhbSA6IEphbnVzLm5vb3A7CiAgICBjYWxsYmFja3Mub25yZW1vdGVzdHJlYW0gPSB0eXBlb2YgY2FsbGJhY2tzLm9ucmVtb3Rlc3RyZWFtID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Mub25yZW1vdGVzdHJlYW0gOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLm9uZGF0YSA9IHR5cGVvZiBjYWxsYmFja3Mub25kYXRhID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Mub25kYXRhIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy5vbmRhdGFvcGVuID0gdHlwZW9mIGNhbGxiYWNrcy5vbmRhdGFvcGVuID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Mub25kYXRhb3BlbiA6IEphbnVzLm5vb3A7CiAgICBjYWxsYmFja3Mub25jbGVhbnVwID0gdHlwZW9mIGNhbGxiYWNrcy5vbmNsZWFudXAgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5vbmNsZWFudXAgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLm9uZGV0YWNoZWQgPSB0eXBlb2YgY2FsbGJhY2tzLm9uZGV0YWNoZWQgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5vbmRldGFjaGVkIDogSmFudXMubm9vcDsKCiAgICBpZiAoIWNvbm5lY3RlZCkgewogICAgICBKYW51cy53YXJuKCJJcyB0aGUgZ2F0ZXdheSBkb3duPyAoY29ubmVjdGVkPWZhbHNlKSIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIklzIHRoZSBnYXRld2F5IGRvd24/IChjb25uZWN0ZWQ9ZmFsc2UpIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgcGx1Z2luID0gY2FsbGJhY2tzLnBsdWdpbjsKCiAgICBpZiAocGx1Z2luID09PSB1bmRlZmluZWQgfHwgcGx1Z2luID09PSBudWxsKSB7CiAgICAgIEphbnVzLmVycm9yKCJJbnZhbGlkIHBsdWdpbiIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIkludmFsaWQgcGx1Z2luIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgb3BhcXVlSWQgPSBjYWxsYmFja3Mub3BhcXVlSWQ7CiAgICB2YXIgdHJhbnNhY3Rpb24gPSBKYW51cy5yYW5kb21TdHJpbmcoMTIpOwogICAgdmFyIHJlcXVlc3QgPSB7CiAgICAgICJqYW51cyI6ICJhdHRhY2giLAogICAgICAicGx1Z2luIjogcGx1Z2luLAogICAgICAib3BhcXVlX2lkIjogb3BhcXVlSWQsCiAgICAgICJ0cmFuc2FjdGlvbiI6IHRyYW5zYWN0aW9uCiAgICB9OwogICAgaWYgKHRva2VuICE9PSBudWxsICYmIHRva2VuICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbInRva2VuIl0gPSB0b2tlbjsKICAgIGlmIChhcGlzZWNyZXQgIT09IG51bGwgJiYgYXBpc2VjcmV0ICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbImFwaXNlY3JldCJdID0gYXBpc2VjcmV0OyAvLyBJZiB3ZSBrbm93IHRoZSBicm93c2VyIHN1cHBvcnRzIEJVTkRMRSBhbmQvb3IgcnRjcC1tdXgsIGxldCdzIGFkdmVydGlzZSB0aG9zZSByaWdodCBhd2F5CgogICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PSAiY2hyb21lIiB8fCBhZGFwdGVyLmJyb3dzZXJEZXRhaWxzLmJyb3dzZXIgPT0gImZpcmVmb3giKSB7CiAgICAgIHJlcXVlc3RbImZvcmNlLWJ1bmRsZSJdID0gdHJ1ZTsKICAgICAgcmVxdWVzdFsiZm9yY2UtcnRjcC1tdXgiXSA9IHRydWU7CiAgICB9CgogICAgaWYgKHdlYnNvY2tldHMpIHsKICAgICAgdHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uXSA9IGZ1bmN0aW9uIChqc29uKSB7CiAgICAgICAgSmFudXMuZGVidWcoanNvbik7CgogICAgICAgIGlmIChqc29uWyJqYW51cyJdICE9PSAic3VjY2VzcyIpIHsKICAgICAgICAgIEphbnVzLmVycm9yKCJPb29wczogIiArIGpzb25bImVycm9yIl0uY29kZSArICIgIiArIGpzb25bImVycm9yIl0ucmVhc29uKTsgLy8gRklYTUUKCiAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoIk9vb3BzOiAiICsganNvblsiZXJyb3IiXS5jb2RlICsgIiAiICsganNvblsiZXJyb3IiXS5yZWFzb24pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGhhbmRsZUlkID0ganNvbi5kYXRhWyJpZCJdOwogICAgICAgIEphbnVzLmxvZygiQ3JlYXRlZCBoYW5kbGU6ICIgKyBoYW5kbGVJZCk7CiAgICAgICAgdmFyIHBsdWdpbkhhbmRsZSA9IHsKICAgICAgICAgIHNlc3Npb246IHRoYXQsCiAgICAgICAgICBwbHVnaW46IHBsdWdpbiwKICAgICAgICAgIGlkOiBoYW5kbGVJZCwKICAgICAgICAgIGRldGFjaGVkOiBmYWxzZSwKICAgICAgICAgIHdlYnJ0Y1N0dWZmOiB7CiAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICBteVN0cmVhbTogbnVsbCwKICAgICAgICAgICAgc3RyZWFtRXh0ZXJuYWw6IGZhbHNlLAogICAgICAgICAgICByZW1vdGVTdHJlYW06IG51bGwsCiAgICAgICAgICAgIG15U2RwOiBudWxsLAogICAgICAgICAgICBwYzogbnVsbCwKICAgICAgICAgICAgZGF0YUNoYW5uZWw6IG51bGwsCiAgICAgICAgICAgIGR0bWZTZW5kZXI6IG51bGwsCiAgICAgICAgICAgIHRyaWNrbGU6IHRydWUsCiAgICAgICAgICAgIGljZURvbmU6IGZhbHNlLAogICAgICAgICAgICBzZHBTZW50OiBmYWxzZSwKICAgICAgICAgICAgdm9sdW1lOiB7CiAgICAgICAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgICAgICAgdGltZXI6IG51bGwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYml0cmF0ZTogewogICAgICAgICAgICAgIHZhbHVlOiBudWxsLAogICAgICAgICAgICAgIGJzbm93OiBudWxsLAogICAgICAgICAgICAgIGJzYmVmb3JlOiBudWxsLAogICAgICAgICAgICAgIHRzbm93OiBudWxsLAogICAgICAgICAgICAgIHRzYmVmb3JlOiBudWxsLAogICAgICAgICAgICAgIHRpbWVyOiBudWxsCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBnZXRJZDogZnVuY3Rpb24gZ2V0SWQoKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVJZDsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXRQbHVnaW46IGZ1bmN0aW9uIGdldFBsdWdpbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBsdWdpbjsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXRWb2x1bWU6IGZ1bmN0aW9uIGdldFZvbHVtZSgpIHsKICAgICAgICAgICAgcmV0dXJuIF9nZXRWb2x1bWUoaGFuZGxlSWQpOwogICAgICAgICAgfSwKICAgICAgICAgIGlzQXVkaW9NdXRlZDogZnVuY3Rpb24gaXNBdWRpb011dGVkKCkgewogICAgICAgICAgICByZXR1cm4gaXNNdXRlZChoYW5kbGVJZCwgZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIG11dGVBdWRpbzogZnVuY3Rpb24gbXV0ZUF1ZGlvKCkgewogICAgICAgICAgICByZXR1cm4gbXV0ZShoYW5kbGVJZCwgZmFsc2UsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHVubXV0ZUF1ZGlvOiBmdW5jdGlvbiB1bm11dGVBdWRpbygpIHsKICAgICAgICAgICAgcmV0dXJuIG11dGUoaGFuZGxlSWQsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICB9LAogICAgICAgICAgaXNWaWRlb011dGVkOiBmdW5jdGlvbiBpc1ZpZGVvTXV0ZWQoKSB7CiAgICAgICAgICAgIHJldHVybiBpc011dGVkKGhhbmRsZUlkLCB0cnVlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBtdXRlVmlkZW86IGZ1bmN0aW9uIG11dGVWaWRlbygpIHsKICAgICAgICAgICAgcmV0dXJuIG11dGUoaGFuZGxlSWQsIHRydWUsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHVubXV0ZVZpZGVvOiBmdW5jdGlvbiB1bm11dGVWaWRlbygpIHsKICAgICAgICAgICAgcmV0dXJuIG11dGUoaGFuZGxlSWQsIHRydWUsIGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXRCaXRyYXRlOiBmdW5jdGlvbiBnZXRCaXRyYXRlKCkgewogICAgICAgICAgICByZXR1cm4gX2dldEJpdHJhdGUoaGFuZGxlSWQpOwogICAgICAgICAgfSwKICAgICAgICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHNlbmRNZXNzYWdlKGhhbmRsZUlkLCBjYWxsYmFja3MpOwogICAgICAgICAgfSwKICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIGRhdGEoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHNlbmREYXRhKGhhbmRsZUlkLCBjYWxsYmFja3MpOwogICAgICAgICAgfSwKICAgICAgICAgIGR0bWY6IGZ1bmN0aW9uIGR0bWYoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHNlbmREdG1mKGhhbmRsZUlkLCBjYWxsYmFja3MpOwogICAgICAgICAgfSwKICAgICAgICAgIGNvbnNlbnREaWFsb2c6IGNhbGxiYWNrcy5jb25zZW50RGlhbG9nLAogICAgICAgICAgaWNlU3RhdGU6IGNhbGxiYWNrcy5pY2VTdGF0ZSwKICAgICAgICAgIG1lZGlhU3RhdGU6IGNhbGxiYWNrcy5tZWRpYVN0YXRlLAogICAgICAgICAgd2VicnRjU3RhdGU6IGNhbGxiYWNrcy53ZWJydGNTdGF0ZSwKICAgICAgICAgIHNsb3dMaW5rOiBjYWxsYmFja3Muc2xvd0xpbmssCiAgICAgICAgICBvbm1lc3NhZ2U6IGNhbGxiYWNrcy5vbm1lc3NhZ2UsCiAgICAgICAgICBjcmVhdGVPZmZlcjogZnVuY3Rpb24gY3JlYXRlT2ZmZXIoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHByZXBhcmVXZWJydGMoaGFuZGxlSWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LAogICAgICAgICAgY3JlYXRlQW5zd2VyOiBmdW5jdGlvbiBjcmVhdGVBbnN3ZXIoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgIHByZXBhcmVXZWJydGMoaGFuZGxlSWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LAogICAgICAgICAgaGFuZGxlUmVtb3RlSnNlcDogZnVuY3Rpb24gaGFuZGxlUmVtb3RlSnNlcChjYWxsYmFja3MpIHsKICAgICAgICAgICAgcHJlcGFyZVdlYnJ0Y1BlZXIoaGFuZGxlSWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LAogICAgICAgICAgb25sb2NhbHN0cmVhbTogY2FsbGJhY2tzLm9ubG9jYWxzdHJlYW0sCiAgICAgICAgICBvbnJlbW90ZXN0cmVhbTogY2FsbGJhY2tzLm9ucmVtb3Rlc3RyZWFtLAogICAgICAgICAgb25kYXRhOiBjYWxsYmFja3Mub25kYXRhLAogICAgICAgICAgb25kYXRhb3BlbjogY2FsbGJhY2tzLm9uZGF0YW9wZW4sCiAgICAgICAgICBvbmNsZWFudXA6IGNhbGxiYWNrcy5vbmNsZWFudXAsCiAgICAgICAgICBvbmRldGFjaGVkOiBjYWxsYmFja3Mub25kZXRhY2hlZCwKICAgICAgICAgIGhhbmd1cDogZnVuY3Rpb24gaGFuZ3VwKHNlbmRSZXF1ZXN0KSB7CiAgICAgICAgICAgIGNsZWFudXBXZWJydGMoaGFuZGxlSWQsIHNlbmRSZXF1ZXN0ID09PSB0cnVlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZXRhY2g6IGZ1bmN0aW9uIGRldGFjaChjYWxsYmFja3MpIHsKICAgICAgICAgICAgZGVzdHJveUhhbmRsZShoYW5kbGVJZCwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHBsdWdpbkhhbmRsZXNbaGFuZGxlSWRdID0gcGx1Z2luSGFuZGxlOwogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHBsdWdpbkhhbmRsZSk7CiAgICAgIH07CgogICAgICByZXF1ZXN0WyJzZXNzaW9uX2lkIl0gPSBzZXNzaW9uSWQ7CiAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpOwogICAgICByZXR1cm47CiAgICB9CgogICAgSmFudXMuYWpheCh7CiAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgdXJsOiBzZXJ2ZXIgKyAiLyIgKyBzZXNzaW9uSWQsCiAgICAgIHdpdGhDcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzLAogICAgICBjYWNoZTogZmFsc2UsCiAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpLAogICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKGpzb24pIHsKICAgICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKCiAgICAgICAgaWYgKGpzb25bImphbnVzIl0gIT09ICJzdWNjZXNzIikgewogICAgICAgICAgSmFudXMuZXJyb3IoIk9vb3BzOiAiICsganNvblsiZXJyb3IiXS5jb2RlICsgIiAiICsganNvblsiZXJyb3IiXS5yZWFzb24pOyAvLyBGSVhNRQoKICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcigiT29vcHM6ICIgKyBqc29uWyJlcnJvciJdLmNvZGUgKyAiICIgKyBqc29uWyJlcnJvciJdLnJlYXNvbik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaGFuZGxlSWQgPSBqc29uLmRhdGFbImlkIl07CiAgICAgICAgSmFudXMubG9nKCJDcmVhdGVkIGhhbmRsZTogIiArIGhhbmRsZUlkKTsKICAgICAgICB2YXIgcGx1Z2luSGFuZGxlID0gewogICAgICAgICAgc2Vzc2lvbjogdGhhdCwKICAgICAgICAgIHBsdWdpbjogcGx1Z2luLAogICAgICAgICAgaWQ6IGhhbmRsZUlkLAogICAgICAgICAgZGV0YWNoZWQ6IGZhbHNlLAogICAgICAgICAgd2VicnRjU3R1ZmY6IHsKICAgICAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgIG15U3RyZWFtOiBudWxsLAogICAgICAgICAgICBzdHJlYW1FeHRlcm5hbDogZmFsc2UsCiAgICAgICAgICAgIHJlbW90ZVN0cmVhbTogbnVsbCwKICAgICAgICAgICAgbXlTZHA6IG51bGwsCiAgICAgICAgICAgIHBjOiBudWxsLAogICAgICAgICAgICBkYXRhQ2hhbm5lbDogbnVsbCwKICAgICAgICAgICAgZHRtZlNlbmRlcjogbnVsbCwKICAgICAgICAgICAgdHJpY2tsZTogdHJ1ZSwKICAgICAgICAgICAgaWNlRG9uZTogZmFsc2UsCiAgICAgICAgICAgIHNkcFNlbnQ6IGZhbHNlLAogICAgICAgICAgICB2b2x1bWU6IHsKICAgICAgICAgICAgICB2YWx1ZTogbnVsbCwKICAgICAgICAgICAgICB0aW1lcjogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICBiaXRyYXRlOiB7CiAgICAgICAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgICAgICAgYnNub3c6IG51bGwsCiAgICAgICAgICAgICAgYnNiZWZvcmU6IG51bGwsCiAgICAgICAgICAgICAgdHNub3c6IG51bGwsCiAgICAgICAgICAgICAgdHNiZWZvcmU6IG51bGwsCiAgICAgICAgICAgICAgdGltZXI6IG51bGwKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZCgpIHsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUlkOwogICAgICAgICAgfSwKICAgICAgICAgIGdldFBsdWdpbjogZnVuY3Rpb24gZ2V0UGx1Z2luKCkgewogICAgICAgICAgICByZXR1cm4gcGx1Z2luOwogICAgICAgICAgfSwKICAgICAgICAgIGdldFZvbHVtZTogZnVuY3Rpb24gZ2V0Vm9sdW1lKCkgewogICAgICAgICAgICByZXR1cm4gX2dldFZvbHVtZShoYW5kbGVJZCk7CiAgICAgICAgICB9LAogICAgICAgICAgaXNBdWRpb011dGVkOiBmdW5jdGlvbiBpc0F1ZGlvTXV0ZWQoKSB7CiAgICAgICAgICAgIHJldHVybiBpc011dGVkKGhhbmRsZUlkLCBmYWxzZSk7CiAgICAgICAgICB9LAogICAgICAgICAgbXV0ZUF1ZGlvOiBmdW5jdGlvbiBtdXRlQXVkaW8oKSB7CiAgICAgICAgICAgIHJldHVybiBtdXRlKGhhbmRsZUlkLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgdW5tdXRlQXVkaW86IGZ1bmN0aW9uIHVubXV0ZUF1ZGlvKCkgewogICAgICAgICAgICByZXR1cm4gbXV0ZShoYW5kbGVJZCwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBpc1ZpZGVvTXV0ZWQ6IGZ1bmN0aW9uIGlzVmlkZW9NdXRlZCgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzTXV0ZWQoaGFuZGxlSWQsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIG11dGVWaWRlbzogZnVuY3Rpb24gbXV0ZVZpZGVvKCkgewogICAgICAgICAgICByZXR1cm4gbXV0ZShoYW5kbGVJZCwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgdW5tdXRlVmlkZW86IGZ1bmN0aW9uIHVubXV0ZVZpZGVvKCkgewogICAgICAgICAgICByZXR1cm4gbXV0ZShoYW5kbGVJZCwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldEJpdHJhdGU6IGZ1bmN0aW9uIGdldEJpdHJhdGUoKSB7CiAgICAgICAgICAgIHJldHVybiBfZ2V0Qml0cmF0ZShoYW5kbGVJZCk7CiAgICAgICAgICB9LAogICAgICAgICAgc2VuZDogZnVuY3Rpb24gc2VuZChjYWxsYmFja3MpIHsKICAgICAgICAgICAgc2VuZE1lc3NhZ2UoaGFuZGxlSWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LAogICAgICAgICAgZGF0YTogZnVuY3Rpb24gZGF0YShjYWxsYmFja3MpIHsKICAgICAgICAgICAgc2VuZERhdGEoaGFuZGxlSWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LAogICAgICAgICAgZHRtZjogZnVuY3Rpb24gZHRtZihjYWxsYmFja3MpIHsKICAgICAgICAgICAgc2VuZER0bWYoaGFuZGxlSWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LAogICAgICAgICAgY29uc2VudERpYWxvZzogY2FsbGJhY2tzLmNvbnNlbnREaWFsb2csCiAgICAgICAgICBpY2VTdGF0ZTogY2FsbGJhY2tzLmljZVN0YXRlLAogICAgICAgICAgbWVkaWFTdGF0ZTogY2FsbGJhY2tzLm1lZGlhU3RhdGUsCiAgICAgICAgICB3ZWJydGNTdGF0ZTogY2FsbGJhY2tzLndlYnJ0Y1N0YXRlLAogICAgICAgICAgc2xvd0xpbms6IGNhbGxiYWNrcy5zbG93TGluaywKICAgICAgICAgIG9ubWVzc2FnZTogY2FsbGJhY2tzLm9ubWVzc2FnZSwKICAgICAgICAgIGNyZWF0ZU9mZmVyOiBmdW5jdGlvbiBjcmVhdGVPZmZlcihjYWxsYmFja3MpIHsKICAgICAgICAgICAgcHJlcGFyZVdlYnJ0YyhoYW5kbGVJZCwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjcmVhdGVBbnN3ZXI6IGZ1bmN0aW9uIGNyZWF0ZUFuc3dlcihjYWxsYmFja3MpIHsKICAgICAgICAgICAgcHJlcGFyZVdlYnJ0YyhoYW5kbGVJZCwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBoYW5kbGVSZW1vdGVKc2VwOiBmdW5jdGlvbiBoYW5kbGVSZW1vdGVKc2VwKGNhbGxiYWNrcykgewogICAgICAgICAgICBwcmVwYXJlV2VicnRjUGVlcihoYW5kbGVJZCwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBvbmxvY2Fsc3RyZWFtOiBjYWxsYmFja3Mub25sb2NhbHN0cmVhbSwKICAgICAgICAgIG9ucmVtb3Rlc3RyZWFtOiBjYWxsYmFja3Mub25yZW1vdGVzdHJlYW0sCiAgICAgICAgICBvbmRhdGE6IGNhbGxiYWNrcy5vbmRhdGEsCiAgICAgICAgICBvbmRhdGFvcGVuOiBjYWxsYmFja3Mub25kYXRhb3BlbiwKICAgICAgICAgIG9uY2xlYW51cDogY2FsbGJhY2tzLm9uY2xlYW51cCwKICAgICAgICAgIG9uZGV0YWNoZWQ6IGNhbGxiYWNrcy5vbmRldGFjaGVkLAogICAgICAgICAgaGFuZ3VwOiBmdW5jdGlvbiBoYW5ndXAoc2VuZFJlcXVlc3QpIHsKICAgICAgICAgICAgY2xlYW51cFdlYnJ0YyhoYW5kbGVJZCwgc2VuZFJlcXVlc3QgPT09IHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24gZGV0YWNoKGNhbGxiYWNrcykgewogICAgICAgICAgICBkZXN0cm95SGFuZGxlKGhhbmRsZUlkLCBjYWxsYmFja3MpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcGx1Z2luSGFuZGxlc1toYW5kbGVJZF0gPSBwbHVnaW5IYW5kbGU7CiAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocGx1Z2luSGFuZGxlKTsKICAgICAgfSwKICAgICAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKFhNTEh0dHBSZXF1ZXN0LCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgewogICAgICAgIEphbnVzLmVycm9yKHRleHRTdGF0dXMgKyAiOiAiICsgZXJyb3JUaHJvd24pOyAvLyBGSVhNRQogICAgICB9LAogICAgICBkYXRhVHlwZTogImpzb24iCiAgICB9KTsKICB9IC8vIFByaXZhdGUgbWV0aG9kIHRvIHNlbmQgYSBtZXNzYWdlCgoKICBmdW5jdGlvbiBzZW5kTWVzc2FnZShoYW5kbGVJZCwgY2FsbGJhY2tzKSB7CiAgICBjYWxsYmFja3MgPSBjYWxsYmFja3MgfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLmVycm9yID0gdHlwZW9mIGNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLmVycm9yIDogSmFudXMubm9vcDsKCiAgICBpZiAoIWNvbm5lY3RlZCkgewogICAgICBKYW51cy53YXJuKCJJcyB0aGUgZ2F0ZXdheSBkb3duPyAoY29ubmVjdGVkPWZhbHNlKSIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIklzIHRoZSBnYXRld2F5IGRvd24/IChjb25uZWN0ZWQ9ZmFsc2UpIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWVzc2FnZSA9IGNhbGxiYWNrcy5tZXNzYWdlOwogICAgdmFyIGpzZXAgPSBjYWxsYmFja3MuanNlcDsKICAgIHZhciB0cmFuc2FjdGlvbiA9IEphbnVzLnJhbmRvbVN0cmluZygxMik7CiAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgImphbnVzIjogIm1lc3NhZ2UiLAogICAgICAiYm9keSI6IG1lc3NhZ2UsCiAgICAgICJ0cmFuc2FjdGlvbiI6IHRyYW5zYWN0aW9uCiAgICB9OwogICAgaWYgKHRva2VuICE9PSBudWxsICYmIHRva2VuICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbInRva2VuIl0gPSB0b2tlbjsKICAgIGlmIChhcGlzZWNyZXQgIT09IG51bGwgJiYgYXBpc2VjcmV0ICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbImFwaXNlY3JldCJdID0gYXBpc2VjcmV0OwogICAgaWYgKGpzZXAgIT09IG51bGwgJiYganNlcCAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0LmpzZXAgPSBqc2VwOwogICAgSmFudXMuZGVidWcoIlNlbmRpbmcgbWVzc2FnZSB0byBwbHVnaW4gKGhhbmRsZT0iICsgaGFuZGxlSWQgKyAiKToiKTsKICAgIEphbnVzLmRlYnVnKHJlcXVlc3QpOwoKICAgIGlmICh3ZWJzb2NrZXRzKSB7CiAgICAgIHJlcXVlc3RbInNlc3Npb25faWQiXSA9IHNlc3Npb25JZDsKICAgICAgcmVxdWVzdFsiaGFuZGxlX2lkIl0gPSBoYW5kbGVJZDsKCiAgICAgIHRyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbl0gPSBmdW5jdGlvbiAoanNvbikgewogICAgICAgIEphbnVzLmRlYnVnKCJNZXNzYWdlIHNlbnQhIik7CiAgICAgICAgSmFudXMuZGVidWcoanNvbik7CgogICAgICAgIGlmIChqc29uWyJqYW51cyJdID09PSAic3VjY2VzcyIpIHsKICAgICAgICAgIC8vIFdlIGdvdCBhIHN1Y2Nlc3MsIG11c3QgaGF2ZSBiZWVuIGEgc3luY2hyb25vdXMgdHJhbnNhY3Rpb24KICAgICAgICAgIHZhciBwbHVnaW5kYXRhID0ganNvblsicGx1Z2luZGF0YSJdOwoKICAgICAgICAgIGlmIChwbHVnaW5kYXRhID09PSB1bmRlZmluZWQgfHwgcGx1Z2luZGF0YSA9PT0gbnVsbCkgewogICAgICAgICAgICBKYW51cy53YXJuKCJSZXF1ZXN0IHN1Y2NlZWRlZCwgYnV0IG1pc3NpbmcgcGx1Z2luZGF0YS4uLiIpOwogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgSmFudXMubG9nKCJTeW5jaHJvbm91cyB0cmFuc2FjdGlvbiBzdWNjZXNzZnVsICgiICsgcGx1Z2luZGF0YVsicGx1Z2luIl0gKyAiKSIpOwogICAgICAgICAgdmFyIGRhdGEgPSBwbHVnaW5kYXRhWyJkYXRhIl07CiAgICAgICAgICBKYW51cy5kZWJ1ZyhkYXRhKTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSBpZiAoanNvblsiamFudXMiXSAhPT0gImFjayIpIHsKICAgICAgICAgIC8vIE5vdCBhIHN1Y2Nlc3MgYW5kIG5vdCBhbiBhY2ssIG11c3QgYmUgYW4gZXJyb3IKICAgICAgICAgIGlmIChqc29uWyJlcnJvciJdICE9PSB1bmRlZmluZWQgJiYganNvblsiZXJyb3IiXSAhPT0gbnVsbCkgewogICAgICAgICAgICBKYW51cy5lcnJvcigiT29vcHM6ICIgKyBqc29uWyJlcnJvciJdLmNvZGUgKyAiICIgKyBqc29uWyJlcnJvciJdLnJlYXNvbik7IC8vIEZJWE1FCgogICAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoanNvblsiZXJyb3IiXS5jb2RlICsgIiAiICsganNvblsiZXJyb3IiXS5yZWFzb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgSmFudXMuZXJyb3IoIlVua25vd24gZXJyb3IiKTsgLy8gRklYTUUKCiAgICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcigiVW5rbm93biBlcnJvciIpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IC8vIElmIHdlIGdvdCBoZXJlLCB0aGUgcGx1Z2luIGRlY2lkZWQgdG8gaGFuZGxlIHRoZSByZXF1ZXN0IGFzeW5jaHJvbm91c2x5CgoKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgICB9OwoKICAgICAgd3Muc2VuZChKU09OLnN0cmluZ2lmeShyZXF1ZXN0KSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBKYW51cy5hamF4KHsKICAgICAgdHlwZTogJ1BPU1QnLAogICAgICB1cmw6IHNlcnZlciArICIvIiArIHNlc3Npb25JZCArICIvIiArIGhhbmRsZUlkLAogICAgICB3aXRoQ3JlZGVudGlhbHM6IHdpdGhDcmVkZW50aWFscywKICAgICAgY2FjaGU6IGZhbHNlLAogICAgICBjb250ZW50VHlwZTogImFwcGxpY2F0aW9uL2pzb24iLAogICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0KSwKICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2Vzcyhqc29uKSB7CiAgICAgICAgSmFudXMuZGVidWcoIk1lc3NhZ2Ugc2VudCEiKTsKICAgICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKCiAgICAgICAgaWYgKGpzb25bImphbnVzIl0gPT09ICJzdWNjZXNzIikgewogICAgICAgICAgLy8gV2UgZ290IGEgc3VjY2VzcywgbXVzdCBoYXZlIGJlZW4gYSBzeW5jaHJvbm91cyB0cmFuc2FjdGlvbgogICAgICAgICAgdmFyIHBsdWdpbmRhdGEgPSBqc29uWyJwbHVnaW5kYXRhIl07CgogICAgICAgICAgaWYgKHBsdWdpbmRhdGEgPT09IHVuZGVmaW5lZCB8fCBwbHVnaW5kYXRhID09PSBudWxsKSB7CiAgICAgICAgICAgIEphbnVzLndhcm4oIlJlcXVlc3Qgc3VjY2VlZGVkLCBidXQgbWlzc2luZyBwbHVnaW5kYXRhLi4uIik7CiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBKYW51cy5sb2coIlN5bmNocm9ub3VzIHRyYW5zYWN0aW9uIHN1Y2Nlc3NmdWwgKCIgKyBwbHVnaW5kYXRhWyJwbHVnaW4iXSArICIpIik7CiAgICAgICAgICB2YXIgZGF0YSA9IHBsdWdpbmRhdGFbImRhdGEiXTsKICAgICAgICAgIEphbnVzLmRlYnVnKGRhdGEpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIGlmIChqc29uWyJqYW51cyJdICE9PSAiYWNrIikgewogICAgICAgICAgLy8gTm90IGEgc3VjY2VzcyBhbmQgbm90IGFuIGFjaywgbXVzdCBiZSBhbiBlcnJvcgogICAgICAgICAgaWYgKGpzb25bImVycm9yIl0gIT09IHVuZGVmaW5lZCAmJiBqc29uWyJlcnJvciJdICE9PSBudWxsKSB7CiAgICAgICAgICAgIEphbnVzLmVycm9yKCJPb29wczogIiArIGpzb25bImVycm9yIl0uY29kZSArICIgIiArIGpzb25bImVycm9yIl0ucmVhc29uKTsgLy8gRklYTUUKCiAgICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcihqc29uWyJlcnJvciJdLmNvZGUgKyAiICIgKyBqc29uWyJlcnJvciJdLnJlYXNvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBKYW51cy5lcnJvcigiVW5rbm93biBlcnJvciIpOyAvLyBGSVhNRQoKICAgICAgICAgICAgY2FsbGJhY2tzLmVycm9yKCJVbmtub3duIGVycm9yIik7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gLy8gSWYgd2UgZ290IGhlcmUsIHRoZSBwbHVnaW4gZGVjaWRlZCB0byBoYW5kbGUgdGhlIHJlcXVlc3QgYXN5bmNocm9ub3VzbHkKCgogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgIH0sCiAgICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihYTUxIdHRwUmVxdWVzdCwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHsKICAgICAgICBKYW51cy5lcnJvcih0ZXh0U3RhdHVzICsgIjogIiArIGVycm9yVGhyb3duKTsgLy8gRklYTUUKCiAgICAgICAgY2FsbGJhY2tzLmVycm9yKHRleHRTdGF0dXMgKyAiOiAiICsgZXJyb3JUaHJvd24pOwogICAgICB9LAogICAgICBkYXRhVHlwZTogImpzb24iCiAgICB9KTsKICB9IC8vIFByaXZhdGUgbWV0aG9kIHRvIHNlbmQgYSB0cmlja2xlIGNhbmRpZGF0ZQoKCiAgZnVuY3Rpb24gc2VuZFRyaWNrbGVDYW5kaWRhdGUoaGFuZGxlSWQsIGNhbmRpZGF0ZSkgewogICAgaWYgKCFjb25uZWN0ZWQpIHsKICAgICAgSmFudXMud2FybigiSXMgdGhlIGdhdGV3YXkgZG93bj8gKGNvbm5lY3RlZD1mYWxzZSkiKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciByZXF1ZXN0ID0gewogICAgICAiamFudXMiOiAidHJpY2tsZSIsCiAgICAgICJjYW5kaWRhdGUiOiBjYW5kaWRhdGUsCiAgICAgICJ0cmFuc2FjdGlvbiI6IEphbnVzLnJhbmRvbVN0cmluZygxMikKICAgIH07CiAgICBpZiAodG9rZW4gIT09IG51bGwgJiYgdG9rZW4gIT09IHVuZGVmaW5lZCkgcmVxdWVzdFsidG9rZW4iXSA9IHRva2VuOwogICAgaWYgKGFwaXNlY3JldCAhPT0gbnVsbCAmJiBhcGlzZWNyZXQgIT09IHVuZGVmaW5lZCkgcmVxdWVzdFsiYXBpc2VjcmV0Il0gPSBhcGlzZWNyZXQ7CiAgICBKYW51cy52ZGVidWcoIlNlbmRpbmcgdHJpY2tsZSBjYW5kaWRhdGUgKGhhbmRsZT0iICsgaGFuZGxlSWQgKyAiKToiKTsKICAgIEphbnVzLnZkZWJ1ZyhyZXF1ZXN0KTsKCiAgICBpZiAod2Vic29ja2V0cykgewogICAgICByZXF1ZXN0WyJzZXNzaW9uX2lkIl0gPSBzZXNzaW9uSWQ7CiAgICAgIHJlcXVlc3RbImhhbmRsZV9pZCJdID0gaGFuZGxlSWQ7CiAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpOwogICAgICByZXR1cm47CiAgICB9CgogICAgSmFudXMuYWpheCh7CiAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgdXJsOiBzZXJ2ZXIgKyAiLyIgKyBzZXNzaW9uSWQgKyAiLyIgKyBoYW5kbGVJZCwKICAgICAgd2l0aENyZWRlbnRpYWxzOiB3aXRoQ3JlZGVudGlhbHMsCiAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdCksCiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MoanNvbikgewogICAgICAgIEphbnVzLnZkZWJ1ZygiQ2FuZGlkYXRlIHNlbnQhIik7CiAgICAgICAgSmFudXMudmRlYnVnKGpzb24pOwoKICAgICAgICBpZiAoanNvblsiamFudXMiXSAhPT0gImFjayIpIHsKICAgICAgICAgIEphbnVzLmVycm9yKCJPb29wczogIiArIGpzb25bImVycm9yIl0uY29kZSArICIgIiArIGpzb25bImVycm9yIl0ucmVhc29uKTsgLy8gRklYTUUKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9LAogICAgICBlcnJvcjogZnVuY3Rpb24gZXJyb3IoWE1MSHR0cFJlcXVlc3QsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7CiAgICAgICAgSmFudXMuZXJyb3IodGV4dFN0YXR1cyArICI6ICIgKyBlcnJvclRocm93bik7IC8vIEZJWE1FCiAgICAgIH0sCiAgICAgIGRhdGFUeXBlOiAianNvbiIKICAgIH0pOwogIH0gLy8gUHJpdmF0ZSBtZXRob2QgdG8gc2VuZCBhIGRhdGEgY2hhbm5lbCBtZXNzYWdlCgoKICBmdW5jdGlvbiBzZW5kRGF0YShoYW5kbGVJZCwgY2FsbGJhY2tzKSB7CiAgICBjYWxsYmFja3MgPSBjYWxsYmFja3MgfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLmVycm9yID0gdHlwZW9mIGNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLmVycm9yIDogSmFudXMubm9vcDsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIkludmFsaWQgaGFuZGxlIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY29uZmlnID0gcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmOwogICAgdmFyIHRleHQgPSBjYWxsYmFja3MudGV4dDsKCiAgICBpZiAodGV4dCA9PT0gbnVsbCB8fCB0ZXh0ID09PSB1bmRlZmluZWQpIHsKICAgICAgSmFudXMud2FybigiSW52YWxpZCB0ZXh0Iik7CiAgICAgIGNhbGxiYWNrcy5lcnJvcigiSW52YWxpZCB0ZXh0Iik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBKYW51cy5sb2coIlNlbmRpbmcgc3RyaW5nIG9uIGRhdGEgY2hhbm5lbDogIiArIHRleHQpOwogICAgY29uZmlnLmRhdGFDaGFubmVsLnNlbmQodGV4dCk7CiAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogIH0gLy8gUHJpdmF0ZSBtZXRob2QgdG8gc2VuZCBhIERUTUYgdG9uZQoKCiAgZnVuY3Rpb24gc2VuZER0bWYoaGFuZGxlSWQsIGNhbGxiYWNrcykgewogICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzIHx8IHt9OwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MgPSB0eXBlb2YgY2FsbGJhY2tzLnN1Y2Nlc3MgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5zdWNjZXNzIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy5lcnJvciA9IHR5cGVvZiBjYWxsYmFja3MuZXJyb3IgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5lcnJvciA6IEphbnVzLm5vb3A7CiAgICB2YXIgcGx1Z2luSGFuZGxlID0gcGx1Z2luSGFuZGxlc1toYW5kbGVJZF07CgogICAgaWYgKHBsdWdpbkhhbmRsZSA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUgPT09IHVuZGVmaW5lZCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IG51bGwgfHwgcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmID09PSB1bmRlZmluZWQpIHsKICAgICAgSmFudXMud2FybigiSW52YWxpZCBoYW5kbGUiKTsKICAgICAgY2FsbGJhY2tzLmVycm9yKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNvbmZpZyA9IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZjsKCiAgICBpZiAoY29uZmlnLmR0bWZTZW5kZXIgPT09IG51bGwgfHwgY29uZmlnLmR0bWZTZW5kZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyBDcmVhdGUgdGhlIERUTUYgc2VuZGVyLCBpZiBwb3NzaWJsZQogICAgICBpZiAoY29uZmlnLm15U3RyZWFtICE9PSB1bmRlZmluZWQgJiYgY29uZmlnLm15U3RyZWFtICE9PSBudWxsKSB7CiAgICAgICAgdmFyIHRyYWNrcyA9IGNvbmZpZy5teVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwoKICAgICAgICBpZiAodHJhY2tzICE9PSBudWxsICYmIHRyYWNrcyAhPT0gdW5kZWZpbmVkICYmIHRyYWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgbG9jYWxfYXVkaW9fdHJhY2sgPSB0cmFja3NbMF07CiAgICAgICAgICBjb25maWcuZHRtZlNlbmRlciA9IGNvbmZpZy5wYy5jcmVhdGVEVE1GU2VuZGVyKGxvY2FsX2F1ZGlvX3RyYWNrKTsKICAgICAgICAgIEphbnVzLmxvZygiQ3JlYXRlZCBEVE1GIFNlbmRlciIpOwoKICAgICAgICAgIGNvbmZpZy5kdG1mU2VuZGVyLm9udG9uZWNoYW5nZSA9IGZ1bmN0aW9uICh0b25lKSB7CiAgICAgICAgICAgIEphbnVzLmRlYnVnKCJTZW50IERUTUYgdG9uZTogIiArIHRvbmUudG9uZSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbmZpZy5kdG1mU2VuZGVyID09PSBudWxsIHx8IGNvbmZpZy5kdG1mU2VuZGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICBKYW51cy53YXJuKCJJbnZhbGlkIERUTUYgY29uZmlndXJhdGlvbiIpOwogICAgICAgIGNhbGxiYWNrcy5lcnJvcigiSW52YWxpZCBEVE1GIGNvbmZpZ3VyYXRpb24iKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICB2YXIgZHRtZiA9IGNhbGxiYWNrcy5kdG1mOwoKICAgIGlmIChkdG1mID09PSBudWxsIHx8IGR0bWYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIERUTUYgcGFyYW1ldGVycyIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIkludmFsaWQgRFRNRiBwYXJhbWV0ZXJzIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdG9uZXMgPSBkdG1mLnRvbmVzOwoKICAgIGlmICh0b25lcyA9PT0gbnVsbCB8fCB0b25lcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIEphbnVzLndhcm4oIkludmFsaWQgRFRNRiBzdHJpbmciKTsKICAgICAgY2FsbGJhY2tzLmVycm9yKCJJbnZhbGlkIERUTUYgc3RyaW5nIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZHVyYXRpb24gPSBkdG1mLmR1cmF0aW9uOwogICAgaWYgKGR1cmF0aW9uID09PSBudWxsIHx8IGR1cmF0aW9uID09PSB1bmRlZmluZWQpIGR1cmF0aW9uID0gNTAwOyAvLyBXZSBjaG9vc2UgNTAwbXMgYXMgdGhlIGRlZmF1bHQgZHVyYXRpb24gZm9yIGEgdG9uZQoKICAgIHZhciBnYXAgPSBkdG1mLmdhcDsKICAgIGlmIChnYXAgPT09IG51bGwgfHwgZ2FwID09PSB1bmRlZmluZWQpIGdhcCA9IDUwOyAvLyBXZSBjaG9vc2UgNTBtcyBhcyB0aGUgZGVmYXVsdCBnYXAgYmV0d2VlbiB0b25lcwoKICAgIEphbnVzLmRlYnVnKCJTZW5kaW5nIERUTUYgc3RyaW5nICIgKyB0b25lcyArICIgKGR1cmF0aW9uICIgKyBkdXJhdGlvbiArICJtcywgZ2FwICIgKyBnYXAgKyAibXMpIik7CiAgICBjb25maWcuZHRtZlNlbmRlci5pbnNlcnREVE1GKHRvbmVzLCBkdXJhdGlvbiwgZ2FwKTsKICB9IC8vIFByaXZhdGUgbWV0aG9kIHRvIGRlc3Ryb3kgYSBwbHVnaW4gaGFuZGxlCgoKICBmdW5jdGlvbiBkZXN0cm95SGFuZGxlKGhhbmRsZUlkLCBjYWxsYmFja3MpIHsKICAgIGNhbGxiYWNrcyA9IGNhbGxiYWNrcyB8fCB7fTsKICAgIGNhbGxiYWNrcy5zdWNjZXNzID0gdHlwZW9mIGNhbGxiYWNrcy5zdWNjZXNzID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3Muc3VjY2VzcyA6IEphbnVzLm5vb3A7CiAgICBjYWxsYmFja3MuZXJyb3IgPSB0eXBlb2YgY2FsbGJhY2tzLmVycm9yID09ICJmdW5jdGlvbiIgPyBjYWxsYmFja3MuZXJyb3IgOiBKYW51cy5ub29wOwogICAgdmFyIGFzeW5jUmVxdWVzdCA9IHRydWU7CiAgICBpZiAoY2FsbGJhY2tzLmFzeW5jUmVxdWVzdCAhPT0gdW5kZWZpbmVkICYmIGNhbGxiYWNrcy5hc3luY1JlcXVlc3QgIT09IG51bGwpIGFzeW5jUmVxdWVzdCA9IGNhbGxiYWNrcy5hc3luY1JlcXVlc3QgPT09IHRydWU7CiAgICBKYW51cy5sb2coIkRlc3Ryb3lpbmcgaGFuZGxlICIgKyBoYW5kbGVJZCArICIgKHN5bmM9IiArIGFzeW5jUmVxdWVzdCArICIpIik7CiAgICBjbGVhbnVwV2VicnRjKGhhbmRsZUlkKTsKCiAgICBpZiAocGx1Z2luSGFuZGxlc1toYW5kbGVJZF0uZGV0YWNoZWQpIHsKICAgICAgLy8gUGx1Z2luIHdhcyBhbHJlYWR5IGRldGFjaGVkIGJ5IEphbnVzLCBjYWxsaW5nIGRldGFjaCBhZ2FpbiB3aWxsIHJldHVybiBhIGhhbmRsZSBub3QgZm91bmQgZXJyb3IsIHNvIGp1c3QgZXhpdCBoZXJlCiAgICAgIGRlbGV0ZSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICghY29ubmVjdGVkKSB7CiAgICAgIEphbnVzLndhcm4oIklzIHRoZSBnYXRld2F5IGRvd24/IChjb25uZWN0ZWQ9ZmFsc2UpIik7CiAgICAgIGNhbGxiYWNrcy5lcnJvcigiSXMgdGhlIGdhdGV3YXkgZG93bj8gKGNvbm5lY3RlZD1mYWxzZSkiKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciByZXF1ZXN0ID0gewogICAgICAiamFudXMiOiAiZGV0YWNoIiwKICAgICAgInRyYW5zYWN0aW9uIjogSmFudXMucmFuZG9tU3RyaW5nKDEyKQogICAgfTsKICAgIGlmICh0b2tlbiAhPT0gbnVsbCAmJiB0b2tlbiAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0WyJ0b2tlbiJdID0gdG9rZW47CiAgICBpZiAoYXBpc2VjcmV0ICE9PSBudWxsICYmIGFwaXNlY3JldCAhPT0gdW5kZWZpbmVkKSByZXF1ZXN0WyJhcGlzZWNyZXQiXSA9IGFwaXNlY3JldDsKCiAgICBpZiAod2Vic29ja2V0cykgewogICAgICByZXF1ZXN0WyJzZXNzaW9uX2lkIl0gPSBzZXNzaW9uSWQ7CiAgICAgIHJlcXVlc3RbImhhbmRsZV9pZCJdID0gaGFuZGxlSWQ7CiAgICAgIHdzLnNlbmQoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpOwogICAgICBkZWxldGUgcGx1Z2luSGFuZGxlc1toYW5kbGVJZF07CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBKYW51cy5hamF4KHsKICAgICAgdHlwZTogJ1BPU1QnLAogICAgICB1cmw6IHNlcnZlciArICIvIiArIHNlc3Npb25JZCArICIvIiArIGhhbmRsZUlkLAogICAgICBhc3luYzogYXN5bmNSZXF1ZXN0LAogICAgICAvLyBTb21ldGltZXMgd2UgbmVlZCBmYWxzZSBoZXJlLCBvciBkZXN0cm95aW5nIGluIG9uYmVmb3JldW5sb2FkIHdvbid0IHdvcmsKICAgICAgd2l0aENyZWRlbnRpYWxzOiB3aXRoQ3JlZGVudGlhbHMsCiAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdCksCiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MoanNvbikgewogICAgICAgIEphbnVzLmxvZygiRGVzdHJveWVkIGhhbmRsZToiKTsKICAgICAgICBKYW51cy5kZWJ1Zyhqc29uKTsKCiAgICAgICAgaWYgKGpzb25bImphbnVzIl0gIT09ICJzdWNjZXNzIikgewogICAgICAgICAgSmFudXMuZXJyb3IoIk9vb3BzOiAiICsganNvblsiZXJyb3IiXS5jb2RlICsgIiAiICsganNvblsiZXJyb3IiXS5yZWFzb24pOyAvLyBGSVhNRQogICAgICAgIH0KCiAgICAgICAgZGVsZXRlIHBsdWdpbkhhbmRsZXNbaGFuZGxlSWRdOwogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICAgIH0sCiAgICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihYTUxIdHRwUmVxdWVzdCwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHsKICAgICAgICBKYW51cy5lcnJvcih0ZXh0U3RhdHVzICsgIjogIiArIGVycm9yVGhyb3duKTsgLy8gRklYTUUKICAgICAgICAvLyBXZSBjbGVhbnVwIGFueXdheQoKICAgICAgICBkZWxldGUgcGx1Z2luSGFuZGxlc1toYW5kbGVJZF07CiAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgICAgfSwKICAgICAgZGF0YVR5cGU6ICJqc29uIgogICAgfSk7CiAgfSAvLyBXZWJSVEMgc3R1ZmYKCgogIGZ1bmN0aW9uIHN0cmVhbXNEb25lKGhhbmRsZUlkLCBqc2VwLCBtZWRpYSwgY2FsbGJhY2tzLCBzdHJlYW0pIHsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIkludmFsaWQgaGFuZGxlIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY29uZmlnID0gcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmOwogICAgSmFudXMuZGVidWcoInN0cmVhbXNEb25lOiIsIHN0cmVhbSk7CiAgICBjb25maWcubXlTdHJlYW0gPSBzdHJlYW07CiAgICB2YXIgcGNfY29uZmlnID0gewogICAgICAiaWNlU2VydmVycyI6IGljZVNlcnZlcnMsCiAgICAgICJpY2VUcmFuc3BvcnRQb2xpY3kiOiBpY2VUcmFuc3BvcnRQb2xpY3kKICAgIH07IC8vfiB2YXIgcGNfY29uc3RyYWludHMgPSB7J21hbmRhdG9yeSc6IHsnTW96RG9udE9mZmVyRGF0YUNoYW5uZWwnOnRydWV9fTsKCiAgICB2YXIgcGNfY29uc3RyYWludHMgPSB7CiAgICAgICJvcHRpb25hbCI6IFt7CiAgICAgICAgIkR0bHNTcnRwS2V5QWdyZWVtZW50IjogdHJ1ZQogICAgICB9XQogICAgfTsKCiAgICBpZiAoaXB2NlN1cHBvcnQgPT09IHRydWUpIHsKICAgICAgLy8gRklYTUUgVGhpcyBpcyBvbmx5IHN1cHBvcnRlZCBpbiBDaHJvbWUgcmlnaHQgbm93CiAgICAgIC8vIEZvciBzdXBwb3J0IGluIEZpcmVmb3ggdHJhY2sgdGhpczogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Nzk3MjYyCiAgICAgIHBjX2NvbnN0cmFpbnRzLm9wdGlvbmFsLnB1c2goewogICAgICAgICJnb29nSVB2NiI6IHRydWUKICAgICAgfSk7CiAgICB9CgogICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PT0gImVkZ2UiKSB7CiAgICAgIC8vIFRoaXMgaXMgRWRnZSwgZW5hYmxlIEJVTkRMRSBleHBsaWNpdGx5CiAgICAgIHBjX2NvbmZpZy5idW5kbGVQb2xpY3kgPSAibWF4LWJ1bmRsZSI7CiAgICB9CgogICAgSmFudXMubG9nKCJDcmVhdGluZyBQZWVyQ29ubmVjdGlvbiIpOwogICAgSmFudXMuZGVidWcocGNfY29uc3RyYWludHMpOwogICAgY29uZmlnLnBjID0gbmV3IFJUQ1BlZXJDb25uZWN0aW9uKHBjX2NvbmZpZywgcGNfY29uc3RyYWludHMpOwogICAgSmFudXMuZGVidWcoY29uZmlnLnBjKTsKCiAgICBpZiAoY29uZmlnLnBjLmdldFN0YXRzKSB7CiAgICAgIC8vIEZJWE1FCiAgICAgIGNvbmZpZy52b2x1bWUudmFsdWUgPSAwOwogICAgICBjb25maWcuYml0cmF0ZS52YWx1ZSA9ICIwIGtiaXRzL3NlYyI7CiAgICB9CgogICAgSmFudXMubG9nKCJQcmVwYXJpbmcgbG9jYWwgU0RQIGFuZCBnYXRoZXJpbmcgY2FuZGlkYXRlcyAodHJpY2tsZT0iICsgY29uZmlnLnRyaWNrbGUgKyAiKSIpOwoKICAgIGNvbmZpZy5wYy5vbmljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmIChjb25maWcucGMpIHBsdWdpbkhhbmRsZS5pY2VTdGF0ZShjb25maWcucGMuaWNlQ29ubmVjdGlvblN0YXRlKTsKICAgIH07CgogICAgY29uZmlnLnBjLm9uaWNlY2FuZGlkYXRlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jYW5kaWRhdGUgPT0gbnVsbCB8fCBhZGFwdGVyLmJyb3dzZXJEZXRhaWxzLmJyb3dzZXIgPT09ICdlZGdlJyAmJiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlLmluZGV4T2YoJ2VuZE9mQ2FuZGlkYXRlcycpID4gMCkgewogICAgICAgIEphbnVzLmxvZygiRW5kIG9mIGNhbmRpZGF0ZXMuIik7CiAgICAgICAgY29uZmlnLmljZURvbmUgPSB0cnVlOwoKICAgICAgICBpZiAoY29uZmlnLnRyaWNrbGUgPT09IHRydWUpIHsKICAgICAgICAgIC8vIE5vdGlmeSBlbmQgb2YgY2FuZGlkYXRlcwogICAgICAgICAgc2VuZFRyaWNrbGVDYW5kaWRhdGUoaGFuZGxlSWQsIHsKICAgICAgICAgICAgImNvbXBsZXRlZCI6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBObyB0cmlja2xlLCB0aW1lIHRvIHNlbmQgdGhlIGNvbXBsZXRlIFNEUCAoaW5jbHVkaW5nIGFsbCBjYW5kaWRhdGVzKQogICAgICAgICAgc2VuZFNEUChoYW5kbGVJZCwgY2FsbGJhY2tzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSlNPTi5zdHJpbmdpZnkgZG9lc24ndCB3b3JrIG9uIHNvbWUgV2ViUlRDIG9iamVjdHMgYW55bW9yZQogICAgICAgIC8vIFNlZSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDY3MzY2CiAgICAgICAgdmFyIGNhbmRpZGF0ZSA9IHsKICAgICAgICAgICJjYW5kaWRhdGUiOiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlLAogICAgICAgICAgInNkcE1pZCI6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsCiAgICAgICAgICAic2RwTUxpbmVJbmRleCI6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNTGluZUluZGV4CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGNvbmZpZy50cmlja2xlID09PSB0cnVlKSB7CiAgICAgICAgICAvLyBTZW5kIGNhbmRpZGF0ZQogICAgICAgICAgc2VuZFRyaWNrbGVDYW5kaWRhdGUoaGFuZGxlSWQsIGNhbmRpZGF0ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGlmIChzdHJlYW0gIT09IG51bGwgJiYgc3RyZWFtICE9PSB1bmRlZmluZWQpIHsKICAgICAgSmFudXMubG9nKCdBZGRpbmcgbG9jYWwgc3RyZWFtJyk7CiAgICAgIGNvbmZpZy5wYy5hZGRTdHJlYW0oc3RyZWFtKTsKICAgICAgcGx1Z2luSGFuZGxlLm9ubG9jYWxzdHJlYW0oc3RyZWFtKTsKICAgIH0KCiAgICBjb25maWcucGMub25hZGRzdHJlYW0gPSBmdW5jdGlvbiAocmVtb3RlU3RyZWFtKSB7CiAgICAgIEphbnVzLmxvZygiSGFuZGxpbmcgUmVtb3RlIFN0cmVhbSIpOwogICAgICBKYW51cy5kZWJ1ZyhyZW1vdGVTdHJlYW0pOwogICAgICBjb25maWcucmVtb3RlU3RyZWFtID0gcmVtb3RlU3RyZWFtOwogICAgICBwbHVnaW5IYW5kbGUub25yZW1vdGVzdHJlYW0ocmVtb3RlU3RyZWFtLnN0cmVhbSk7CiAgICB9OyAvLyBBbnkgZGF0YSBjaGFubmVsIHRvIGNyZWF0ZT8KCgogICAgaWYgKGlzRGF0YUVuYWJsZWQobWVkaWEpKSB7CiAgICAgIEphbnVzLmxvZygiQ3JlYXRpbmcgZGF0YSBjaGFubmVsIik7CgogICAgICB2YXIgb25EYXRhQ2hhbm5lbE1lc3NhZ2UgPSBmdW5jdGlvbiBvbkRhdGFDaGFubmVsTWVzc2FnZShldmVudCkgewogICAgICAgIEphbnVzLmxvZygnUmVjZWl2ZWQgbWVzc2FnZSBvbiBkYXRhIGNoYW5uZWw6ICcgKyBldmVudC5kYXRhKTsKICAgICAgICBwbHVnaW5IYW5kbGUub25kYXRhKGV2ZW50LmRhdGEpOyAvLyBGSVhNRQogICAgICB9OwoKICAgICAgdmFyIG9uRGF0YUNoYW5uZWxTdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIG9uRGF0YUNoYW5uZWxTdGF0ZUNoYW5nZSgpIHsKICAgICAgICB2YXIgZGNTdGF0ZSA9IGNvbmZpZy5kYXRhQ2hhbm5lbCAhPT0gbnVsbCA/IGNvbmZpZy5kYXRhQ2hhbm5lbC5yZWFkeVN0YXRlIDogIm51bGwiOwogICAgICAgIEphbnVzLmxvZygnU3RhdGUgY2hhbmdlIG9uIGRhdGEgY2hhbm5lbDogJyArIGRjU3RhdGUpOwoKICAgICAgICBpZiAoZGNTdGF0ZSA9PT0gJ29wZW4nKSB7CiAgICAgICAgICBwbHVnaW5IYW5kbGUub25kYXRhb3BlbigpOyAvLyBGSVhNRQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBvbkRhdGFDaGFubmVsRXJyb3IgPSBmdW5jdGlvbiBvbkRhdGFDaGFubmVsRXJyb3IoZXJyb3IpIHsKICAgICAgICBKYW51cy5lcnJvcignR290IGVycm9yIG9uIGRhdGEgY2hhbm5lbDonLCBlcnJvcik7IC8vIFRPRE8KICAgICAgfTsgLy8gVW50aWwgd2UgaW1wbGVtZW50IHRoZSBwcm94eWluZyBvZiBvcGVuIHJlcXVlc3RzIHdpdGhpbiB0aGUgSmFudXMgY29yZSwgd2Ugb3BlbiBhIGNoYW5uZWwgb3Vyc2VsdmVzIHdoYXRldmVyIHRoZSBjYXNlCgoKICAgICAgY29uZmlnLmRhdGFDaGFubmVsID0gY29uZmlnLnBjLmNyZWF0ZURhdGFDaGFubmVsKCJKYW51c0RhdGFDaGFubmVsIiwgewogICAgICAgIG9yZGVyZWQ6IGZhbHNlCiAgICAgIH0pOyAvLyBGSVhNRSBBZGQgb3B0aW9ucyAob3JkZXJlZCwgbWF4UmV0cmFuc21pdHMsIGV0Yy4pCgogICAgICBjb25maWcuZGF0YUNoYW5uZWwub25tZXNzYWdlID0gb25EYXRhQ2hhbm5lbE1lc3NhZ2U7CiAgICAgIGNvbmZpZy5kYXRhQ2hhbm5lbC5vbm9wZW4gPSBvbkRhdGFDaGFubmVsU3RhdGVDaGFuZ2U7CiAgICAgIGNvbmZpZy5kYXRhQ2hhbm5lbC5vbmNsb3NlID0gb25EYXRhQ2hhbm5lbFN0YXRlQ2hhbmdlOwogICAgICBjb25maWcuZGF0YUNoYW5uZWwub25lcnJvciA9IG9uRGF0YUNoYW5uZWxFcnJvcjsKICAgIH0gLy8gQ3JlYXRlIG9mZmVyL2Fuc3dlciBub3cKCgogICAgaWYgKGpzZXAgPT09IG51bGwgfHwganNlcCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGNyZWF0ZU9mZmVyKGhhbmRsZUlkLCBtZWRpYSwgY2FsbGJhY2tzKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChhZGFwdGVyLmJyb3dzZXJEZXRhaWxzLmJyb3dzZXIgPT09ICJlZGdlIikgewogICAgICAgIC8vIFRoaXMgaXMgRWRnZSwgYWRkIGFuIGE9ZW5kLW9mLWNhbmRpZGF0ZXMgYXQgdGhlIGVuZAogICAgICAgIGpzZXAuc2RwICs9ICJhPWVuZC1vZi1jYW5kaWRhdGVzXHJcbiI7CiAgICAgIH0KCiAgICAgIGNvbmZpZy5wYy5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKGpzZXApLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgSmFudXMubG9nKCJSZW1vdGUgZGVzY3JpcHRpb24gYWNjZXB0ZWQhIik7CiAgICAgICAgY3JlYXRlQW5zd2VyKGhhbmRsZUlkLCBtZWRpYSwgY2FsbGJhY2tzKTsKICAgICAgfSwgY2FsbGJhY2tzLmVycm9yKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHByZXBhcmVXZWJydGMoaGFuZGxlSWQsIGNhbGxiYWNrcykgewogICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzIHx8IHt9OwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MgPSB0eXBlb2YgY2FsbGJhY2tzLnN1Y2Nlc3MgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5zdWNjZXNzIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy5lcnJvciA9IHR5cGVvZiBjYWxsYmFja3MuZXJyb3IgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5lcnJvciA6IHdlYnJ0Y0Vycm9yOwogICAgdmFyIGpzZXAgPSBjYWxsYmFja3MuanNlcDsKICAgIHZhciBtZWRpYSA9IGNhbGxiYWNrcy5tZWRpYTsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIkludmFsaWQgaGFuZGxlIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY29uZmlnID0gcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmOyAvLyBBcmUgd2UgdXBkYXRpbmcgYSBzZXNzaW9uPwoKICAgIGlmIChjb25maWcucGMgIT09IHVuZGVmaW5lZCAmJiBjb25maWcucGMgIT09IG51bGwpIHsKICAgICAgSmFudXMubG9nKCJVcGRhdGluZyBleGlzdGluZyBtZWRpYSBzZXNzaW9uIik7IC8vIENyZWF0ZSBvZmZlci9hbnN3ZXIgbm93CgogICAgICBpZiAoanNlcCA9PT0gbnVsbCB8fCBqc2VwID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjcmVhdGVPZmZlcihoYW5kbGVJZCwgbWVkaWEsIGNhbGxiYWNrcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PT0gImVkZ2UiKSB7CiAgICAgICAgICAvLyBUaGlzIGlzIEVkZ2UsIGFkZCBhbiBhPWVuZC1vZi1jYW5kaWRhdGVzIGF0IHRoZSBlbmQKICAgICAgICAgIGpzZXAuc2RwICs9ICJhPWVuZC1vZi1jYW5kaWRhdGVzXHJcbiI7CiAgICAgICAgfQoKICAgICAgICBjb25maWcucGMuc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihqc2VwKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgSmFudXMubG9nKCJSZW1vdGUgZGVzY3JpcHRpb24gYWNjZXB0ZWQhIik7CiAgICAgICAgICBjcmVhdGVBbnN3ZXIoaGFuZGxlSWQsIG1lZGlhLCBjYWxsYmFja3MpOwogICAgICAgIH0sIGNhbGxiYWNrcy5lcnJvcik7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0gLy8gV2FzIGEgTWVkaWFTdHJlYW0gb2JqZWN0IHBhc3NlZCwgb3IgZG8gd2UgbmVlZCB0byB0YWtlIGNhcmUgb2YgdGhhdD8KCgogICAgaWYgKGNhbGxiYWNrcy5zdHJlYW0gIT09IG51bGwgJiYgY2FsbGJhY2tzLnN0cmVhbSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhciBzdHJlYW0gPSBjYWxsYmFja3Muc3RyZWFtOwogICAgICBKYW51cy5sb2coIk1lZGlhU3RyZWFtIHByb3ZpZGVkIGJ5IHRoZSBhcHBsaWNhdGlvbiIpOwogICAgICBKYW51cy5kZWJ1ZyhzdHJlYW0pOyAvLyBTa2lwIHRoZSBnZXRVc2VyTWVkaWEgcGFydAoKICAgICAgY29uZmlnLnN0cmVhbUV4dGVybmFsID0gdHJ1ZTsKICAgICAgc3RyZWFtc0RvbmUoaGFuZGxlSWQsIGpzZXAsIG1lZGlhLCBjYWxsYmFja3MsIHN0cmVhbSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25maWcudHJpY2tsZSA9IGlzVHJpY2tsZUVuYWJsZWQoY2FsbGJhY2tzLnRyaWNrbGUpOwoKICAgIGlmIChpc0F1ZGlvU2VuZEVuYWJsZWQobWVkaWEpIHx8IGlzVmlkZW9TZW5kRW5hYmxlZChtZWRpYSkpIHsKICAgICAgdmFyIGNvbnN0cmFpbnRzID0gewogICAgICAgIG1hbmRhdG9yeToge30sCiAgICAgICAgb3B0aW9uYWw6IFtdCiAgICAgIH07CiAgICAgIHBsdWdpbkhhbmRsZS5jb25zZW50RGlhbG9nKHRydWUpOwogICAgICB2YXIgYXVkaW9TdXBwb3J0ID0gaXNBdWRpb1NlbmRFbmFibGVkKG1lZGlhKTsKCiAgICAgIGlmIChhdWRpb1N1cHBvcnQgPT09IHRydWUgJiYgbWVkaWEgIT0gdW5kZWZpbmVkICYmIG1lZGlhICE9IG51bGwpIHsKICAgICAgICBpZiAoX3R5cGVvZihtZWRpYS5hdWRpbykgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICBhdWRpb1N1cHBvcnQgPSBtZWRpYS5hdWRpbzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciB2aWRlb1N1cHBvcnQgPSBpc1ZpZGVvU2VuZEVuYWJsZWQobWVkaWEpOwoKICAgICAgaWYgKHZpZGVvU3VwcG9ydCA9PT0gdHJ1ZSAmJiBtZWRpYSAhPSB1bmRlZmluZWQgJiYgbWVkaWEgIT0gbnVsbCkgewogICAgICAgIGlmIChtZWRpYS52aWRlbyAmJiBtZWRpYS52aWRlbyAhPSAnc2NyZWVuJyAmJiBtZWRpYS52aWRlbyAhPSAnd2luZG93JykgewogICAgICAgICAgdmFyIHdpZHRoID0gMDsKICAgICAgICAgIHZhciBoZWlnaHQgPSAwLAogICAgICAgICAgICAgIG1heEhlaWdodCA9IDA7CgogICAgICAgICAgaWYgKG1lZGlhLnZpZGVvID09PSAnbG93cmVzJykgewogICAgICAgICAgICAvLyBTbWFsbCByZXNvbHV0aW9uLCA0OjMKICAgICAgICAgICAgaGVpZ2h0ID0gMjQwOwogICAgICAgICAgICBtYXhIZWlnaHQgPSAyNDA7CiAgICAgICAgICAgIHdpZHRoID0gMzIwOwogICAgICAgICAgfSBlbHNlIGlmIChtZWRpYS52aWRlbyA9PT0gJ2xvd3Jlcy0xNjo5JykgewogICAgICAgICAgICAvLyBTbWFsbCByZXNvbHV0aW9uLCAxNjo5CiAgICAgICAgICAgIGhlaWdodCA9IDE4MDsKICAgICAgICAgICAgbWF4SGVpZ2h0ID0gMTgwOwogICAgICAgICAgICB3aWR0aCA9IDMyMDsKICAgICAgICAgIH0gZWxzZSBpZiAobWVkaWEudmlkZW8gPT09ICdoaXJlcycgfHwgbWVkaWEudmlkZW8gPT09ICdoaXJlcy0xNjo5JykgewogICAgICAgICAgICAvLyBIaWdoIHJlc29sdXRpb24gaXMgb25seSAxNjo5CiAgICAgICAgICAgIGhlaWdodCA9IDcyMDsKICAgICAgICAgICAgbWF4SGVpZ2h0ID0gNzIwOwogICAgICAgICAgICB3aWR0aCA9IDEyODA7CgogICAgICAgICAgICBpZiAobmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSkgewogICAgICAgICAgICAgIHZhciBmaXJlZm94VmVyID0gcGFyc2VJbnQod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0ZpcmVmb3hcLyguKikvKVsxXSwgMTApOwoKICAgICAgICAgICAgICBpZiAoZmlyZWZveFZlciA8IDM4KSB7CiAgICAgICAgICAgICAgICAvLyBVbmxlc3MgdGhpcyBpcyBhbmQgb2xkIEZpcmVmb3gsIHdoaWNoIGRvZXNuJ3Qgc3VwcG9ydCBpdAogICAgICAgICAgICAgICAgSmFudXMud2FybihtZWRpYS52aWRlbyArICIgdW5zdXBwb3J0ZWQsIGZhbGxpbmcgYmFjayB0byBzdGRyZXMgKG9sZCBGaXJlZm94KSIpOwogICAgICAgICAgICAgICAgaGVpZ2h0ID0gNDgwOwogICAgICAgICAgICAgICAgbWF4SGVpZ2h0ID0gNDgwOwogICAgICAgICAgICAgICAgd2lkdGggPSA2NDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG1lZGlhLnZpZGVvID09PSAnc3RkcmVzJykgewogICAgICAgICAgICAvLyBOb3JtYWwgcmVzb2x1dGlvbiwgNDozCiAgICAgICAgICAgIGhlaWdodCA9IDQ4MDsKICAgICAgICAgICAgbWF4SGVpZ2h0ID0gNDgwOwogICAgICAgICAgICB3aWR0aCA9IDY0MDsKICAgICAgICAgIH0gZWxzZSBpZiAobWVkaWEudmlkZW8gPT09ICdzdGRyZXMtMTY6OScpIHsKICAgICAgICAgICAgLy8gTm9ybWFsIHJlc29sdXRpb24sIDE2OjkKICAgICAgICAgICAgaGVpZ2h0ID0gMzYwOwogICAgICAgICAgICBtYXhIZWlnaHQgPSAzNjA7CiAgICAgICAgICAgIHdpZHRoID0gNjQwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgSmFudXMubG9nKCJEZWZhdWx0IHZpZGVvIHNldHRpbmcgKCIgKyBtZWRpYS52aWRlbyArICIpIGlzIHN0ZHJlcyA0OjMiKTsKICAgICAgICAgICAgaGVpZ2h0ID0gNDgwOwogICAgICAgICAgICBtYXhIZWlnaHQgPSA0ODA7CiAgICAgICAgICAgIHdpZHRoID0gNjQwOwogICAgICAgICAgfQoKICAgICAgICAgIEphbnVzLmxvZygiQWRkaW5nIG1lZGlhIGNvbnN0cmFpbnQgIiArIG1lZGlhLnZpZGVvKTsKCiAgICAgICAgICBpZiAobmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSkgewogICAgICAgICAgICB2YXIgZmlyZWZveFZlciA9IHBhcnNlSW50KHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9GaXJlZm94XC8oLiopLylbMV0sIDEwKTsKCiAgICAgICAgICAgIGlmIChmaXJlZm94VmVyIDwgMzgpIHsKICAgICAgICAgICAgICB2aWRlb1N1cHBvcnQgPSB7CiAgICAgICAgICAgICAgICAncmVxdWlyZSc6IFsnaGVpZ2h0JywgJ3dpZHRoJ10sCiAgICAgICAgICAgICAgICAnaGVpZ2h0JzogewogICAgICAgICAgICAgICAgICAnbWF4JzogbWF4SGVpZ2h0LAogICAgICAgICAgICAgICAgICAnbWluJzogaGVpZ2h0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgJ3dpZHRoJzogewogICAgICAgICAgICAgICAgICAnbWF4Jzogd2lkdGgsCiAgICAgICAgICAgICAgICAgICdtaW4nOiB3aWR0aAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yODI4MjM4NS93ZWJydGMtZmlyZWZveC1jb25zdHJhaW50cy8yODkxMTY5NCMyODkxMTY5NAogICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tZWV0ZWNoby9qYW51cy1nYXRld2F5L3B1bGwvMjQ2CiAgICAgICAgICAgICAgdmlkZW9TdXBwb3J0ID0gewogICAgICAgICAgICAgICAgJ2hlaWdodCc6IHsKICAgICAgICAgICAgICAgICAgJ2lkZWFsJzogaGVpZ2h0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgJ3dpZHRoJzogewogICAgICAgICAgICAgICAgICAnaWRlYWwnOiB3aWR0aAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZpZGVvU3VwcG9ydCA9IHsKICAgICAgICAgICAgICAnbWFuZGF0b3J5JzogewogICAgICAgICAgICAgICAgJ21heEhlaWdodCc6IG1heEhlaWdodCwKICAgICAgICAgICAgICAgICdtaW5IZWlnaHQnOiBoZWlnaHQsCiAgICAgICAgICAgICAgICAnbWF4V2lkdGgnOiB3aWR0aCwKICAgICAgICAgICAgICAgICdtaW5XaWR0aCc6IHdpZHRoCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAnb3B0aW9uYWwnOiBbXQogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChfdHlwZW9mKG1lZGlhLnZpZGVvKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgdmlkZW9TdXBwb3J0ID0gbWVkaWEudmlkZW87CiAgICAgICAgICB9CgogICAgICAgICAgSmFudXMuZGVidWcodmlkZW9TdXBwb3J0KTsKICAgICAgICB9IGVsc2UgaWYgKG1lZGlhLnZpZGVvID09PSAnc2NyZWVuJyB8fCBtZWRpYS52aWRlbyA9PT0gJ3dpbmRvdycpIHsKICAgICAgICAgIHZhciBjYWxsYmFja1VzZXJNZWRpYSA9IGZ1bmN0aW9uIGNhbGxiYWNrVXNlck1lZGlhKGVycm9yLCBzdHJlYW0pIHsKICAgICAgICAgICAgcGx1Z2luSGFuZGxlLmNvbnNlbnREaWFsb2coZmFsc2UpOwoKICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLmVycm9yKHsKICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLmNvZGUsCiAgICAgICAgICAgICAgICBuYW1lOiBlcnJvci5uYW1lLAogICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmVhbXNEb25lKGhhbmRsZUlkLCBqc2VwLCBtZWRpYSwgY2FsbGJhY2tzLCBzdHJlYW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIHZhciBnZXRTY3JlZW5NZWRpYSA9IGZ1bmN0aW9uIGdldFNjcmVlbk1lZGlhKGNvbnN0cmFpbnRzLCBnc21DYWxsYmFjaywgdXNlQXVkaW8pIHsKICAgICAgICAgICAgSmFudXMubG9nKCJBZGRpbmcgbWVkaWEgY29uc3RyYWludCAoc2NyZWVuIGNhcHR1cmUpIik7CiAgICAgICAgICAgIEphbnVzLmRlYnVnKGNvbnN0cmFpbnRzKTsKICAgICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoY29uc3RyYWludHMpLnRoZW4oZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICAgICAgICAgIGlmICh1c2VBdWRpbykgewogICAgICAgICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoewogICAgICAgICAgICAgICAgICBhdWRpbzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdmlkZW86IGZhbHNlCiAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChhdWRpb1N0cmVhbSkgewogICAgICAgICAgICAgICAgICBzdHJlYW0uYWRkVHJhY2soYXVkaW9TdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXSk7CiAgICAgICAgICAgICAgICAgIGdzbUNhbGxiYWNrKG51bGwsIHN0cmVhbSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZ3NtQ2FsbGJhY2sobnVsbCwgc3RyZWFtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgIHBsdWdpbkhhbmRsZS5jb25zZW50RGlhbG9nKGZhbHNlKTsKICAgICAgICAgICAgICBnc21DYWxsYmFjayhlcnJvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAoIW1lZGlhLnNjcmVlbnNoYXJlRnJhbWVSYXRlKSB7CiAgICAgICAgICAgIG1lZGlhLnNjcmVlbnNoYXJlRnJhbWVSYXRlID0gMzsKICAgICAgICAgIH0gLy8gTm90IGEgd2ViY2FtLCBidXQgc2NyZWVuIGNhcHR1cmUKCgogICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCAhPT0gJ2h0dHBzOicpIHsKICAgICAgICAgICAgLy8gU2NyZWVuIHNoYXJpbmcgbWFuZGF0ZXMgSFRUUFMKICAgICAgICAgICAgSmFudXMud2FybigiU2NyZWVuIHNoYXJpbmcgb25seSB3b3JrcyBvbiBIVFRQUywgdHJ5IHRoZSBodHRwczovLyB2ZXJzaW9uIG9mIHRoaXMgcGFnZSIpOwogICAgICAgICAgICBwbHVnaW5IYW5kbGUuY29uc2VudERpYWxvZyhmYWxzZSk7CiAgICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcigiU2NyZWVuIHNoYXJpbmcgb25seSB3b3JrcyBvbiBIVFRQUywgdHJ5IHRoZSBodHRwczovLyB2ZXJzaW9uIG9mIHRoaXMgcGFnZSIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IC8vIFdlJ3JlIGdvaW5nIHRvIHRyeSBhbmQgdXNlIHRoZSBleHRlbnNpb24gZm9yIENocm9tZSAzNCssIHRoZSBvbGQgYXBwcm9hY2gKICAgICAgICAgIC8vIGZvciBvbGRlciB2ZXJzaW9ucyBvZiBDaHJvbWUsIG9yIHRoZSBleHBlcmltZW50YWwgc3VwcG9ydCBpbiBGaXJlZm94IDMzKwoKCiAgICAgICAgICB2YXIgY2FjaGUgPSB7fTsKICAgICAgICAgIDsKICAgICAgICAgIDsKCiAgICAgICAgICBpZiAoYWRhcHRlci5icm93c2VyRGV0YWlscy5icm93c2VyID09PSAnY2hyb21lJykgewogICAgICAgICAgICB2YXIgY2hyb21ldmVyID0gYWRhcHRlci5icm93c2VyRGV0YWlscy52ZXJzaW9uOwogICAgICAgICAgICB2YXIgbWF4dmVyID0gMzM7CiAgICAgICAgICAgIGlmICh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgnTGludXgnKSkgbWF4dmVyID0gMzU7IC8vICJrbm93biIgY3Jhc2ggaW4gY2hyb21lIDM0IGFuZCAzNSBvbiBsaW51eAoKICAgICAgICAgICAgaWYgKGNocm9tZXZlciA+PSAyNiAmJiBjaHJvbWV2ZXIgPD0gbWF4dmVyKSB7CiAgICAgICAgICAgICAgLy8gQ2hyb21lIDI2LT4zMyByZXF1aXJlcyBzb21lIGF3a3dhcmQgY2hyb21lOi8vZmxhZ3MgbWFuaXB1bGF0aW9uCiAgICAgICAgICAgICAgY29uc3RyYWludHMgPSB7CiAgICAgICAgICAgICAgICB2aWRlbzogewogICAgICAgICAgICAgICAgICBtYW5kYXRvcnk6IHsKICAgICAgICAgICAgICAgICAgICBnb29nTGVha3lCdWNrZXQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgbWF4V2lkdGg6IHdpbmRvdy5zY3JlZW4ud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgbWF4SGVpZ2h0OiB3aW5kb3cuc2NyZWVuLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICBtaW5GcmFtZVJhdGU6IG1lZGlhLnNjcmVlbnNoYXJlRnJhbWVSYXRlLAogICAgICAgICAgICAgICAgICAgIG1heEZyYW1lUmF0ZTogbWVkaWEuc2NyZWVuc2hhcmVGcmFtZVJhdGUsCiAgICAgICAgICAgICAgICAgICAgY2hyb21lTWVkaWFTb3VyY2U6ICdzY3JlZW4nCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhdWRpbzogaXNBdWRpb1NlbmRFbmFibGVkKG1lZGlhKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZ2V0U2NyZWVuTWVkaWEoY29uc3RyYWludHMsIGNhbGxiYWNrVXNlck1lZGlhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBDaHJvbWUgMzQrIHJlcXVpcmVzIGFuIGV4dGVuc2lvbgogICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoJ05hdmlnYXRvclVzZXJNZWRpYUVycm9yJyk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gJ1RoZSByZXF1aXJlZCBDaHJvbWUgZXh0ZW5zaW9uIGlzIG5vdCBpbnN0YWxsZWQ6IGNsaWNrIDxhIGhyZWY9IiMiPmhlcmU8L2E+IHRvIGluc3RhbGwgaXQuIChOT1RFOiB0aGlzIHdpbGwgbmVlZCB5b3UgdG8gcmVmcmVzaCB0aGUgcGFnZSknOwogICAgICAgICAgICAgICAgcGx1Z2luSGFuZGxlLmNvbnNlbnREaWFsb2coZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5lcnJvcihlcnJvcik7CiAgICAgICAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgICAgICAgY2FjaGVbcGVuZGluZ10gPSBbY2FsbGJhY2tVc2VyTWVkaWEsIG51bGxdOwogICAgICAgICAgICAgIHdpbmRvdy5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICB0eXBlOiAnamFudXNHZXRTY3JlZW4nLAogICAgICAgICAgICAgICAgaWQ6IHBlbmRpbmcKICAgICAgICAgICAgICB9LCAnKicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKCdGaXJlZm94JykpIHsKICAgICAgICAgICAgdmFyIGZmdmVyID0gcGFyc2VJbnQod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0ZpcmVmb3hcLyguKikvKVsxXSwgMTApOwoKICAgICAgICAgICAgaWYgKGZmdmVyID49IDMzKSB7CiAgICAgICAgICAgICAgLy8gRmlyZWZveCAzMysgaGFzIGV4cGVyaW1lbnRhbCBzdXBwb3J0IGZvciBzY3JlZW4gc2hhcmluZwogICAgICAgICAgICAgIGNvbnN0cmFpbnRzID0gewogICAgICAgICAgICAgICAgdmlkZW86IHsKICAgICAgICAgICAgICAgICAgbW96TWVkaWFTb3VyY2U6IG1lZGlhLnZpZGVvLAogICAgICAgICAgICAgICAgICBtZWRpYVNvdXJjZTogbWVkaWEudmlkZW8KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhdWRpbzogaXNBdWRpb1NlbmRFbmFibGVkKG1lZGlhKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZ2V0U2NyZWVuTWVkaWEoY29uc3RyYWludHMsIGZ1bmN0aW9uIChlcnIsIHN0cmVhbSkgewogICAgICAgICAgICAgICAgY2FsbGJhY2tVc2VyTWVkaWEoZXJyLCBzdHJlYW0pOyAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD0xMDQ1ODEwCgogICAgICAgICAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxhc3RUaW1lID0gc3RyZWFtLmN1cnJlbnRUaW1lOwogICAgICAgICAgICAgICAgICB2YXIgcG9sbHkgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtKSB3aW5kb3cuY2xlYXJJbnRlcnZhbChwb2xseSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uY3VycmVudFRpbWUgPT0gbGFzdFRpbWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHBvbGx5KTsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtLm9uZW5kZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLm9uZW5kZWQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxhc3RUaW1lID0gc3RyZWFtLmN1cnJlbnRUaW1lOwogICAgICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcignTmF2aWdhdG9yVXNlck1lZGlhRXJyb3InKTsKICAgICAgICAgICAgICBlcnJvci5uYW1lID0gJ1lvdXIgdmVyc2lvbiBvZiBGaXJlZm94IGRvZXMgbm90IHN1cHBvcnQgc2NyZWVuIHNoYXJpbmcsIHBsZWFzZSBpbnN0YWxsIEZpcmVmb3ggMzMgKG9yIG1vcmUgcmVjZW50IHZlcnNpb25zKSc7CiAgICAgICAgICAgICAgcGx1Z2luSGFuZGxlLmNvbnNlbnREaWFsb2coZmFsc2UpOwogICAgICAgICAgICAgIGNhbGxiYWNrcy5lcnJvcihlcnJvcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9IC8vIFdhaXQgZm9yIGV2ZW50cyBmcm9tIHRoZSBDaHJvbWUgRXh0ZW5zaW9uCgoKICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC5vcmlnaW4gIT0gd2luZG93LmxvY2F0aW9uLm9yaWdpbikgcmV0dXJuOwoKICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEudHlwZSA9PSAnamFudXNHb3RTY3JlZW4nICYmIGNhY2hlW2V2ZW50LmRhdGEuaWRdKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBjYWNoZVtldmVudC5kYXRhLmlkXTsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBkYXRhWzBdOwogICAgICAgICAgICAgIGRlbGV0ZSBjYWNoZVtldmVudC5kYXRhLmlkXTsKCiAgICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEuc291cmNlSWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAvLyB1c2VyIGNhbmNlbGVkCiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoJ05hdmlnYXRvclVzZXJNZWRpYUVycm9yJyk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gJ1lvdSBjYW5jZWxsZWQgdGhlIHJlcXVlc3QgZm9yIHBlcm1pc3Npb24sIGdpdmluZyB1cC4uLic7CiAgICAgICAgICAgICAgICBwbHVnaW5IYW5kbGUuY29uc2VudERpYWxvZyhmYWxzZSk7CiAgICAgICAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoZXJyb3IpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdHJhaW50cyA9IHsKICAgICAgICAgICAgICAgICAgYXVkaW86IGZhbHNlLAogICAgICAgICAgICAgICAgICB2aWRlbzogewogICAgICAgICAgICAgICAgICAgIG1hbmRhdG9yeTogewogICAgICAgICAgICAgICAgICAgICAgY2hyb21lTWVkaWFTb3VyY2U6ICdkZXNrdG9wJywKICAgICAgICAgICAgICAgICAgICAgIG1heFdpZHRoOiB3aW5kb3cuc2NyZWVuLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgbWF4SGVpZ2h0OiB3aW5kb3cuc2NyZWVuLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgIG1pbkZyYW1lUmF0ZTogbWVkaWEuc2NyZWVuc2hhcmVGcmFtZVJhdGUsCiAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFtZVJhdGU6IG1lZGlhLnNjcmVlbnNoYXJlRnJhbWVSYXRlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvcHRpb25hbDogW3sKICAgICAgICAgICAgICAgICAgICAgIGdvb2dMZWFreUJ1Y2tldDogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgIGdvb2dUZW1wb3JhbExheWVyZWRTY3JlZW5jYXN0OiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfV0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGNvbnN0cmFpbnRzLnZpZGVvLm1hbmRhdG9yeS5jaHJvbWVNZWRpYVNvdXJjZUlkID0gZXZlbnQuZGF0YS5zb3VyY2VJZDsKICAgICAgICAgICAgICAgIGdldFNjcmVlbk1lZGlhKGNvbnN0cmFpbnRzLCBjYWxsYmFjaywgaXNBdWRpb1NlbmRFbmFibGVkKG1lZGlhKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmRhdGEudHlwZSA9PSAnamFudXNHZXRTY3JlZW5QZW5kaW5nJykgewogICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoZXZlbnQuZGF0YS5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSAvLyBJZiB3ZSBnb3QgaGVyZSwgd2UncmUgbm90IHNjcmVlbnNoYXJpbmcKCgogICAgICBpZiAobWVkaWEgPT09IG51bGwgfHwgbWVkaWEgPT09IHVuZGVmaW5lZCB8fCBtZWRpYS52aWRlbyAhPT0gJ3NjcmVlbicpIHsKICAgICAgICAvLyBDaGVjayB3aGV0aGVyIGFsbCBtZWRpYSBzb3VyY2VzIGFyZSBhY3R1YWxseSBhdmFpbGFibGUgb3Igbm90CiAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCkudGhlbihmdW5jdGlvbiAoZGV2aWNlcykgewogICAgICAgICAgdmFyIGF1ZGlvRXhpc3QgPSBkZXZpY2VzLnNvbWUoZnVuY3Rpb24gKGRldmljZSkgewogICAgICAgICAgICByZXR1cm4gZGV2aWNlLmtpbmQgPT09ICdhdWRpb2lucHV0JzsKICAgICAgICAgIH0pLAogICAgICAgICAgICAgIHZpZGVvRXhpc3QgPSBkZXZpY2VzLnNvbWUoZnVuY3Rpb24gKGRldmljZSkgewogICAgICAgICAgICByZXR1cm4gZGV2aWNlLmtpbmQgPT09ICd2aWRlb2lucHV0JzsKICAgICAgICAgIH0pOyAvLyBDaGVjayB3aGV0aGVyIGEgbWlzc2luZyBkZXZpY2UgaXMgcmVhbGx5IGEgcHJvYmxlbQoKICAgICAgICAgIHZhciBhdWRpb1NlbmQgPSBpc0F1ZGlvU2VuZEVuYWJsZWQobWVkaWEpOwogICAgICAgICAgdmFyIHZpZGVvU2VuZCA9IGlzVmlkZW9TZW5kRW5hYmxlZChtZWRpYSk7CiAgICAgICAgICB2YXIgbmVlZEF1ZGlvRGV2aWNlID0gaXNBdWRpb1NlbmRSZXF1aXJlZChtZWRpYSk7CiAgICAgICAgICB2YXIgbmVlZFZpZGVvRGV2aWNlID0gaXNWaWRlb1NlbmRSZXF1aXJlZChtZWRpYSk7CgogICAgICAgICAgaWYgKGF1ZGlvU2VuZCB8fCB2aWRlb1NlbmQgfHwgbmVlZEF1ZGlvRGV2aWNlIHx8IG5lZWRWaWRlb0RldmljZSkgewogICAgICAgICAgICAvLyBXZSBuZWVkIHRvIHNlbmQgZWl0aGVyIGF1ZGlvIG9yIHZpZGVvCiAgICAgICAgICAgIHZhciBoYXZlQXVkaW9EZXZpY2UgPSBhdWRpb1NlbmQgPyBhdWRpb0V4aXN0IDogZmFsc2U7CiAgICAgICAgICAgIHZhciBoYXZlVmlkZW9EZXZpY2UgPSB2aWRlb1NlbmQgPyB2aWRlb0V4aXN0IDogZmFsc2U7CgogICAgICAgICAgICBpZiAoIWhhdmVBdWRpb0RldmljZSAmJiAhaGF2ZVZpZGVvRGV2aWNlKSB7CiAgICAgICAgICAgICAgLy8gRklYTUUgU2hvdWxkIHdlIHJlYWxseSBnaXZlIHVwLCBvciBqdXN0IGFzc3VtZSByZWN2b25seSBmb3IgYm90aD8KICAgICAgICAgICAgICBwbHVnaW5IYW5kbGUuY29uc2VudERpYWxvZyhmYWxzZSk7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLmVycm9yKCdObyBjYXB0dXJlIGRldmljZSBmb3VuZCcpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaGF2ZUF1ZGlvRGV2aWNlICYmIG5lZWRBdWRpb0RldmljZSkgewogICAgICAgICAgICAgIHBsdWdpbkhhbmRsZS5jb25zZW50RGlhbG9nKGZhbHNlKTsKICAgICAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoJ0F1ZGlvIGNhcHR1cmUgaXMgcmVxdWlyZWQsIGJ1dCBubyBjYXB0dXJlIGRldmljZSBmb3VuZCcpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaGF2ZVZpZGVvRGV2aWNlICYmIG5lZWRWaWRlb0RldmljZSkgewogICAgICAgICAgICAgIHBsdWdpbkhhbmRsZS5jb25zZW50RGlhbG9nKGZhbHNlKTsKICAgICAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoJ1ZpZGVvIGNhcHR1cmUgaXMgcmVxdWlyZWQsIGJ1dCBubyBjYXB0dXJlIGRldmljZSBmb3VuZCcpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsKICAgICAgICAgICAgYXVkaW86IGF1ZGlvRXhpc3QgPyBhdWRpb1N1cHBvcnQgOiBmYWxzZSwKICAgICAgICAgICAgdmlkZW86IHZpZGVvRXhpc3QgPyB2aWRlb1N1cHBvcnQgOiBmYWxzZQogICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgICAgICAgIHBsdWdpbkhhbmRsZS5jb25zZW50RGlhbG9nKGZhbHNlKTsKICAgICAgICAgICAgc3RyZWFtc0RvbmUoaGFuZGxlSWQsIGpzZXAsIG1lZGlhLCBjYWxsYmFja3MsIHN0cmVhbSk7CiAgICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgcGx1Z2luSGFuZGxlLmNvbnNlbnREaWFsb2coZmFsc2UpOwogICAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoewogICAgICAgICAgICAgIGNvZGU6IGVycm9yLmNvZGUsCiAgICAgICAgICAgICAgbmFtZTogZXJyb3IubmFtZSwKICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBwbHVnaW5IYW5kbGUuY29uc2VudERpYWxvZyhmYWxzZSk7CiAgICAgICAgICBjYWxsYmFja3MuZXJyb3IoJ2VudW1lcmF0ZURldmljZXMgZXJyb3InLCBlcnJvcik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gZG8gYSBnZXRVc2VyTWVkaWEsIGNyZWF0ZSBvZmZlci9hbnN3ZXIgcmlnaHQgYXdheQogICAgICBzdHJlYW1zRG9uZShoYW5kbGVJZCwganNlcCwgbWVkaWEsIGNhbGxiYWNrcyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcmVwYXJlV2VicnRjUGVlcihoYW5kbGVJZCwgY2FsbGJhY2tzKSB7CiAgICBjYWxsYmFja3MgPSBjYWxsYmFja3MgfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLmVycm9yID0gdHlwZW9mIGNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLmVycm9yIDogd2VicnRjRXJyb3I7CiAgICB2YXIganNlcCA9IGNhbGxiYWNrcy5qc2VwOwogICAgdmFyIHBsdWdpbkhhbmRsZSA9IHBsdWdpbkhhbmRsZXNbaGFuZGxlSWRdOwoKICAgIGlmIChwbHVnaW5IYW5kbGUgPT09IG51bGwgfHwgcGx1Z2luSGFuZGxlID09PSB1bmRlZmluZWQgfHwgcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIEphbnVzLndhcm4oIkludmFsaWQgaGFuZGxlIik7CiAgICAgIGNhbGxiYWNrcy5lcnJvcigiSW52YWxpZCBoYW5kbGUiKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjb25maWcgPSBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmY7CgogICAgaWYgKGpzZXAgIT09IHVuZGVmaW5lZCAmJiBqc2VwICE9PSBudWxsKSB7CiAgICAgIGlmIChjb25maWcucGMgPT09IG51bGwpIHsKICAgICAgICBKYW51cy53YXJuKCJXYWl0LCBubyBQZWVyQ29ubmVjdGlvbj8/IGlmIHRoaXMgaXMgYW4gYW5zd2VyLCB1c2UgY3JlYXRlQW5zd2VyIGFuZCBub3QgaGFuZGxlUmVtb3RlSnNlcCIpOwogICAgICAgIGNhbGxiYWNrcy5lcnJvcigiTm8gUGVlckNvbm5lY3Rpb246IGlmIHRoaXMgaXMgYW4gYW5zd2VyLCB1c2UgY3JlYXRlQW5zd2VyIGFuZCBub3QgaGFuZGxlUmVtb3RlSnNlcCIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PT0gImVkZ2UiKSB7CiAgICAgICAgLy8gVGhpcyBpcyBFZGdlLCBhZGQgYW4gYT1lbmQtb2YtY2FuZGlkYXRlcyBhdCB0aGUgZW5kCiAgICAgICAganNlcC5zZHAgKz0gImE9ZW5kLW9mLWNhbmRpZGF0ZXNcclxuIjsKICAgICAgfQoKICAgICAgY29uZmlnLnBjLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24oanNlcCksIGZ1bmN0aW9uICgpIHsKICAgICAgICBKYW51cy5sb2coIlJlbW90ZSBkZXNjcmlwdGlvbiBhY2NlcHRlZCEiKTsKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgICB9LCBjYWxsYmFja3MuZXJyb3IpOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2tzLmVycm9yKCJJbnZhbGlkIEpTRVAiKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZU9mZmVyKGhhbmRsZUlkLCBtZWRpYSwgY2FsbGJhY2tzKSB7CiAgICBjYWxsYmFja3MgPSBjYWxsYmFja3MgfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLmVycm9yID0gdHlwZW9mIGNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLmVycm9yIDogSmFudXMubm9vcDsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICBjYWxsYmFja3MuZXJyb3IoIkludmFsaWQgaGFuZGxlIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY29uZmlnID0gcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmOwogICAgSmFudXMubG9nKCJDcmVhdGluZyBvZmZlciAoaWNlRG9uZT0iICsgY29uZmlnLmljZURvbmUgKyAiKSIpOyAvLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL3dlYnJ0Yy9pc3N1ZXMvZGV0YWlsP2lkPTM1MDgKCiAgICB2YXIgbWVkaWFDb25zdHJhaW50cyA9IG51bGw7CgogICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PSAiZmlyZWZveCIgfHwgYWRhcHRlci5icm93c2VyRGV0YWlscy5icm93c2VyID09ICJlZGdlIikgewogICAgICBtZWRpYUNvbnN0cmFpbnRzID0gewogICAgICAgICdvZmZlclRvUmVjZWl2ZUF1ZGlvJzogaXNBdWRpb1JlY3ZFbmFibGVkKG1lZGlhKSwKICAgICAgICAnb2ZmZXJUb1JlY2VpdmVWaWRlbyc6IGlzVmlkZW9SZWN2RW5hYmxlZChtZWRpYSkKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIG1lZGlhQ29uc3RyYWludHMgPSB7CiAgICAgICAgJ21hbmRhdG9yeSc6IHsKICAgICAgICAgICdPZmZlclRvUmVjZWl2ZUF1ZGlvJzogaXNBdWRpb1JlY3ZFbmFibGVkKG1lZGlhKSwKICAgICAgICAgICdPZmZlclRvUmVjZWl2ZVZpZGVvJzogaXNWaWRlb1JlY3ZFbmFibGVkKG1lZGlhKQogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICBKYW51cy5kZWJ1ZyhtZWRpYUNvbnN0cmFpbnRzKTsKICAgIGNvbmZpZy5wYy5jcmVhdGVPZmZlcihmdW5jdGlvbiAob2ZmZXIpIHsKICAgICAgSmFudXMuZGVidWcob2ZmZXIpOwoKICAgICAgaWYgKGNvbmZpZy5teVNkcCA9PT0gbnVsbCB8fCBjb25maWcubXlTZHAgPT09IHVuZGVmaW5lZCkgewogICAgICAgIEphbnVzLmxvZygiU2V0dGluZyBsb2NhbCBkZXNjcmlwdGlvbiIpOwogICAgICAgIGNvbmZpZy5teVNkcCA9IG9mZmVyLnNkcDsKICAgICAgICBjb25maWcucGMuc2V0TG9jYWxEZXNjcmlwdGlvbihvZmZlcik7CiAgICAgIH0KCiAgICAgIGlmICghY29uZmlnLmljZURvbmUgJiYgIWNvbmZpZy50cmlja2xlKSB7CiAgICAgICAgLy8gRG9uJ3QgZG8gYW55dGhpbmcgdW50aWwgd2UgaGF2ZSBhbGwgY2FuZGlkYXRlcwogICAgICAgIEphbnVzLmxvZygiV2FpdGluZyBmb3IgYWxsIGNhbmRpZGF0ZXMuLi4iKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChjb25maWcuc2RwU2VudCkgewogICAgICAgIEphbnVzLmxvZygiT2ZmZXIgYWxyZWFkeSBzZW50LCBub3Qgc2VuZGluZyBpdCBhZ2FpbiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgSmFudXMubG9nKCJPZmZlciByZWFkeSIpOwogICAgICBKYW51cy5kZWJ1ZyhjYWxsYmFja3MpOwogICAgICBjb25maWcuc2RwU2VudCA9IHRydWU7IC8vIEpTT04uc3RyaW5naWZ5IGRvZXNuJ3Qgd29yayBvbiBzb21lIFdlYlJUQyBvYmplY3RzIGFueW1vcmUKICAgICAgLy8gU2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NjczNjYKCiAgICAgIHZhciBqc2VwID0gewogICAgICAgICJ0eXBlIjogb2ZmZXIudHlwZSwKICAgICAgICAic2RwIjogb2ZmZXIuc2RwCiAgICAgIH07CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGpzZXApOwogICAgfSwgY2FsbGJhY2tzLmVycm9yLCBtZWRpYUNvbnN0cmFpbnRzKTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUFuc3dlcihoYW5kbGVJZCwgbWVkaWEsIGNhbGxiYWNrcykgewogICAgY2FsbGJhY2tzID0gY2FsbGJhY2tzIHx8IHt9OwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MgPSB0eXBlb2YgY2FsbGJhY2tzLnN1Y2Nlc3MgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5zdWNjZXNzIDogSmFudXMubm9vcDsKICAgIGNhbGxiYWNrcy5lcnJvciA9IHR5cGVvZiBjYWxsYmFja3MuZXJyb3IgPT0gImZ1bmN0aW9uIiA/IGNhbGxiYWNrcy5lcnJvciA6IEphbnVzLm5vb3A7CiAgICB2YXIgcGx1Z2luSGFuZGxlID0gcGx1Z2luSGFuZGxlc1toYW5kbGVJZF07CgogICAgaWYgKHBsdWdpbkhhbmRsZSA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUgPT09IHVuZGVmaW5lZCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IG51bGwgfHwgcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmID09PSB1bmRlZmluZWQpIHsKICAgICAgSmFudXMud2FybigiSW52YWxpZCBoYW5kbGUiKTsKICAgICAgY2FsbGJhY2tzLmVycm9yKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNvbmZpZyA9IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZjsKICAgIEphbnVzLmxvZygiQ3JlYXRpbmcgYW5zd2VyIChpY2VEb25lPSIgKyBjb25maWcuaWNlRG9uZSArICIpIik7CiAgICB2YXIgbWVkaWFDb25zdHJhaW50cyA9IG51bGw7CgogICAgaWYgKGFkYXB0ZXIuYnJvd3NlckRldGFpbHMuYnJvd3NlciA9PSAiZmlyZWZveCIgfHwgYWRhcHRlci5icm93c2VyRGV0YWlscy5icm93c2VyID09ICJlZGdlIikgewogICAgICBtZWRpYUNvbnN0cmFpbnRzID0gewogICAgICAgICdvZmZlclRvUmVjZWl2ZUF1ZGlvJzogaXNBdWRpb1JlY3ZFbmFibGVkKG1lZGlhKSwKICAgICAgICAnb2ZmZXJUb1JlY2VpdmVWaWRlbyc6IGlzVmlkZW9SZWN2RW5hYmxlZChtZWRpYSkKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIG1lZGlhQ29uc3RyYWludHMgPSB7CiAgICAgICAgJ21hbmRhdG9yeSc6IHsKICAgICAgICAgICdPZmZlclRvUmVjZWl2ZUF1ZGlvJzogaXNBdWRpb1JlY3ZFbmFibGVkKG1lZGlhKSwKICAgICAgICAgICdPZmZlclRvUmVjZWl2ZVZpZGVvJzogaXNWaWRlb1JlY3ZFbmFibGVkKG1lZGlhKQogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICBKYW51cy5kZWJ1ZyhtZWRpYUNvbnN0cmFpbnRzKTsKICAgIGNvbmZpZy5wYy5jcmVhdGVBbnN3ZXIoZnVuY3Rpb24gKGFuc3dlcikgewogICAgICBKYW51cy5kZWJ1ZyhhbnN3ZXIpOwoKICAgICAgaWYgKGNvbmZpZy5teVNkcCA9PT0gbnVsbCB8fCBjb25maWcubXlTZHAgPT09IHVuZGVmaW5lZCkgewogICAgICAgIEphbnVzLmxvZygiU2V0dGluZyBsb2NhbCBkZXNjcmlwdGlvbiIpOwogICAgICAgIGNvbmZpZy5teVNkcCA9IGFuc3dlci5zZHA7CiAgICAgICAgY29uZmlnLnBjLnNldExvY2FsRGVzY3JpcHRpb24oYW5zd2VyKTsKICAgICAgfQoKICAgICAgaWYgKCFjb25maWcuaWNlRG9uZSAmJiAhY29uZmlnLnRyaWNrbGUpIHsKICAgICAgICAvLyBEb24ndCBkbyBhbnl0aGluZyB1bnRpbCB3ZSBoYXZlIGFsbCBjYW5kaWRhdGVzCiAgICAgICAgSmFudXMubG9nKCJXYWl0aW5nIGZvciBhbGwgY2FuZGlkYXRlcy4uLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGNvbmZpZy5zZHBTZW50KSB7CiAgICAgICAgLy8gRklYTUUgYmFkbHkKICAgICAgICBKYW51cy5sb2coIkFuc3dlciBhbHJlYWR5IHNlbnQsIG5vdCBzZW5kaW5nIGl0IGFnYWluIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25maWcuc2RwU2VudCA9IHRydWU7IC8vIEpTT04uc3RyaW5naWZ5IGRvZXNuJ3Qgd29yayBvbiBzb21lIFdlYlJUQyBvYmplY3RzIGFueW1vcmUKICAgICAgLy8gU2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NjczNjYKCiAgICAgIHZhciBqc2VwID0gewogICAgICAgICJ0eXBlIjogYW5zd2VyLnR5cGUsCiAgICAgICAgInNkcCI6IGFuc3dlci5zZHAKICAgICAgfTsKICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoanNlcCk7CiAgICB9LCBjYWxsYmFja3MuZXJyb3IsIG1lZGlhQ29uc3RyYWludHMpOwogIH0KCiAgZnVuY3Rpb24gc2VuZFNEUChoYW5kbGVJZCwgY2FsbGJhY2tzKSB7CiAgICBjYWxsYmFja3MgPSBjYWxsYmFja3MgfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IHR5cGVvZiBjYWxsYmFja3Muc3VjY2VzcyA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLnN1Y2Nlc3MgOiBKYW51cy5ub29wOwogICAgY2FsbGJhY2tzLmVycm9yID0gdHlwZW9mIGNhbGxiYWNrcy5lcnJvciA9PSAiZnVuY3Rpb24iID8gY2FsbGJhY2tzLmVycm9yIDogSmFudXMubm9vcDsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSwgbm90IHNlbmRpbmcgYW55dGhpbmciKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjb25maWcgPSBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmY7CiAgICBKYW51cy5sb2coIlNlbmRpbmcgb2ZmZXIvYW5zd2VyIFNEUC4uLiIpOwoKICAgIGlmIChjb25maWcubXlTZHAgPT09IG51bGwgfHwgY29uZmlnLm15U2RwID09PSB1bmRlZmluZWQpIHsKICAgICAgSmFudXMud2FybigiTG9jYWwgU0RQIGluc3RhbmNlIGlzIGludmFsaWQsIG5vdCBzZW5kaW5nIGFueXRoaW5nLi4uIik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25maWcubXlTZHAgPSB7CiAgICAgICJ0eXBlIjogY29uZmlnLnBjLmxvY2FsRGVzY3JpcHRpb24udHlwZSwKICAgICAgInNkcCI6IGNvbmZpZy5wYy5sb2NhbERlc2NyaXB0aW9uLnNkcAogICAgfTsKCiAgICBpZiAoY29uZmlnLnNkcFNlbnQpIHsKICAgICAgSmFudXMubG9nKCJPZmZlci9BbnN3ZXIgU0RQIGFscmVhZHkgc2VudCwgbm90IHNlbmRpbmcgaXQgYWdhaW4iKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChjb25maWcudHJpY2tsZSA9PT0gZmFsc2UpIGNvbmZpZy5teVNkcFsidHJpY2tsZSJdID0gZmFsc2U7CiAgICBKYW51cy5kZWJ1ZyhjYWxsYmFja3MpOwogICAgY29uZmlnLnNkcFNlbnQgPSB0cnVlOwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MoY29uZmlnLm15U2RwKTsKICB9CgogIGZ1bmN0aW9uIF9nZXRWb2x1bWUoaGFuZGxlSWQpIHsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICB2YXIgY29uZmlnID0gcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmOyAvLyBTdGFydCBnZXR0aW5nIHRoZSB2b2x1bWUsIGlmIGdldFN0YXRzIGlzIHN1cHBvcnRlZAoKICAgIGlmIChjb25maWcucGMuZ2V0U3RhdHMgJiYgYWRhcHRlci5icm93c2VyRGV0YWlscy5icm93c2VyID09ICJjaHJvbWUiKSB7CiAgICAgIC8vIEZJWE1FCiAgICAgIGlmIChjb25maWcucmVtb3RlU3RyZWFtID09PSBudWxsIHx8IGNvbmZpZy5yZW1vdGVTdHJlYW0gPT09IHVuZGVmaW5lZCkgewogICAgICAgIEphbnVzLndhcm4oIlJlbW90ZSBzdHJlYW0gdW5hdmFpbGFibGUiKTsKICAgICAgICByZXR1cm4gMDsKICAgICAgfSAvLyBodHRwOi8vd2VicnRjLmdvb2dsZWNvZGUuY29tL3N2bi90cnVuay9zYW1wbGVzL2pzL2RlbW9zL2h0bWwvY29uc3RyYWludHMtYW5kLXN0YXRzLmh0bWwKCgogICAgICBpZiAoY29uZmlnLnZvbHVtZS50aW1lciA9PT0gbnVsbCB8fCBjb25maWcudm9sdW1lLnRpbWVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICBKYW51cy5sb2coIlN0YXJ0aW5nIHZvbHVtZSBtb25pdG9yIik7CiAgICAgICAgY29uZmlnLnZvbHVtZS50aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbmZpZy5wYy5nZXRTdGF0cyhmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBzdGF0cy5yZXN1bHQoKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciByZXMgPSByZXN1bHRzW2ldOwoKICAgICAgICAgICAgICBpZiAocmVzLnR5cGUgPT0gJ3NzcmMnICYmIHJlcy5zdGF0KCdhdWRpb091dHB1dExldmVsJykpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy52b2x1bWUudmFsdWUgPSByZXMuc3RhdCgnYXVkaW9PdXRwdXRMZXZlbCcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwgMjAwKTsKICAgICAgICByZXR1cm4gMDsgLy8gV2UgZG9uJ3QgaGF2ZSBhIHZvbHVtZSB0byByZXR1cm4geWV0CiAgICAgIH0KCiAgICAgIHJldHVybiBjb25maWcudm9sdW1lLnZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgSmFudXMubG9nKCJHZXR0aW5nIHRoZSByZW1vdGUgdm9sdW1lIHVuc3VwcG9ydGVkIGJ5IGJyb3dzZXIiKTsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc011dGVkKGhhbmRsZUlkLCB2aWRlbykgewogICAgdmFyIHBsdWdpbkhhbmRsZSA9IHBsdWdpbkhhbmRsZXNbaGFuZGxlSWRdOwoKICAgIGlmIChwbHVnaW5IYW5kbGUgPT09IG51bGwgfHwgcGx1Z2luSGFuZGxlID09PSB1bmRlZmluZWQgfHwgcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIEphbnVzLndhcm4oIkludmFsaWQgaGFuZGxlIik7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciBjb25maWcgPSBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmY7CgogICAgaWYgKGNvbmZpZy5wYyA9PT0gbnVsbCB8fCBjb25maWcucGMgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIFBlZXJDb25uZWN0aW9uIik7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGlmIChjb25maWcubXlTdHJlYW0gPT09IHVuZGVmaW5lZCB8fCBjb25maWcubXlTdHJlYW0gPT09IG51bGwpIHsKICAgICAgSmFudXMud2FybigiSW52YWxpZCBsb2NhbCBNZWRpYVN0cmVhbSIpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBpZiAodmlkZW8pIHsKICAgICAgLy8gQ2hlY2sgdmlkZW8gdHJhY2sKICAgICAgaWYgKGNvbmZpZy5teVN0cmVhbS5nZXRWaWRlb1RyYWNrcygpID09PSBudWxsIHx8IGNvbmZpZy5teVN0cmVhbS5nZXRWaWRlb1RyYWNrcygpID09PSB1bmRlZmluZWQgfHwgY29uZmlnLm15U3RyZWFtLmdldFZpZGVvVHJhY2tzKCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgSmFudXMud2FybigiTm8gdmlkZW8gdHJhY2siKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuICFjb25maWcubXlTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKVswXS5lbmFibGVkOwogICAgfSBlbHNlIHsKICAgICAgLy8gQ2hlY2sgYXVkaW8gdHJhY2sKICAgICAgaWYgKGNvbmZpZy5teVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpID09PSBudWxsIHx8IGNvbmZpZy5teVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpID09PSB1bmRlZmluZWQgfHwgY29uZmlnLm15U3RyZWFtLmdldEF1ZGlvVHJhY2tzKCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgSmFudXMud2FybigiTm8gYXVkaW8gdHJhY2siKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuICFjb25maWcubXlTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXS5lbmFibGVkOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbXV0ZShoYW5kbGVJZCwgdmlkZW8sIG11dGUpIHsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdmFyIGNvbmZpZyA9IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZjsKCiAgICBpZiAoY29uZmlnLnBjID09PSBudWxsIHx8IGNvbmZpZy5wYyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIEphbnVzLndhcm4oIkludmFsaWQgUGVlckNvbm5lY3Rpb24iKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmIChjb25maWcubXlTdHJlYW0gPT09IHVuZGVmaW5lZCB8fCBjb25maWcubXlTdHJlYW0gPT09IG51bGwpIHsKICAgICAgSmFudXMud2FybigiSW52YWxpZCBsb2NhbCBNZWRpYVN0cmVhbSIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKHZpZGVvKSB7CiAgICAgIC8vIE11dGUvdW5tdXRlIHZpZGVvIHRyYWNrCiAgICAgIGlmIChjb25maWcubXlTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKSA9PT0gbnVsbCB8fCBjb25maWcubXlTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKSA9PT0gdW5kZWZpbmVkIHx8IGNvbmZpZy5teVN0cmVhbS5nZXRWaWRlb1RyYWNrcygpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIEphbnVzLndhcm4oIk5vIHZpZGVvIHRyYWNrIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBjb25maWcubXlTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKVswXS5lbmFibGVkID0gbXV0ZSA/IGZhbHNlIDogdHJ1ZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICAvLyBNdXRlL3VubXV0ZSBhdWRpbyB0cmFjawogICAgICBpZiAoY29uZmlnLm15U3RyZWFtLmdldEF1ZGlvVHJhY2tzKCkgPT09IG51bGwgfHwgY29uZmlnLm15U3RyZWFtLmdldEF1ZGlvVHJhY2tzKCkgPT09IHVuZGVmaW5lZCB8fCBjb25maWcubXlTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKS5sZW5ndGggPT09IDApIHsKICAgICAgICBKYW51cy53YXJuKCJObyBhdWRpbyB0cmFjayIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgY29uZmlnLm15U3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF0uZW5hYmxlZCA9IG11dGUgPyBmYWxzZSA6IHRydWU7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gX2dldEJpdHJhdGUoaGFuZGxlSWQpIHsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkIHx8IHBsdWdpbkhhbmRsZS53ZWJydGNTdHVmZiA9PT0gbnVsbCB8fCBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmYgPT09IHVuZGVmaW5lZCkgewogICAgICBKYW51cy53YXJuKCJJbnZhbGlkIGhhbmRsZSIpOwogICAgICByZXR1cm4gIkludmFsaWQgaGFuZGxlIjsKICAgIH0KCiAgICB2YXIgY29uZmlnID0gcGx1Z2luSGFuZGxlLndlYnJ0Y1N0dWZmOwogICAgaWYgKGNvbmZpZy5wYyA9PT0gbnVsbCB8fCBjb25maWcucGMgPT09IHVuZGVmaW5lZCkgcmV0dXJuICJJbnZhbGlkIFBlZXJDb25uZWN0aW9uIjsgLy8gU3RhcnQgZ2V0dGluZyB0aGUgYml0cmF0ZSwgaWYgZ2V0U3RhdHMgaXMgc3VwcG9ydGVkCgogICAgaWYgKGNvbmZpZy5wYy5nZXRTdGF0cyAmJiBhZGFwdGVyLmJyb3dzZXJEZXRhaWxzLmJyb3dzZXIgPT0gImNocm9tZSIpIHsKICAgICAgLy8gRG8gaXQgdGhlIENocm9tZSB3YXkKICAgICAgaWYgKGNvbmZpZy5yZW1vdGVTdHJlYW0gPT09IG51bGwgfHwgY29uZmlnLnJlbW90ZVN0cmVhbSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgSmFudXMud2FybigiUmVtb3RlIHN0cmVhbSB1bmF2YWlsYWJsZSIpOwogICAgICAgIHJldHVybiAiUmVtb3RlIHN0cmVhbSB1bmF2YWlsYWJsZSI7CiAgICAgIH0gLy8gaHR0cDovL3dlYnJ0Yy5nb29nbGVjb2RlLmNvbS9zdm4vdHJ1bmsvc2FtcGxlcy9qcy9kZW1vcy9odG1sL2NvbnN0cmFpbnRzLWFuZC1zdGF0cy5odG1sCgoKICAgICAgaWYgKGNvbmZpZy5iaXRyYXRlLnRpbWVyID09PSBudWxsIHx8IGNvbmZpZy5iaXRyYXRlLnRpbWVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICBKYW51cy5sb2coIlN0YXJ0aW5nIGJpdHJhdGUgdGltZXIgKENocm9tZSkiKTsKICAgICAgICBjb25maWcuYml0cmF0ZS50aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbmZpZy5wYy5nZXRTdGF0cyhmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBzdGF0cy5yZXN1bHQoKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciByZXMgPSByZXN1bHRzW2ldOwoKICAgICAgICAgICAgICBpZiAocmVzLnR5cGUgPT0gJ3NzcmMnICYmIHJlcy5zdGF0KCdnb29nRnJhbWVIZWlnaHRSZWNlaXZlZCcpKSB7CiAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS5ic25vdyA9IHJlcy5zdGF0KCdieXRlc1JlY2VpdmVkJyk7CiAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS50c25vdyA9IHJlcy50aW1lc3RhbXA7CgogICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5iaXRyYXRlLmJzYmVmb3JlID09PSBudWxsIHx8IGNvbmZpZy5iaXRyYXRlLnRzYmVmb3JlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIC8vIFNraXAgdGhpcyByb3VuZAogICAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS5ic2JlZm9yZSA9IGNvbmZpZy5iaXRyYXRlLmJzbm93OwogICAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS50c2JlZm9yZSA9IGNvbmZpZy5iaXRyYXRlLnRzbm93OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGJpdHJhdGUKICAgICAgICAgICAgICAgICAgdmFyIGJpdFJhdGUgPSBNYXRoLnJvdW5kKChjb25maWcuYml0cmF0ZS5ic25vdyAtIGNvbmZpZy5iaXRyYXRlLmJzYmVmb3JlKSAqIDggLyAoY29uZmlnLmJpdHJhdGUudHNub3cgLSBjb25maWcuYml0cmF0ZS50c2JlZm9yZSkpOwogICAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS52YWx1ZSA9IGJpdFJhdGUgKyAnIGtiaXRzL3NlYyc7IC8vfiBKYW51cy5sb2coIkVzdGltYXRlZCBiaXRyYXRlIGlzICIgKyBjb25maWcuYml0cmF0ZS52YWx1ZSk7CgogICAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS5ic2JlZm9yZSA9IGNvbmZpZy5iaXRyYXRlLmJzbm93OwogICAgICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS50c2JlZm9yZSA9IGNvbmZpZy5iaXRyYXRlLnRzbm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgcmV0dXJuICIwIGtiaXRzL3NlYyI7IC8vIFdlIGRvbid0IGhhdmUgYSBiaXRyYXRlIHZhbHVlIHlldAogICAgICB9CgogICAgICByZXR1cm4gY29uZmlnLmJpdHJhdGUudmFsdWU7CiAgICB9IGVsc2UgaWYgKGNvbmZpZy5wYy5nZXRTdGF0cyAmJiBhZGFwdGVyLmJyb3dzZXJEZXRhaWxzLmJyb3dzZXIgPT0gImZpcmVmb3giKSB7CiAgICAgIC8vIERvIGl0IHRoZSBGaXJlZm94IHdheQogICAgICBpZiAoY29uZmlnLnJlbW90ZVN0cmVhbSA9PT0gbnVsbCB8fCBjb25maWcucmVtb3RlU3RyZWFtID09PSB1bmRlZmluZWQgfHwgY29uZmlnLnJlbW90ZVN0cmVhbS5zdHJlYW1zWzBdID09PSBudWxsIHx8IGNvbmZpZy5yZW1vdGVTdHJlYW0uc3RyZWFtc1swXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgSmFudXMud2FybigiUmVtb3RlIHN0cmVhbSB1bmF2YWlsYWJsZSIpOwogICAgICAgIHJldHVybiAiUmVtb3RlIHN0cmVhbSB1bmF2YWlsYWJsZSI7CiAgICAgIH0KCiAgICAgIHZhciB2aWRlb1RyYWNrcyA9IGNvbmZpZy5yZW1vdGVTdHJlYW0uc3RyZWFtc1swXS5nZXRWaWRlb1RyYWNrcygpOwoKICAgICAgaWYgKHZpZGVvVHJhY2tzID09PSBudWxsIHx8IHZpZGVvVHJhY2tzID09PSB1bmRlZmluZWQgfHwgdmlkZW9UcmFja3MubGVuZ3RoIDwgMSkgewogICAgICAgIEphbnVzLndhcm4oIk5vIHZpZGVvIHRyYWNrIik7CiAgICAgICAgcmV0dXJuICJObyB2aWRlbyB0cmFjayI7CiAgICAgIH0gLy8gaHR0cHM6Ly9naXRodWIuY29tL211YXota2hhbi9nZXRTdGF0cy9ibG9iL21hc3Rlci9nZXRTdGF0cy5qcwoKCiAgICAgIGlmIChjb25maWcuYml0cmF0ZS50aW1lciA9PT0gbnVsbCB8fCBjb25maWcuYml0cmF0ZS50aW1lciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgSmFudXMubG9nKCJTdGFydGluZyBiaXRyYXRlIHRpbWVyIChGaXJlZm94KSIpOwogICAgICAgIGNvbmZpZy5iaXRyYXRlLnRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gV2UgbmVlZCBhIGhlbHBlciBjYWxsYmFjawogICAgICAgICAgdmFyIGNiID0gZnVuY3Rpb24gY2IocmVzKSB7CiAgICAgICAgICAgIGlmIChyZXMgPT09IG51bGwgfHwgcmVzID09PSB1bmRlZmluZWQgfHwgcmVzLmluYm91bmRfcnRwX3ZpZGVvXzEgPT0gbnVsbCB8fCByZXMuaW5ib3VuZF9ydHBfdmlkZW9fMSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29uZmlnLmJpdHJhdGUudmFsdWUgPSAiTWlzc2luZyBpbmJvdW5kX3J0cF92aWRlb18xIjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbmZpZy5iaXRyYXRlLmJzbm93ID0gcmVzLmluYm91bmRfcnRwX3ZpZGVvXzEuYnl0ZXNSZWNlaXZlZDsKICAgICAgICAgICAgY29uZmlnLmJpdHJhdGUudHNub3cgPSByZXMuaW5ib3VuZF9ydHBfdmlkZW9fMS50aW1lc3RhbXA7CgogICAgICAgICAgICBpZiAoY29uZmlnLmJpdHJhdGUuYnNiZWZvcmUgPT09IG51bGwgfHwgY29uZmlnLmJpdHJhdGUudHNiZWZvcmUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAvLyBTa2lwIHRoaXMgcm91bmQKICAgICAgICAgICAgICBjb25maWcuYml0cmF0ZS5ic2JlZm9yZSA9IGNvbmZpZy5iaXRyYXRlLmJzbm93OwogICAgICAgICAgICAgIGNvbmZpZy5iaXRyYXRlLnRzYmVmb3JlID0gY29uZmlnLmJpdHJhdGUudHNub3c7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGJpdHJhdGUKICAgICAgICAgICAgICB2YXIgYml0UmF0ZSA9IE1hdGgucm91bmQoKGNvbmZpZy5iaXRyYXRlLmJzbm93IC0gY29uZmlnLmJpdHJhdGUuYnNiZWZvcmUpICogOCAvIChjb25maWcuYml0cmF0ZS50c25vdyAtIGNvbmZpZy5iaXRyYXRlLnRzYmVmb3JlKSk7CiAgICAgICAgICAgICAgY29uZmlnLmJpdHJhdGUudmFsdWUgPSBiaXRSYXRlICsgJyBrYml0cy9zZWMnOwogICAgICAgICAgICAgIGNvbmZpZy5iaXRyYXRlLmJzYmVmb3JlID0gY29uZmlnLmJpdHJhdGUuYnNub3c7CiAgICAgICAgICAgICAgY29uZmlnLmJpdHJhdGUudHNiZWZvcmUgPSBjb25maWcuYml0cmF0ZS50c25vdzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsgLy8gQWN0dWFsbHkgZ2V0IHRoZSBzdGF0cwoKCiAgICAgICAgICBjb25maWcucGMuZ2V0U3RhdHModmlkZW9UcmFja3NbMF0sIGZ1bmN0aW9uIChzdGF0cykgewogICAgICAgICAgICBjYihzdGF0cyk7CiAgICAgICAgICB9LCBjYik7CiAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgcmV0dXJuICIwIGtiaXRzL3NlYyI7IC8vIFdlIGRvbid0IGhhdmUgYSBiaXRyYXRlIHZhbHVlIHlldAogICAgICB9CgogICAgICByZXR1cm4gY29uZmlnLmJpdHJhdGUudmFsdWU7CiAgICB9IGVsc2UgewogICAgICBKYW51cy53YXJuKCJHZXR0aW5nIHRoZSB2aWRlbyBiaXRyYXRlIHVuc3VwcG9ydGVkIGJ5IGJyb3dzZXIiKTsKICAgICAgcmV0dXJuICJGZWF0dXJlIHVuc3VwcG9ydGVkIGJ5IGJyb3dzZXIiOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd2VicnRjRXJyb3IoZXJyb3IpIHsKICAgIEphbnVzLmVycm9yKCJXZWJSVEMgZXJyb3I6IiwgZXJyb3IpOwogIH0KCiAgZnVuY3Rpb24gY2xlYW51cFdlYnJ0YyhoYW5kbGVJZCwgaGFuZ3VwUmVxdWVzdCkgewogICAgSmFudXMubG9nKCJDbGVhbmluZyBXZWJSVEMgc3R1ZmYiKTsKICAgIHZhciBwbHVnaW5IYW5kbGUgPSBwbHVnaW5IYW5kbGVzW2hhbmRsZUlkXTsKCiAgICBpZiAocGx1Z2luSGFuZGxlID09PSBudWxsIHx8IHBsdWdpbkhhbmRsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIE5vdGhpbmcgdG8gY2xlYW4KICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjb25maWcgPSBwbHVnaW5IYW5kbGUud2VicnRjU3R1ZmY7CgogICAgaWYgKGNvbmZpZyAhPT0gbnVsbCAmJiBjb25maWcgIT09IHVuZGVmaW5lZCkgewogICAgICBpZiAoaGFuZ3VwUmVxdWVzdCA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFNlbmQgYSBoYW5ndXAgcmVxdWVzdCAod2UgZG9uJ3QgcmVhbGx5IGNhcmUgYWJvdXQgdGhlIHJlc3BvbnNlKQogICAgICAgIHZhciByZXF1ZXN0ID0gewogICAgICAgICAgImphbnVzIjogImhhbmd1cCIsCiAgICAgICAgICAidHJhbnNhY3Rpb24iOiBKYW51cy5yYW5kb21TdHJpbmcoMTIpCiAgICAgICAgfTsKICAgICAgICBpZiAodG9rZW4gIT09IG51bGwgJiYgdG9rZW4gIT09IHVuZGVmaW5lZCkgcmVxdWVzdFsidG9rZW4iXSA9IHRva2VuOwogICAgICAgIGlmIChhcGlzZWNyZXQgIT09IG51bGwgJiYgYXBpc2VjcmV0ICE9PSB1bmRlZmluZWQpIHJlcXVlc3RbImFwaXNlY3JldCJdID0gYXBpc2VjcmV0OwogICAgICAgIEphbnVzLmRlYnVnKCJTZW5kaW5nIGhhbmd1cCByZXF1ZXN0IChoYW5kbGU9IiArIGhhbmRsZUlkICsgIik6Iik7CiAgICAgICAgSmFudXMuZGVidWcocmVxdWVzdCk7CgogICAgICAgIGlmICh3ZWJzb2NrZXRzKSB7CiAgICAgICAgICByZXF1ZXN0WyJzZXNzaW9uX2lkIl0gPSBzZXNzaW9uSWQ7CiAgICAgICAgICByZXF1ZXN0WyJoYW5kbGVfaWQiXSA9IGhhbmRsZUlkOwogICAgICAgICAgd3Muc2VuZChKU09OLnN0cmluZ2lmeShyZXF1ZXN0KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIEphbnVzLmFqYXgoewogICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgIHVybDogc2VydmVyICsgIi8iICsgc2Vzc2lvbklkICsgIi8iICsgaGFuZGxlSWQsCiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzLAogICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpLAogICAgICAgICAgICBkYXRhVHlwZTogImpzb24iCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gLy8gQ2xlYW51cCBzdGFjawoKCiAgICAgIGNvbmZpZy5yZW1vdGVTdHJlYW0gPSBudWxsOwogICAgICBpZiAoY29uZmlnLnZvbHVtZS50aW1lcikgY2xlYXJJbnRlcnZhbChjb25maWcudm9sdW1lLnRpbWVyKTsKICAgICAgY29uZmlnLnZvbHVtZS52YWx1ZSA9IG51bGw7CiAgICAgIGlmIChjb25maWcuYml0cmF0ZS50aW1lcikgY2xlYXJJbnRlcnZhbChjb25maWcuYml0cmF0ZS50aW1lcik7CiAgICAgIGNvbmZpZy5iaXRyYXRlLnRpbWVyID0gbnVsbDsKICAgICAgY29uZmlnLmJpdHJhdGUuYnNub3cgPSBudWxsOwogICAgICBjb25maWcuYml0cmF0ZS5ic2JlZm9yZSA9IG51bGw7CiAgICAgIGNvbmZpZy5iaXRyYXRlLnRzbm93ID0gbnVsbDsKICAgICAgY29uZmlnLmJpdHJhdGUudHNiZWZvcmUgPSBudWxsOwogICAgICBjb25maWcuYml0cmF0ZS52YWx1ZSA9IG51bGw7CgogICAgICB0cnkgewogICAgICAgIC8vIFRyeSBhIE1lZGlhU3RyZWFtLnN0b3AoKSBmaXJzdAogICAgICAgIGlmICghY29uZmlnLnN0cmVhbUV4dGVybmFsICYmIGNvbmZpZy5teVN0cmVhbSAhPT0gbnVsbCAmJiBjb25maWcubXlTdHJlYW0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgSmFudXMubG9nKCJTdG9wcGluZyBsb2NhbCBzdHJlYW0iKTsKICAgICAgICAgIGNvbmZpZy5teVN0cmVhbS5zdG9wKCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7Ly8gRG8gbm90aGluZyBpZiB0aGlzIGZhaWxzCiAgICAgIH0KCiAgICAgIHRyeSB7CiAgICAgICAgLy8gVHJ5IGEgTWVkaWFTdHJlYW1UcmFjay5zdG9wKCkgZm9yIGVhY2ggdHJhY2sgYXMgd2VsbAogICAgICAgIGlmICghY29uZmlnLnN0cmVhbUV4dGVybmFsICYmIGNvbmZpZy5teVN0cmVhbSAhPT0gbnVsbCAmJiBjb25maWcubXlTdHJlYW0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgSmFudXMubG9nKCJTdG9wcGluZyBsb2NhbCBzdHJlYW0gdHJhY2tzIik7CiAgICAgICAgICB2YXIgdHJhY2tzID0gY29uZmlnLm15U3RyZWFtLmdldFRyYWNrcygpOwoKICAgICAgICAgIGZvciAodmFyIGkgaW4gdHJhY2tzKSB7CiAgICAgICAgICAgIHZhciBtc3QgPSB0cmFja3NbaV07CiAgICAgICAgICAgIEphbnVzLmxvZyhtc3QpOwogICAgICAgICAgICBpZiAobXN0ICE9PSBudWxsICYmIG1zdCAhPT0gdW5kZWZpbmVkKSBtc3Quc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgey8vIERvIG5vdGhpbmcgaWYgdGhpcyBmYWlscwogICAgICB9CgogICAgICBjb25maWcuc3RyZWFtRXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgY29uZmlnLm15U3RyZWFtID0gbnVsbDsgLy8gQ2xvc2UgUGVlckNvbm5lY3Rpb24KCiAgICAgIHRyeSB7CiAgICAgICAgY29uZmlnLnBjLmNsb3NlKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsvLyBEbyBub3RoaW5nCiAgICAgIH0KCiAgICAgIGNvbmZpZy5wYyA9IG51bGw7CiAgICAgIGNvbmZpZy5teVNkcCA9IG51bGw7CiAgICAgIGNvbmZpZy5pY2VEb25lID0gZmFsc2U7CiAgICAgIGNvbmZpZy5zZHBTZW50ID0gZmFsc2U7CiAgICAgIGNvbmZpZy5kYXRhQ2hhbm5lbCA9IG51bGw7CiAgICAgIGNvbmZpZy5kdG1mU2VuZGVyID0gbnVsbDsKICAgIH0KCiAgICBwbHVnaW5IYW5kbGUub25jbGVhbnVwKCk7CiAgfSAvLyBIZWxwZXIgbWV0aG9kcyB0byBwYXJzZSBhIG1lZGlhIG9iamVjdAoKCiAgZnVuY3Rpb24gaXNBdWRpb1NlbmRFbmFibGVkKG1lZGlhKSB7CiAgICBKYW51cy5kZWJ1ZygiaXNBdWRpb1NlbmRFbmFibGVkOiIsIG1lZGlhKTsKICAgIGlmIChtZWRpYSA9PT0gdW5kZWZpbmVkIHx8IG1lZGlhID09PSBudWxsKSByZXR1cm4gdHJ1ZTsgLy8gRGVmYXVsdAoKICAgIGlmIChtZWRpYS5hdWRpbyA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsgLy8gR2VuZXJpYyBhdWRpbyBoYXMgcHJlY2VkZW5jZQoKICAgIGlmIChtZWRpYS5hdWRpb1NlbmQgPT09IHVuZGVmaW5lZCB8fCBtZWRpYS5hdWRpb1NlbmQgPT09IG51bGwpIHJldHVybiB0cnVlOyAvLyBEZWZhdWx0CgogICAgcmV0dXJuIG1lZGlhLmF1ZGlvU2VuZCA9PT0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGlzQXVkaW9TZW5kUmVxdWlyZWQobWVkaWEpIHsKICAgIEphbnVzLmRlYnVnKCJpc0F1ZGlvU2VuZFJlcXVpcmVkOiIsIG1lZGlhKTsKICAgIGlmIChtZWRpYSA9PT0gdW5kZWZpbmVkIHx8IG1lZGlhID09PSBudWxsKSByZXR1cm4gZmFsc2U7IC8vIERlZmF1bHQKCiAgICBpZiAobWVkaWEuYXVkaW8gPT09IGZhbHNlIHx8IG1lZGlhLmF1ZGlvU2VuZCA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsgLy8gSWYgd2UncmUgbm90IGFza2luZyB0byBjYXB0dXJlIGF1ZGlvLCBpdCdzIG5vdCByZXF1aXJlZAoKICAgIGlmIChtZWRpYS5mYWlsSWZOb0F1ZGlvID09PSB1bmRlZmluZWQgfHwgbWVkaWEuZmFpbElmTm9BdWRpbyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOyAvLyBEZWZhdWx0CgogICAgcmV0dXJuIG1lZGlhLmZhaWxJZk5vQXVkaW8gPT09IHRydWU7CiAgfQoKICBmdW5jdGlvbiBpc0F1ZGlvUmVjdkVuYWJsZWQobWVkaWEpIHsKICAgIEphbnVzLmRlYnVnKCJpc0F1ZGlvUmVjdkVuYWJsZWQ6IiwgbWVkaWEpOwogICAgaWYgKG1lZGlhID09PSB1bmRlZmluZWQgfHwgbWVkaWEgPT09IG51bGwpIHJldHVybiB0cnVlOyAvLyBEZWZhdWx0CgogICAgaWYgKG1lZGlhLmF1ZGlvID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOyAvLyBHZW5lcmljIGF1ZGlvIGhhcyBwcmVjZWRlbmNlCgogICAgaWYgKG1lZGlhLmF1ZGlvUmVjdiA9PT0gdW5kZWZpbmVkIHx8IG1lZGlhLmF1ZGlvUmVjdiA9PT0gbnVsbCkgcmV0dXJuIHRydWU7IC8vIERlZmF1bHQKCiAgICByZXR1cm4gbWVkaWEuYXVkaW9SZWN2ID09PSB0cnVlOwogIH0KCiAgZnVuY3Rpb24gaXNWaWRlb1NlbmRFbmFibGVkKG1lZGlhKSB7CiAgICBKYW51cy5kZWJ1ZygiaXNWaWRlb1NlbmRFbmFibGVkOiIsIG1lZGlhKTsKICAgIGlmIChtZWRpYSA9PT0gdW5kZWZpbmVkIHx8IG1lZGlhID09PSBudWxsKSByZXR1cm4gdHJ1ZTsgLy8gRGVmYXVsdAoKICAgIGlmIChtZWRpYS52aWRlbyA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsgLy8gR2VuZXJpYyB2aWRlbyBoYXMgcHJlY2VkZW5jZQoKICAgIGlmIChtZWRpYS52aWRlb1NlbmQgPT09IHVuZGVmaW5lZCB8fCBtZWRpYS52aWRlb1NlbmQgPT09IG51bGwpIHJldHVybiB0cnVlOyAvLyBEZWZhdWx0CgogICAgcmV0dXJuIG1lZGlhLnZpZGVvU2VuZCA9PT0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGlzVmlkZW9TZW5kUmVxdWlyZWQobWVkaWEpIHsKICAgIEphbnVzLmRlYnVnKCJpc1ZpZGVvU2VuZFJlcXVpcmVkOiIsIG1lZGlhKTsKICAgIGlmIChtZWRpYSA9PT0gdW5kZWZpbmVkIHx8IG1lZGlhID09PSBudWxsKSByZXR1cm4gZmFsc2U7IC8vIERlZmF1bHQKCiAgICBpZiAobWVkaWEudmlkZW8gPT09IGZhbHNlIHx8IG1lZGlhLnZpZGVvU2VuZCA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsgLy8gSWYgd2UncmUgbm90IGFza2luZyB0byBjYXB0dXJlIHZpZGVvLCBpdCdzIG5vdCByZXF1aXJlZAoKICAgIGlmIChtZWRpYS5mYWlsSWZOb1ZpZGVvID09PSB1bmRlZmluZWQgfHwgbWVkaWEuZmFpbElmTm9WaWRlbyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOyAvLyBEZWZhdWx0CgogICAgcmV0dXJuIG1lZGlhLmZhaWxJZk5vVmlkZW8gPT09IHRydWU7CiAgfQoKICBmdW5jdGlvbiBpc1ZpZGVvUmVjdkVuYWJsZWQobWVkaWEpIHsKICAgIEphbnVzLmRlYnVnKCJpc1ZpZGVvUmVjdkVuYWJsZWQ6IiwgbWVkaWEpOwogICAgaWYgKG1lZGlhID09PSB1bmRlZmluZWQgfHwgbWVkaWEgPT09IG51bGwpIHJldHVybiB0cnVlOyAvLyBEZWZhdWx0CgogICAgaWYgKG1lZGlhLnZpZGVvID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOyAvLyBHZW5lcmljIHZpZGVvIGhhcyBwcmVjZWRlbmNlCgogICAgaWYgKG1lZGlhLnZpZGVvUmVjdiA9PT0gdW5kZWZpbmVkIHx8IG1lZGlhLnZpZGVvUmVjdiA9PT0gbnVsbCkgcmV0dXJuIHRydWU7IC8vIERlZmF1bHQKCiAgICByZXR1cm4gbWVkaWEudmlkZW9SZWN2ID09PSB0cnVlOwogIH0KCiAgZnVuY3Rpb24gaXNEYXRhRW5hYmxlZChtZWRpYSkgewogICAgSmFudXMuZGVidWcoImlzRGF0YUVuYWJsZWQ6IiwgbWVkaWEpOwoKICAgIGlmIChhZGFwdGVyLmJyb3dzZXJEZXRhaWxzLmJyb3dzZXIgPT0gImVkZ2UiKSB7CiAgICAgIEphbnVzLndhcm4oIkVkZ2UgZG9lc24ndCBzdXBwb3J0IGRhdGEgY2hhbm5lbHMgeWV0Iik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAobWVkaWEgPT09IHVuZGVmaW5lZCB8fCBtZWRpYSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOyAvLyBEZWZhdWx0CgogICAgcmV0dXJuIG1lZGlhLmRhdGEgPT09IHRydWU7CiAgfQoKICBmdW5jdGlvbiBpc1RyaWNrbGVFbmFibGVkKHRyaWNrbGUpIHsKICAgIEphbnVzLmRlYnVnKCJpc1RyaWNrbGVFbmFibGVkOiIsIHRyaWNrbGUpOwogICAgaWYgKHRyaWNrbGUgPT09IHVuZGVmaW5lZCB8fCB0cmlja2xlID09PSBudWxsKSByZXR1cm4gdHJ1ZTsgLy8gRGVmYXVsdCBpcyB0cnVlCgogICAgcmV0dXJuIHRyaWNrbGUgPT09IHRydWU7CiAgfQp9Cgo7CmV4cG9ydCBkZWZhdWx0IEphbnVzOw=="},{"version":3,"sources":["/Users/youssef/Downloads/WebMix/src/views/janus.js"],"names":["adapter","Janus","sessions","extensionId","isExtensionEnabled","window","navigator","userAgent","match","chromever","parseInt","maxver","document","getElementById","noop","init","options","callback","initDone","console","log","trace","debug","vdebug","warn","error","bind","Array","isArray","i","d","listDevices","config","audio","video","mediaDevices","getUserMedia","then","stream","enumerateDevices","devices","stop","e","tracks","getTracks","mst","undefined","err","attachMediaStream","element","browserDetails","browser","version","srcObject","src","URL","createObjectURL","reattachMediaStream","to","from","ajax","params","success","url","async","XHR","XMLHttpRequest","open","type","contentType","setRequestHeader","withCredentials","onreadystatechange","readyState","status","JSON","parse","responseText","send","data","oldOBF","onbeforeunload","s","destroyOnUnload","destroy","asyncRequest","isWebrtcSupported","RTCPeerConnection","randomString","len","charSet","randomPoz","Math","floor","random","length","substring","gatewayCallbacks","destroyed","server","websockets","ws","wsHandlers","wsKeepaliveTimeoutId","servers","serversIndex","indexOf","iceServers","urls","iceTransportPolicy","ipv6Support","ipv6","maxev","max_poll_events","token","apisecret","connected","sessionId","pluginHandles","that","retries","transactions","createSession","getServer","isConnected","getSessionId","callbacks","destroySession","attach","createHandle","eventHandler","longpoll","Date","getTime","cache","timeout","handleEvent","textStatus","errorThrown","dataType","json","skipTimeout","setTimeout","transaction","reportSuccess","sender","pluginHandle","webrtcState","hangup","detached","ondetached","detach","mediaState","slowLink","code","reason","plugindata","jsep","onmessage","keepAlive","request","stringify","WebSocket","event","eventName","addEventListener","unbindWebSocket","removeEventListener","onUnbindMessage","onUnbindError","clearTimeout","session_id","consentDialog","iceState","onlocalstream","onremotestream","ondata","ondataopen","oncleanup","plugin","opaqueId","handleId","session","id","webrtcStuff","started","myStream","streamExternal","remoteStream","mySdp","pc","dataChannel","dtmfSender","trickle","iceDone","sdpSent","volume","value","timer","bitrate","bsnow","bsbefore","tsnow","tsbefore","getId","getPlugin","getVolume","isAudioMuted","isMuted","muteAudio","mute","unmuteAudio","isVideoMuted","muteVideo","unmuteVideo","getBitrate","sendMessage","sendData","dtmf","sendDtmf","createOffer","prepareWebrtc","createAnswer","handleRemoteJsep","prepareWebrtcPeer","sendRequest","cleanupWebrtc","destroyHandle","message","sendTrickleCandidate","candidate","text","getAudioTracks","local_audio_track","createDTMFSender","ontonechange","tone","tones","duration","gap","insertDTMF","streamsDone","media","pc_config","pc_constraints","optional","push","bundlePolicy","getStats","oniceconnectionstatechange","iceConnectionState","onicecandidate","sendSDP","sdpMid","sdpMLineIndex","addStream","onaddstream","isDataEnabled","onDataChannelMessage","onDataChannelStateChange","dcState","onDataChannelError","createDataChannel","ordered","onopen","onclose","onerror","sdp","setRemoteDescription","RTCSessionDescription","webrtcError","isTrickleEnabled","isAudioSendEnabled","isVideoSendEnabled","constraints","mandatory","audioSupport","videoSupport","width","height","maxHeight","mozGetUserMedia","firefoxVer","callbackUserMedia","name","getScreenMedia","gsmCallback","useAudio","audioStream","addTrack","screenshareFrameRate","location","protocol","googLeakyBucket","maxWidth","screen","minFrameRate","maxFrameRate","chromeMediaSource","pending","Error","postMessage","ffver","mozMediaSource","mediaSource","lastTime","currentTime","polly","setInterval","clearInterval","onended","origin","sourceId","googTemporalLayeredScreencast","chromeMediaSourceId","audioExist","some","device","kind","videoExist","audioSend","videoSend","needAudioDevice","isAudioSendRequired","needVideoDevice","isVideoSendRequired","haveAudioDevice","haveVideoDevice","mediaConstraints","isAudioRecvEnabled","isVideoRecvEnabled","offer","setLocalDescription","answer","localDescription","stats","results","result","res","stat","getVideoTracks","enabled","timestamp","bitRate","round","streams","videoTracks","cb","inbound_rtp_video_1","bytesReceived","hangupRequest","close","failIfNoAudio","audioRecv","failIfNoVideo","videoRecv"],"mappings":"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","sourcesContent":["/* eslint-disable */\n/*\n\tThe MIT License (MIT)\n\n\tCopyright (c) 2016 Meetecho\n\n\tPermission is hereby granted, free of charge, to any person obtaining\n\ta copy of this software and associated documentation files (the \"Software\"),\n\tto deal in the Software without restriction, including without limitation\n\tthe rights to use, copy, modify, merge, publish, distribute, sublicense,\n\tand/or sell copies of the Software, and to permit persons to whom the\n\tSoftware is furnished to do so, subject to the following conditions:\n\n\tThe above copyright notice and this permission notice shall be included\n\tin all copies or substantial portions of the Software.\n\n\tTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n\tOR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n\tFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL\n\tTHE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR\n\tOTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,\n\tARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n\tOTHER DEALINGS IN THE SOFTWARE.\n */\n\n\n    import adapter from 'webrtc-adapter'\n\n    // List of sessions\n    Janus.sessions = {};\n    \n    // Screensharing Chrome Extension ID\n    Janus.extensionId = \"hapfgfdkleiggjjpfpenajgdnfckjpaj\";\n    Janus.isExtensionEnabled = function() {\n      if(window.navigator.userAgent.match('Chrome')) {\n        var chromever = parseInt(window.navigator.userAgent.match(/Chrome\\/(.*) /)[1], 10);\n        var maxver = 33;\n        if(window.navigator.userAgent.match('Linux'))\n          maxver = 35;\t// \"known\" crash in chrome 34 and 35 on linux\n        if(chromever >= 26 && chromever <= maxver) {\n          // Older versions of Chrome don't support this extension-based approach, so lie\n          return true;\n        }\n        return (document.getElementById('janus-extension-installed') !== null);\n      } else {\n        // Firefox of others, no need for the extension (but this doesn't mean it will work)\n        return true;\n      }\n    };\n    \n    Janus.noop = function() {};\n    \n    // Initialization\n    Janus.init = function(options) {\n      options = options || {};\n      options.callback = (typeof options.callback == \"function\") ? options.callback : Janus.noop;\n      if(Janus.initDone === true) {\n        // Already initialized\n        options.callback();\n      } else {\n        if(typeof console == \"undefined\" || typeof console.log == \"undefined\")\n          console = { log: function() {} };\n        // Console logging (all debugging disabled by default)\n        Janus.trace = Janus.noop;\n        Janus.debug = Janus.noop;\n        Janus.vdebug = Janus.noop;\n        Janus.log = Janus.noop;\n        Janus.warn = Janus.noop;\n        Janus.error = Janus.noop;\n        if(options.debug === true || options.debug === \"all\") {\n          // Enable all debugging levels\n          Janus.trace = console.trace.bind(console);\n          Janus.debug = console.debug.bind(console);\n          Janus.vdebug = console.debug.bind(console);\n          Janus.log = console.log.bind(console);\n          Janus.warn = console.warn.bind(console);\n          Janus.error = console.error.bind(console);\n        } else if(Array.isArray(options.debug)) {\n          for(var i in options.debug) {\n            var d = options.debug[i];\n            switch(d) {\n              case \"trace\":\n                Janus.trace = console.trace.bind(console);\n                break;\n              case \"debug\":\n                Janus.debug = console.debug.bind(console);\n                break;\n              case \"vdebug\":\n                Janus.vdebug = console.debug.bind(console);\n                break;\n              case \"log\":\n                Janus.log = console.log.bind(console);\n                break;\n              case \"warn\":\n                Janus.warn = console.warn.bind(console);\n                break;\n              case \"error\":\n                Janus.error = console.error.bind(console);\n                break;\n              default:\n                console.error(\"Unknown debugging option '\" + d + \"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')\");\n                break;\n            }\n          }\n        }\n        Janus.log(\"Initializing library\");\n        // Helper method to enumerate devices\n        Janus.listDevices = function(callback, config) {\n          callback = (typeof callback == \"function\") ? callback : Janus.noop;\n          if (config == null) config = { audio: true, video: true };\n          if(navigator.mediaDevices) {\n            navigator.mediaDevices.getUserMedia(config)\n              .then(function(stream) {\n                navigator.mediaDevices.enumerateDevices().then(function(devices) {\n                  Janus.debug(devices);\n                  callback(devices);\n                  // Get rid of the now useless stream\n                  try {\n                    stream.stop();\n                  } catch(e) {}\n                  try {\n                    var tracks = stream.getTracks();\n                    for(var i in tracks) {\n                      var mst = tracks[i];\n                      if(mst !== null && mst !== undefined)\n                        mst.stop();\n                    }\n                  } catch(e) {}\n                });\n              })\n              .catch(function(err) {\n                Janus.error(err);\n                callback([]);\n              });\n          } else {\n            Janus.warn(\"navigator.mediaDevices unavailable\");\n            callback([]);\n          }\n        }\n        // Helper methods to attach/reattach a stream to a video element (previously part of adapter.js)\n        Janus.attachMediaStream = function(element, stream) {\n          if(adapter.browserDetails.browser === 'chrome') {\n            var chromever = adapter.browserDetails.version;\n            if (chromever >= 43) {\n              element.srcObject = stream;\n            } else if(typeof element.src !== 'undefined') {\n              element.src = URL.createObjectURL(stream);\n            } else {\n              Janus.error(\"Error attaching stream to element\");\n            }\n          }\n          else {\n            element.srcObject = stream;\n          }\n        };\n        Janus.reattachMediaStream = function(to, from) {\n          if(adapter.browserDetails.browser === 'chrome') {\n            var chromever = adapter.browserDetails.version;\n            if(chromever >= 43) {\n              to.srcObject = from.srcObject;\n            } else if(typeof to.src !== 'undefined') {\n              to.src = from.src;\n            }\n          } else if(adapter.browserDetails.browser === 'safari' || window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i)) {\n            to.src = from.src;\n          }\n          else {\n            to.srcObject = from.srcObject;\n          }\n        };\n        // Prepare a helper method to send AJAX requests in a syntax similar to jQuery (at least for what we care)\n        Janus.ajax = function(params) {\n          // Check params\n          if(params === null || params === undefined)\n            return;\n          params.success = (typeof params.success == \"function\") ? params.success : Janus.noop;\n          params.error = (typeof params.error == \"function\") ? params.error : Janus.noop;\n          // Make sure there's an URL\n          if(params.url === null || params.url === undefined) {\n            Janus.error('Missing url', params.url);\n            params.error(null, -1, 'Missing url');\n            return;\n          }\n          // Validate async\n          params.async = (params.async === null || params.async === undefined) ? true : (params.async === true);\n          Janus.log(params);\n          // IE doesn't even know what WebRTC is, so no polyfill needed\n          var XHR = new XMLHttpRequest();\n          XHR.open(params.type, params.url, params.async);\n          if(params.contentType !== null && params.contentType !== undefined)\n            XHR.setRequestHeader('Content-type', params.contentType);\n          if(params.withCredentials !== null && params.withCredentials !== undefined)\n            XHR.withCredentials = params.withCredentials;\n          if(params.async) {\n            XHR.onreadystatechange = function () {\n              if(XHR.readyState != 4)\n                return;\n              if(XHR.status !== 200) {\n                // Got an error?\n                params.error(XHR, XHR.status !== 0 ? XHR.status : 'error', \"\");\n                return;\n              }\n              // Got payload\n              try {\n                params.success(JSON.parse(XHR.responseText));\n              } catch(e) {\n                params.error(XHR, XHR.status, 'Could not parse response, error: ' + e + ', text: ' + XHR.responseText);\n              }\n            };\n          }\n          try {\n            XHR.send(params.data);\n            if(!params.async) {\n              if(XHR.status !== 200) {\n                // Got an error?\n                params.error(XHR, XHR.status !== 0 ? XHR.status : 'error', \"\");\n                return;\n              }\n              // Got payload\n              try {\n                params.success(JSON.parse(XHR.responseText));\n              } catch(e) {\n                params.error(XHR, XHR.status, 'Could not parse response, error: ' + e + ', text: ' + XHR.responseText);\n              }\n            }\n          } catch(e) {\n            // Something broke up\n            params.error(XHR, 'error', '');\n          };\n        };\n        // Detect tab close: make sure we don't loose existing onbeforeunload handlers\n        var oldOBF = window.onbeforeunload;\n        window.onbeforeunload = function() {\n          Janus.log(\"Closing window\");\n          for(var s in Janus.sessions) {\n            if(Janus.sessions[s] !== null && Janus.sessions[s] !== undefined &&\n              Janus.sessions[s].destroyOnUnload) {\n              Janus.log(\"Destroying session \" + s);\n              Janus.sessions[s].destroy({asyncRequest: false});\n            }\n          }\n          if(oldOBF && typeof oldOBF == \"function\")\n            oldOBF();\n        }\n        Janus.initDone = true;\n        options.callback();\n      }\n    };\n    \n    // Helper method to check whether WebRTC is supported by this browser\n    Janus.isWebrtcSupported = function() {\n      return window.RTCPeerConnection !== undefined && window.RTCPeerConnection !== null &&\n        navigator.getUserMedia !== undefined && navigator.getUserMedia !== null;\n    };\n    \n    // Helper method to create random identifiers (e.g., transaction)\n    Janus.randomString = function(len) {\n      var charSet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n      var randomString = '';\n      for (var i = 0; i < len; i++) {\n        var randomPoz = Math.floor(Math.random() * charSet.length);\n        randomString += charSet.substring(randomPoz,randomPoz+1);\n      }\n      return randomString;\n    }\n    \n    \n    // Janus session object\n    function Janus(gatewayCallbacks) {\n      if(Janus.initDone === undefined) {\n        gatewayCallbacks.error(\"Library not initialized\");\n        return {};\n      }\n      if(!Janus.isWebrtcSupported()) {\n        gatewayCallbacks.error(\"WebRTC not supported by this browser\");\n        return {};\n      }\n      Janus.log(\"Library initialized: \" + Janus.initDone);\n      gatewayCallbacks = gatewayCallbacks || {};\n      gatewayCallbacks.success = (typeof gatewayCallbacks.success == \"function\") ? gatewayCallbacks.success : Janus.noop;\n      gatewayCallbacks.error = (typeof gatewayCallbacks.error == \"function\") ? gatewayCallbacks.error : Janus.noop;\n      gatewayCallbacks.destroyed = (typeof gatewayCallbacks.destroyed == \"function\") ? gatewayCallbacks.destroyed : Janus.noop;\n      if(gatewayCallbacks.server === null || gatewayCallbacks.server === undefined) {\n        gatewayCallbacks.error(\"Invalid gateway url\");\n        return {};\n      }\n      var websockets = false;\n      var ws = null;\n      var wsHandlers = {};\n      var wsKeepaliveTimeoutId = null;\n    \n      var servers = null, serversIndex = 0;\n      var server = gatewayCallbacks.server;\n      if(Array.isArray(server)) {\n        Janus.log(\"Multiple servers provided (\" + server.length + \"), will use the first that works\");\n        server = null;\n        servers = gatewayCallbacks.server;\n        Janus.debug(servers);\n      } else {\n        if(server.indexOf(\"ws\") === 0) {\n          websockets = true;\n          Janus.log(\"Using WebSockets to contact Janus: \" + server);\n        } else {\n          websockets = false;\n          Janus.log(\"Using REST API to contact Janus: \" + server);\n        }\n      }\n      var iceServers = gatewayCallbacks.iceServers;\n      if(iceServers === undefined || iceServers === null)\n        iceServers = [{urls: \"stun:stun.l.google.com:19302\"}];\n      var iceTransportPolicy = gatewayCallbacks.iceTransportPolicy;\n      // Whether IPv6 candidates should be gathered\n      var ipv6Support = gatewayCallbacks.ipv6;\n      if(ipv6Support === undefined || ipv6Support === null)\n        ipv6Support = false;\n      // Whether we should enable the withCredentials flag for XHR requests\n      var withCredentials = false;\n      if(gatewayCallbacks.withCredentials !== undefined && gatewayCallbacks.withCredentials !== null)\n        withCredentials = gatewayCallbacks.withCredentials === true;\n      // Optional max events\n      var maxev = null;\n      if(gatewayCallbacks.max_poll_events !== undefined && gatewayCallbacks.max_poll_events !== null)\n        maxev = gatewayCallbacks.max_poll_events;\n      if(maxev < 1)\n        maxev = 1;\n      // Token to use (only if the token based authentication mechanism is enabled)\n      var token = null;\n      if(gatewayCallbacks.token !== undefined && gatewayCallbacks.token !== null)\n        token = gatewayCallbacks.token;\n      // API secret to use (only if the shared API secret is enabled)\n      var apisecret = null;\n      if(gatewayCallbacks.apisecret !== undefined && gatewayCallbacks.apisecret !== null)\n        apisecret = gatewayCallbacks.apisecret;\n      // Whether we should destroy this session when onbeforeunload is called\n      this.destroyOnUnload = true;\n      if(gatewayCallbacks.destroyOnUnload !== undefined && gatewayCallbacks.destroyOnUnload !== null)\n        this.destroyOnUnload = (gatewayCallbacks.destroyOnUnload === true);\n    \n      var connected = false;\n      var sessionId = null;\n      var pluginHandles = {};\n      var that = this;\n      var retries = 0;\n      var transactions = {};\n      createSession(gatewayCallbacks);\n    \n      // Public methods\n      this.getServer = function() { return server; };\n      this.isConnected = function() { return connected; };\n      this.getSessionId = function() { return sessionId; };\n      this.destroy = function(callbacks) { destroySession(callbacks, true); };\n      this.attach = function(callbacks) { createHandle(callbacks); };\n    \n      function eventHandler() {\n        if(sessionId == null)\n          return;\n        Janus.debug('Long poll...');\n        if(!connected) {\n          Janus.warn(\"Is the gateway down? (connected=false)\");\n          return;\n        }\n        var longpoll = server + \"/\" + sessionId + \"?rid=\" + new Date().getTime();\n        if(maxev !== undefined && maxev !== null)\n          longpoll = longpoll + \"&maxev=\" + maxev;\n        if(token !== null && token !== undefined)\n          longpoll = longpoll + \"&token=\" + token;\n        if(apisecret !== null && apisecret !== undefined)\n          longpoll = longpoll + \"&apisecret=\" + apisecret;\n        Janus.ajax({\n          type: 'GET',\n          url: longpoll,\n          withCredentials: withCredentials,\n          cache: false,\n          timeout: 60000,\t// FIXME\n          success: handleEvent,\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\n            retries++;\n            if(retries > 3) {\n              // Did we just lose the gateway? :-(\n              connected = false;\n              gatewayCallbacks.error(\"Lost connection to the gateway (is it down?)\");\n              return;\n            }\n            eventHandler();\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // Private event handler: this will trigger plugin callbacks, if set\n      function handleEvent(json, skipTimeout) {\n        retries = 0;\n        if(!websockets && sessionId !== undefined && sessionId !== null && skipTimeout !== true)\n          setTimeout(eventHandler, 200);\n        if(!websockets && Array.isArray(json)) {\n          // We got an array: it means we passed a maxev > 1, iterate on all objects\n          for(var i=0; i<json.length; i++) {\n            handleEvent(json[i], true);\n          }\n          return;\n        }\n        if(json[\"janus\"] === \"keepalive\") {\n          // Nothing happened\n          Janus.vdebug(\"Got a keepalive on session \" + sessionId);\n          return;\n        } else if(json[\"janus\"] === \"ack\") {\n          // Just an ack, we can probably ignore\n          Janus.debug(\"Got an ack on session \" + sessionId);\n          Janus.debug(json);\n          var transaction = json[\"transaction\"];\n          if(transaction !== null && transaction !== undefined) {\n            var reportSuccess = transactions[transaction];\n            if(reportSuccess !== null && reportSuccess !== undefined) {\n              reportSuccess(json);\n            }\n            delete transactions[transaction];\n          }\n          return;\n        } else if(json[\"janus\"] === \"success\") {\n          // Success!\n          Janus.debug(\"Got a success on session \" + sessionId);\n          Janus.debug(json);\n          var transaction = json[\"transaction\"];\n          if(transaction !== null && transaction !== undefined) {\n            var reportSuccess = transactions[transaction];\n            if(reportSuccess !== null && reportSuccess !== undefined) {\n              reportSuccess(json);\n            }\n            delete transactions[transaction];\n          }\n          return;\n        } else if(json[\"janus\"] === \"webrtcup\") {\n          // The PeerConnection with the gateway is up! Notify this\n          Janus.debug(\"Got a webrtcup event on session \" + sessionId);\n          Janus.debug(json);\n          var sender = json[\"sender\"];\n          if(sender === undefined || sender === null) {\n            Janus.warn(\"Missing sender...\");\n            return;\n          }\n          var pluginHandle = pluginHandles[sender];\n          if(pluginHandle === undefined || pluginHandle === null) {\n            Janus.debug(\"This handle is not attached to this session\");\n            return;\n          }\n          pluginHandle.webrtcState(true);\n          return;\n        } else if(json[\"janus\"] === \"hangup\") {\n          // A plugin asked the core to hangup a PeerConnection on one of our handles\n          Janus.debug(\"Got a hangup event on session \" + sessionId);\n          Janus.debug(json);\n          var sender = json[\"sender\"];\n          if(sender === undefined || sender === null) {\n            Janus.warn(\"Missing sender...\");\n            return;\n          }\n          var pluginHandle = pluginHandles[sender];\n          if(pluginHandle === undefined || pluginHandle === null) {\n            Janus.debug(\"This handle is not attached to this session\");\n            return;\n          }\n          pluginHandle.webrtcState(false, json[\"reason\"]);\n          pluginHandle.hangup();\n        } else if(json[\"janus\"] === \"detached\") {\n          // A plugin asked the core to detach one of our handles\n          Janus.debug(\"Got a detached event on session \" + sessionId);\n          Janus.debug(json);\n          var sender = json[\"sender\"];\n          if(sender === undefined || sender === null) {\n            Janus.warn(\"Missing sender...\");\n            return;\n          }\n          var pluginHandle = pluginHandles[sender];\n          if(pluginHandle === undefined || pluginHandle === null) {\n            // Don't warn here because destroyHandle causes this situation.\n            return;\n          }\n          pluginHandle.detached = true;\n          pluginHandle.ondetached();\n          pluginHandle.detach();\n        } else if(json[\"janus\"] === \"media\") {\n          // Media started/stopped flowing\n          Janus.debug(\"Got a media event on session \" + sessionId);\n          Janus.debug(json);\n          var sender = json[\"sender\"];\n          if(sender === undefined || sender === null) {\n            Janus.warn(\"Missing sender...\");\n            return;\n          }\n          var pluginHandle = pluginHandles[sender];\n          if(pluginHandle === undefined || pluginHandle === null) {\n            Janus.debug(\"This handle is not attached to this session\");\n            return;\n          }\n          pluginHandle.mediaState(json[\"type\"], json[\"receiving\"]);\n        } else if(json[\"janus\"] === \"slowlink\") {\n          Janus.debug(\"Got a slowlink event on session \" + sessionId);\n          Janus.debug(json);\n          // Trouble uplink or downlink\n          var sender = json[\"sender\"];\n          if(sender === undefined || sender === null) {\n            Janus.warn(\"Missing sender...\");\n            return;\n          }\n          var pluginHandle = pluginHandles[sender];\n          if(pluginHandle === undefined || pluginHandle === null) {\n            Janus.debug(\"This handle is not attached to this session\");\n            return;\n          }\n          pluginHandle.slowLink(json[\"uplink\"], json[\"nacks\"]);\n        } else if(json[\"janus\"] === \"error\") {\n          // Oops, something wrong happened\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n          Janus.debug(json);\n          var transaction = json[\"transaction\"];\n          if(transaction !== null && transaction !== undefined) {\n            var reportSuccess = transactions[transaction];\n            if(reportSuccess !== null && reportSuccess !== undefined) {\n              reportSuccess(json);\n            }\n            delete transactions[transaction];\n          }\n          return;\n        } else if(json[\"janus\"] === \"event\") {\n          Janus.debug(\"Got a plugin event on session \" + sessionId);\n          Janus.debug(json);\n          var sender = json[\"sender\"];\n          if(sender === undefined || sender === null) {\n            Janus.warn(\"Missing sender...\");\n            return;\n          }\n          var plugindata = json[\"plugindata\"];\n          if(plugindata === undefined || plugindata === null) {\n            Janus.warn(\"Missing plugindata...\");\n            return;\n          }\n          Janus.debug(\"  -- Event is coming from \" + sender + \" (\" + plugindata[\"plugin\"] + \")\");\n          var data = plugindata[\"data\"];\n          Janus.debug(data);\n          var pluginHandle = pluginHandles[sender];\n          if(pluginHandle === undefined || pluginHandle === null) {\n            Janus.warn(\"This handle is not attached to this session\");\n            return;\n          }\n          var jsep = json[\"jsep\"];\n          if(jsep !== undefined && jsep !== null) {\n            Janus.debug(\"Handling SDP as well...\");\n            Janus.debug(jsep);\n          }\n          var callback = pluginHandle.onmessage;\n          if(callback !== null && callback !== undefined) {\n            Janus.debug(\"Notifying application...\");\n            // Send to callback specified when attaching plugin handle\n            callback(data, jsep);\n          } else {\n            // Send to generic callback (?)\n            Janus.debug(\"No provided notification callback\");\n          }\n        } else {\n          Janus.warn(\"Unkown message/event  '\" + json[\"janus\"] + \"' on session \" + sessionId);\n          Janus.debug(json);\n        }\n      }\n    \n      // Private helper to send keep-alive messages on WebSockets\n      function keepAlive() {\n        if(server === null || !websockets || !connected)\n          return;\n        wsKeepaliveTimeoutId = setTimeout(keepAlive, 30000);\n        var request = { \"janus\": \"keepalive\", \"session_id\": sessionId, \"transaction\": Janus.randomString(12) };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        ws.send(JSON.stringify(request));\n      }\n    \n      // Private method to create a session\n      function createSession(callbacks) {\n        var transaction = Janus.randomString(12);\n        var request = { \"janus\": \"create\", \"transaction\": transaction };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        if(server === null && Array.isArray(servers)) {\n          // We still need to find a working server from the list we were given\n          server = servers[serversIndex];\n          if(server.indexOf(\"ws\") === 0) {\n            websockets = true;\n            Janus.log(\"Server #\" + (serversIndex+1) + \": trying WebSockets to contact Janus (\" + server + \")\");\n          } else {\n            websockets = false;\n            Janus.log(\"Server #\" + (serversIndex+1) + \": trying REST API to contact Janus (\" + server + \")\");\n          }\n        }\n        if(websockets) {\n          ws = new WebSocket(server, 'janus-protocol');\n          wsHandlers = {\n            'error': function() {\n              Janus.error(\"Error connecting to the Janus WebSockets server... \" + server);\n              if (Array.isArray(servers)) {\n                serversIndex++;\n                if (serversIndex == servers.length) {\n                  // We tried all the servers the user gave us and they all failed\n                  callbacks.error(\"Error connecting to any of the provided Janus servers: Is the gateway down?\");\n                  return;\n                }\n                // Let's try the next server\n                server = null;\n                setTimeout(function() {\n                  createSession(callbacks);\n                }, 200);\n                return;\n              }\n              callbacks.error(\"Error connecting to the Janus WebSockets server: Is the gateway down?\");\n            },\n    \n            'open': function() {\n              // We need to be notified about the success\n              transactions[transaction] = function(json) {\n                Janus.debug(json);\n                if (json[\"janus\"] !== \"success\") {\n                  Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n                  callbacks.error(json[\"error\"].reason);\n                  return;\n                }\n                wsKeepaliveTimeoutId = setTimeout(keepAlive, 30000);\n                connected = true;\n                sessionId = json.data[\"id\"];\n                Janus.log(\"Created session: \" + sessionId);\n                Janus.sessions[sessionId] = that;\n                callbacks.success();\n              };\n              ws.send(JSON.stringify(request));\n            },\n    \n            'message': function(event) {\n              try {\n                handleEvent(JSON.parse(event.data));\n              } catch(e) {\n                Janus.error('Error processing event:', e);\n              }\n            },\n    \n            'close': function() {\n              if (server === null || !connected) {\n                return;\n              }\n              connected = false;\n              // FIXME What if this is called when the page is closed?\n              gatewayCallbacks.error(\"Lost connection to the gateway (is it down?)\");\n            }\n          };\n    \n          for(var eventName in wsHandlers) {\n            ws.addEventListener(eventName, wsHandlers[eventName]);\n          }\n    \n          return;\n        }\n        Janus.ajax({\n          type: 'POST',\n          url: server,\n          withCredentials: withCredentials,\n          cache: false,\n          contentType: \"application/json\",\n          data: JSON.stringify(request),\n          success: function(json) {\n            Janus.debug(json);\n            if(json[\"janus\"] !== \"success\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n              callbacks.error(json[\"error\"].reason);\n              return;\n            }\n            connected = true;\n            sessionId = json.data[\"id\"];\n            Janus.log(\"Created session: \" + sessionId);\n            Janus.sessions[sessionId] = that;\n            eventHandler();\n            callbacks.success();\n          },\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\t// FIXME\n            if(Array.isArray(servers)) {\n              serversIndex++;\n              if(serversIndex == servers.length) {\n                // We tried all the servers the user gave us and they all failed\n                callbacks.error(\"Error connecting to any of the provided Janus servers: Is the gateway down?\");\n                return;\n              }\n              // Let's try the next server\n              server = null;\n              setTimeout(function() { createSession(callbacks); }, 200);\n              return;\n            }\n            if(errorThrown === \"\")\n              callbacks.error(textStatus + \": Is the gateway down?\");\n            else\n              callbacks.error(textStatus + \": \" + errorThrown);\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // Private method to destroy a session\n      function destroySession(callbacks) {\n        callbacks = callbacks || {};\n        // FIXME This method triggers a success even when we fail\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        var asyncRequest = true;\n        if(callbacks.asyncRequest !== undefined && callbacks.asyncRequest !== null)\n          asyncRequest = (callbacks.asyncRequest === true);\n        Janus.log(\"Destroying session \" + sessionId + \" (async=\" + asyncRequest + \")\");\n        if(!connected) {\n          Janus.warn(\"Is the gateway down? (connected=false)\");\n          callbacks.success();\n          return;\n        }\n        if(sessionId === undefined || sessionId === null) {\n          Janus.warn(\"No session to destroy\");\n          callbacks.success();\n          gatewayCallbacks.destroyed();\n          return;\n        }\n        delete Janus.sessions[sessionId];\n        // No need to destroy all handles first, Janus will do that itself\n        var request = { \"janus\": \"destroy\", \"transaction\": Janus.randomString(12) };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        if(websockets) {\n          request[\"session_id\"] = sessionId;\n    \n          var unbindWebSocket = function() {\n            for(var eventName in wsHandlers) {\n              ws.removeEventListener(eventName, wsHandlers[eventName]);\n            }\n            ws.removeEventListener('message', onUnbindMessage);\n            ws.removeEventListener('error', onUnbindError);\n            if(wsKeepaliveTimeoutId) {\n              clearTimeout(wsKeepaliveTimeoutId);\n            }\n          };\n    \n          var onUnbindMessage = function(event){\n            var data = JSON.parse(event.data);\n            if(data.session_id == request.session_id && data.transaction == request.transaction) {\n              unbindWebSocket();\n              callbacks.success();\n              gatewayCallbacks.destroyed();\n            }\n          };\n          var onUnbindError = function(event) {\n            unbindWebSocket();\n            callbacks.error(\"Failed to destroy the gateway: Is the gateway down?\");\n            gatewayCallbacks.destroyed();\n          };\n    \n          ws.addEventListener('message', onUnbindMessage);\n          ws.addEventListener('error', onUnbindError);\n    \n          ws.send(JSON.stringify(request));\n          return;\n        }\n        Janus.ajax({\n          type: 'POST',\n          url: server + \"/\" + sessionId,\n          async: asyncRequest,\t// Sometimes we need false here, or destroying in onbeforeunload won't work\n          withCredentials: withCredentials,\n          cache: false,\n          contentType: \"application/json\",\n          data: JSON.stringify(request),\n          success: function(json) {\n            Janus.log(\"Destroyed session:\");\n            Janus.debug(json);\n            sessionId = null;\n            connected = false;\n            if(json[\"janus\"] !== \"success\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n            }\n            callbacks.success();\n            gatewayCallbacks.destroyed();\n          },\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\t// FIXME\n            // Reset everything anyway\n            sessionId = null;\n            connected = false;\n            callbacks.success();\n            gatewayCallbacks.destroyed();\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // Private method to create a plugin handle\n      function createHandle(callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        callbacks.consentDialog = (typeof callbacks.consentDialog == \"function\") ? callbacks.consentDialog : Janus.noop;\n        callbacks.iceState = (typeof callbacks.iceState == \"function\") ? callbacks.iceState : Janus.noop;\n        callbacks.mediaState = (typeof callbacks.mediaState == \"function\") ? callbacks.mediaState : Janus.noop;\n        callbacks.webrtcState = (typeof callbacks.webrtcState == \"function\") ? callbacks.webrtcState : Janus.noop;\n        callbacks.slowLink = (typeof callbacks.slowLink == \"function\") ? callbacks.slowLink : Janus.noop;\n        callbacks.onmessage = (typeof callbacks.onmessage == \"function\") ? callbacks.onmessage : Janus.noop;\n        callbacks.onlocalstream = (typeof callbacks.onlocalstream == \"function\") ? callbacks.onlocalstream : Janus.noop;\n        callbacks.onremotestream = (typeof callbacks.onremotestream == \"function\") ? callbacks.onremotestream : Janus.noop;\n        callbacks.ondata = (typeof callbacks.ondata == \"function\") ? callbacks.ondata : Janus.noop;\n        callbacks.ondataopen = (typeof callbacks.ondataopen == \"function\") ? callbacks.ondataopen : Janus.noop;\n        callbacks.oncleanup = (typeof callbacks.oncleanup == \"function\") ? callbacks.oncleanup : Janus.noop;\n        callbacks.ondetached = (typeof callbacks.ondetached == \"function\") ? callbacks.ondetached : Janus.noop;\n        if(!connected) {\n          Janus.warn(\"Is the gateway down? (connected=false)\");\n          callbacks.error(\"Is the gateway down? (connected=false)\");\n          return;\n        }\n        var plugin = callbacks.plugin;\n        if(plugin === undefined || plugin === null) {\n          Janus.error(\"Invalid plugin\");\n          callbacks.error(\"Invalid plugin\");\n          return;\n        }\n        var opaqueId = callbacks.opaqueId;\n        var transaction = Janus.randomString(12);\n        var request = { \"janus\": \"attach\", \"plugin\": plugin, \"opaque_id\": opaqueId, \"transaction\": transaction };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        // If we know the browser supports BUNDLE and/or rtcp-mux, let's advertise those right away\n        if(adapter.browserDetails.browser == \"chrome\" || adapter.browserDetails.browser == \"firefox\") {\n          request[\"force-bundle\"] = true;\n          request[\"force-rtcp-mux\"] = true;\n        }\n        if(websockets) {\n          transactions[transaction] = function(json) {\n            Janus.debug(json);\n            if(json[\"janus\"] !== \"success\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n              callbacks.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\n              return;\n            }\n            var handleId = json.data[\"id\"];\n            Janus.log(\"Created handle: \" + handleId);\n            var pluginHandle =\n              {\n                session : that,\n                plugin : plugin,\n                id : handleId,\n                detached : false,\n                webrtcStuff : {\n                  started : false,\n                  myStream : null,\n                  streamExternal : false,\n                  remoteStream : null,\n                  mySdp : null,\n                  pc : null,\n                  dataChannel : null,\n                  dtmfSender : null,\n                  trickle : true,\n                  iceDone : false,\n                  sdpSent : false,\n                  volume : {\n                    value : null,\n                    timer : null\n                  },\n                  bitrate : {\n                    value : null,\n                    bsnow : null,\n                    bsbefore : null,\n                    tsnow : null,\n                    tsbefore : null,\n                    timer : null\n                  }\n                },\n                getId : function() { return handleId; },\n                getPlugin : function() { return plugin; },\n                getVolume : function() { return getVolume(handleId); },\n                isAudioMuted : function() { return isMuted(handleId, false); },\n                muteAudio : function() { return mute(handleId, false, true); },\n                unmuteAudio : function() { return mute(handleId, false, false); },\n                isVideoMuted : function() { return isMuted(handleId, true); },\n                muteVideo : function() { return mute(handleId, true, true); },\n                unmuteVideo : function() { return mute(handleId, true, false); },\n                getBitrate : function() { return getBitrate(handleId); },\n                send : function(callbacks) { sendMessage(handleId, callbacks); },\n                data : function(callbacks) { sendData(handleId, callbacks); },\n                dtmf : function(callbacks) { sendDtmf(handleId, callbacks); },\n                consentDialog : callbacks.consentDialog,\n                iceState : callbacks.iceState,\n                mediaState : callbacks.mediaState,\n                webrtcState : callbacks.webrtcState,\n                slowLink : callbacks.slowLink,\n                onmessage : callbacks.onmessage,\n                createOffer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n                createAnswer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n                handleRemoteJsep : function(callbacks) { prepareWebrtcPeer(handleId, callbacks); },\n                onlocalstream : callbacks.onlocalstream,\n                onremotestream : callbacks.onremotestream,\n                ondata : callbacks.ondata,\n                ondataopen : callbacks.ondataopen,\n                oncleanup : callbacks.oncleanup,\n                ondetached : callbacks.ondetached,\n                hangup : function(sendRequest) { cleanupWebrtc(handleId, sendRequest === true); },\n                detach : function(callbacks) { destroyHandle(handleId, callbacks); }\n              }\n            pluginHandles[handleId] = pluginHandle;\n            callbacks.success(pluginHandle);\n          };\n          request[\"session_id\"] = sessionId;\n          ws.send(JSON.stringify(request));\n          return;\n        }\n        Janus.ajax({\n          type: 'POST',\n          url: server + \"/\" + sessionId,\n          withCredentials: withCredentials,\n          cache: false,\n          contentType: \"application/json\",\n          data: JSON.stringify(request),\n          success: function(json) {\n            Janus.debug(json);\n            if(json[\"janus\"] !== \"success\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n              callbacks.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\n              return;\n            }\n            var handleId = json.data[\"id\"];\n            Janus.log(\"Created handle: \" + handleId);\n            var pluginHandle =\n              {\n                session : that,\n                plugin : plugin,\n                id : handleId,\n                detached : false,\n                webrtcStuff : {\n                  started : false,\n                  myStream : null,\n                  streamExternal : false,\n                  remoteStream : null,\n                  mySdp : null,\n                  pc : null,\n                  dataChannel : null,\n                  dtmfSender : null,\n                  trickle : true,\n                  iceDone : false,\n                  sdpSent : false,\n                  volume : {\n                    value : null,\n                    timer : null\n                  },\n                  bitrate : {\n                    value : null,\n                    bsnow : null,\n                    bsbefore : null,\n                    tsnow : null,\n                    tsbefore : null,\n                    timer : null\n                  }\n                },\n                getId : function() { return handleId; },\n                getPlugin : function() { return plugin; },\n                getVolume : function() { return getVolume(handleId); },\n                isAudioMuted : function() { return isMuted(handleId, false); },\n                muteAudio : function() { return mute(handleId, false, true); },\n                unmuteAudio : function() { return mute(handleId, false, false); },\n                isVideoMuted : function() { return isMuted(handleId, true); },\n                muteVideo : function() { return mute(handleId, true, true); },\n                unmuteVideo : function() { return mute(handleId, true, false); },\n                getBitrate : function() { return getBitrate(handleId); },\n                send : function(callbacks) { sendMessage(handleId, callbacks); },\n                data : function(callbacks) { sendData(handleId, callbacks); },\n                dtmf : function(callbacks) { sendDtmf(handleId, callbacks); },\n                consentDialog : callbacks.consentDialog,\n                iceState : callbacks.iceState,\n                mediaState : callbacks.mediaState,\n                webrtcState : callbacks.webrtcState,\n                slowLink : callbacks.slowLink,\n                onmessage : callbacks.onmessage,\n                createOffer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n                createAnswer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n                handleRemoteJsep : function(callbacks) { prepareWebrtcPeer(handleId, callbacks); },\n                onlocalstream : callbacks.onlocalstream,\n                onremotestream : callbacks.onremotestream,\n                ondata : callbacks.ondata,\n                ondataopen : callbacks.ondataopen,\n                oncleanup : callbacks.oncleanup,\n                ondetached : callbacks.ondetached,\n                hangup : function(sendRequest) { cleanupWebrtc(handleId, sendRequest === true); },\n                detach : function(callbacks) { destroyHandle(handleId, callbacks); }\n              }\n            pluginHandles[handleId] = pluginHandle;\n            callbacks.success(pluginHandle);\n          },\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\t// FIXME\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // Private method to send a message\n      function sendMessage(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        if(!connected) {\n          Janus.warn(\"Is the gateway down? (connected=false)\");\n          callbacks.error(\"Is the gateway down? (connected=false)\");\n          return;\n        }\n        var message = callbacks.message;\n        var jsep = callbacks.jsep;\n        var transaction = Janus.randomString(12);\n        var request = { \"janus\": \"message\", \"body\": message, \"transaction\": transaction };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        if(jsep !== null && jsep !== undefined)\n          request.jsep = jsep;\n        Janus.debug(\"Sending message to plugin (handle=\" + handleId + \"):\");\n        Janus.debug(request);\n        if(websockets) {\n          request[\"session_id\"] = sessionId;\n          request[\"handle_id\"] = handleId;\n          transactions[transaction] = function(json) {\n            Janus.debug(\"Message sent!\");\n            Janus.debug(json);\n            if(json[\"janus\"] === \"success\") {\n              // We got a success, must have been a synchronous transaction\n              var plugindata = json[\"plugindata\"];\n              if(plugindata === undefined || plugindata === null) {\n                Janus.warn(\"Request succeeded, but missing plugindata...\");\n                callbacks.success();\n                return;\n              }\n              Janus.log(\"Synchronous transaction successful (\" + plugindata[\"plugin\"] + \")\");\n              var data = plugindata[\"data\"];\n              Janus.debug(data);\n              callbacks.success(data);\n              return;\n            } else if(json[\"janus\"] !== \"ack\") {\n              // Not a success and not an ack, must be an error\n              if(json[\"error\"] !== undefined && json[\"error\"] !== null) {\n                Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n                callbacks.error(json[\"error\"].code + \" \" + json[\"error\"].reason);\n              } else {\n                Janus.error(\"Unknown error\");\t// FIXME\n                callbacks.error(\"Unknown error\");\n              }\n              return;\n            }\n            // If we got here, the plugin decided to handle the request asynchronously\n            callbacks.success();\n          };\n          ws.send(JSON.stringify(request));\n          return;\n        }\n        Janus.ajax({\n          type: 'POST',\n          url: server + \"/\" + sessionId + \"/\" + handleId,\n          withCredentials: withCredentials,\n          cache: false,\n          contentType: \"application/json\",\n          data: JSON.stringify(request),\n          success: function(json) {\n            Janus.debug(\"Message sent!\");\n            Janus.debug(json);\n            if(json[\"janus\"] === \"success\") {\n              // We got a success, must have been a synchronous transaction\n              var plugindata = json[\"plugindata\"];\n              if(plugindata === undefined || plugindata === null) {\n                Janus.warn(\"Request succeeded, but missing plugindata...\");\n                callbacks.success();\n                return;\n              }\n              Janus.log(\"Synchronous transaction successful (\" + plugindata[\"plugin\"] + \")\");\n              var data = plugindata[\"data\"];\n              Janus.debug(data);\n              callbacks.success(data);\n              return;\n            } else if(json[\"janus\"] !== \"ack\") {\n              // Not a success and not an ack, must be an error\n              if(json[\"error\"] !== undefined && json[\"error\"] !== null) {\n                Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n                callbacks.error(json[\"error\"].code + \" \" + json[\"error\"].reason);\n              } else {\n                Janus.error(\"Unknown error\");\t// FIXME\n                callbacks.error(\"Unknown error\");\n              }\n              return;\n            }\n            // If we got here, the plugin decided to handle the request asynchronously\n            callbacks.success();\n          },\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\t// FIXME\n            callbacks.error(textStatus + \": \" + errorThrown);\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // Private method to send a trickle candidate\n      function sendTrickleCandidate(handleId, candidate) {\n        if(!connected) {\n          Janus.warn(\"Is the gateway down? (connected=false)\");\n          return;\n        }\n        var request = { \"janus\": \"trickle\", \"candidate\": candidate, \"transaction\": Janus.randomString(12) };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        Janus.vdebug(\"Sending trickle candidate (handle=\" + handleId + \"):\");\n        Janus.vdebug(request);\n        if(websockets) {\n          request[\"session_id\"] = sessionId;\n          request[\"handle_id\"] = handleId;\n          ws.send(JSON.stringify(request));\n          return;\n        }\n        Janus.ajax({\n          type: 'POST',\n          url: server + \"/\" + sessionId + \"/\" + handleId,\n          withCredentials: withCredentials,\n          cache: false,\n          contentType: \"application/json\",\n          data: JSON.stringify(request),\n          success: function(json) {\n            Janus.vdebug(\"Candidate sent!\");\n            Janus.vdebug(json);\n            if(json[\"janus\"] !== \"ack\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n              return;\n            }\n          },\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\t// FIXME\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // Private method to send a data channel message\n      function sendData(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        var text = callbacks.text;\n        if(text === null || text === undefined) {\n          Janus.warn(\"Invalid text\");\n          callbacks.error(\"Invalid text\");\n          return;\n        }\n        Janus.log(\"Sending string on data channel: \" + text);\n        config.dataChannel.send(text);\n        callbacks.success();\n      }\n    \n      // Private method to send a DTMF tone\n      function sendDtmf(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        if(config.dtmfSender === null || config.dtmfSender === undefined) {\n          // Create the DTMF sender, if possible\n          if(config.myStream !== undefined && config.myStream !== null) {\n            var tracks = config.myStream.getAudioTracks();\n            if(tracks !== null && tracks !== undefined && tracks.length > 0) {\n              var local_audio_track = tracks[0];\n              config.dtmfSender = config.pc.createDTMFSender(local_audio_track);\n              Janus.log(\"Created DTMF Sender\");\n              config.dtmfSender.ontonechange = function(tone) { Janus.debug(\"Sent DTMF tone: \" + tone.tone); };\n            }\n          }\n          if(config.dtmfSender === null || config.dtmfSender === undefined) {\n            Janus.warn(\"Invalid DTMF configuration\");\n            callbacks.error(\"Invalid DTMF configuration\");\n            return;\n          }\n        }\n        var dtmf = callbacks.dtmf;\n        if(dtmf === null || dtmf === undefined) {\n          Janus.warn(\"Invalid DTMF parameters\");\n          callbacks.error(\"Invalid DTMF parameters\");\n          return;\n        }\n        var tones = dtmf.tones;\n        if(tones === null || tones === undefined) {\n          Janus.warn(\"Invalid DTMF string\");\n          callbacks.error(\"Invalid DTMF string\");\n          return;\n        }\n        var duration = dtmf.duration;\n        if(duration === null || duration === undefined)\n          duration = 500;\t// We choose 500ms as the default duration for a tone\n        var gap = dtmf.gap;\n        if(gap === null || gap === undefined)\n          gap = 50;\t// We choose 50ms as the default gap between tones\n        Janus.debug(\"Sending DTMF string \" + tones + \" (duration \" + duration + \"ms, gap \" + gap + \"ms)\");\n        config.dtmfSender.insertDTMF(tones, duration, gap);\n      }\n    \n      // Private method to destroy a plugin handle\n      function destroyHandle(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        var asyncRequest = true;\n        if(callbacks.asyncRequest !== undefined && callbacks.asyncRequest !== null)\n          asyncRequest = (callbacks.asyncRequest === true);\n        Janus.log(\"Destroying handle \" + handleId + \" (sync=\" + asyncRequest + \")\");\n        cleanupWebrtc(handleId);\n        if (pluginHandles[handleId].detached) {\n          // Plugin was already detached by Janus, calling detach again will return a handle not found error, so just exit here\n          delete pluginHandles[handleId];\n          callbacks.success();\n          return;\n        }\n        if(!connected) {\n          Janus.warn(\"Is the gateway down? (connected=false)\");\n          callbacks.error(\"Is the gateway down? (connected=false)\");\n          return;\n        }\n        var request = { \"janus\": \"detach\", \"transaction\": Janus.randomString(12) };\n        if(token !== null && token !== undefined)\n          request[\"token\"] = token;\n        if(apisecret !== null && apisecret !== undefined)\n          request[\"apisecret\"] = apisecret;\n        if(websockets) {\n          request[\"session_id\"] = sessionId;\n          request[\"handle_id\"] = handleId;\n          ws.send(JSON.stringify(request));\n          delete pluginHandles[handleId];\n          callbacks.success();\n          return;\n        }\n        Janus.ajax({\n          type: 'POST',\n          url: server + \"/\" + sessionId + \"/\" + handleId,\n          async: asyncRequest,\t// Sometimes we need false here, or destroying in onbeforeunload won't work\n          withCredentials: withCredentials,\n          cache: false,\n          contentType: \"application/json\",\n          data: JSON.stringify(request),\n          success: function(json) {\n            Janus.log(\"Destroyed handle:\");\n            Janus.debug(json);\n            if(json[\"janus\"] !== \"success\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n            }\n            delete pluginHandles[handleId];\n            callbacks.success();\n          },\n          error: function(XMLHttpRequest, textStatus, errorThrown) {\n            Janus.error(textStatus + \": \" + errorThrown);\t// FIXME\n            // We cleanup anyway\n            delete pluginHandles[handleId];\n            callbacks.success();\n          },\n          dataType: \"json\"\n        });\n      }\n    \n      // WebRTC stuff\n      function streamsDone(handleId, jsep, media, callbacks, stream) {\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        Janus.debug(\"streamsDone:\", stream);\n        config.myStream = stream;\n        var pc_config = {\"iceServers\": iceServers, \"iceTransportPolicy\": iceTransportPolicy};\n        //~ var pc_constraints = {'mandatory': {'MozDontOfferDataChannel':true}};\n        var pc_constraints = {\n          \"optional\": [{\"DtlsSrtpKeyAgreement\": true}]\n        };\n        if(ipv6Support === true) {\n          // FIXME This is only supported in Chrome right now\n          // For support in Firefox track this: https://bugzilla.mozilla.org/show_bug.cgi?id=797262\n          pc_constraints.optional.push({\"googIPv6\":true});\n        }\n        if(adapter.browserDetails.browser === \"edge\") {\n          // This is Edge, enable BUNDLE explicitly\n          pc_config.bundlePolicy = \"max-bundle\";\n        }\n        Janus.log(\"Creating PeerConnection\");\n        Janus.debug(pc_constraints);\n        config.pc = new RTCPeerConnection(pc_config, pc_constraints);\n        Janus.debug(config.pc);\n        if(config.pc.getStats) {\t// FIXME\n          config.volume.value = 0;\n          config.bitrate.value = \"0 kbits/sec\";\n        }\n        Janus.log(\"Preparing local SDP and gathering candidates (trickle=\" + config.trickle + \")\");\n        config.pc.oniceconnectionstatechange = function(e) {\n          if(config.pc)\n            pluginHandle.iceState(config.pc.iceConnectionState);\n        };\n        config.pc.onicecandidate = function(event) {\n          if (event.candidate == null ||\n            (adapter.browserDetails.browser === 'edge' && event.candidate.candidate.indexOf('endOfCandidates') > 0)) {\n            Janus.log(\"End of candidates.\");\n            config.iceDone = true;\n            if(config.trickle === true) {\n              // Notify end of candidates\n              sendTrickleCandidate(handleId, {\"completed\": true});\n            } else {\n              // No trickle, time to send the complete SDP (including all candidates)\n              sendSDP(handleId, callbacks);\n            }\n          } else {\n            // JSON.stringify doesn't work on some WebRTC objects anymore\n            // See https://code.google.com/p/chromium/issues/detail?id=467366\n            var candidate = {\n              \"candidate\": event.candidate.candidate,\n              \"sdpMid\": event.candidate.sdpMid,\n              \"sdpMLineIndex\": event.candidate.sdpMLineIndex\n            };\n            if(config.trickle === true) {\n              // Send candidate\n              sendTrickleCandidate(handleId, candidate);\n            }\n          }\n        };\n        if(stream !== null && stream !== undefined) {\n          Janus.log('Adding local stream');\n          config.pc.addStream(stream);\n          pluginHandle.onlocalstream(stream);\n        }\n        config.pc.onaddstream = function(remoteStream) {\n          Janus.log(\"Handling Remote Stream\");\n          Janus.debug(remoteStream);\n          config.remoteStream = remoteStream;\n          pluginHandle.onremotestream(remoteStream.stream);\n        };\n        // Any data channel to create?\n        if(isDataEnabled(media)) {\n          Janus.log(\"Creating data channel\");\n          var onDataChannelMessage = function(event) {\n            Janus.log('Received message on data channel: ' + event.data);\n            pluginHandle.ondata(event.data);\t// FIXME\n          }\n          var onDataChannelStateChange = function() {\n            var dcState = config.dataChannel !== null ? config.dataChannel.readyState : \"null\";\n            Janus.log('State change on data channel: ' + dcState);\n            if(dcState === 'open') {\n              pluginHandle.ondataopen();\t// FIXME\n            }\n          }\n          var onDataChannelError = function(error) {\n            Janus.error('Got error on data channel:', error);\n            // TODO\n          }\n          // Until we implement the proxying of open requests within the Janus core, we open a channel ourselves whatever the case\n          config.dataChannel = config.pc.createDataChannel(\"JanusDataChannel\", {ordered:false});\t// FIXME Add options (ordered, maxRetransmits, etc.)\n          config.dataChannel.onmessage = onDataChannelMessage;\n          config.dataChannel.onopen = onDataChannelStateChange;\n          config.dataChannel.onclose = onDataChannelStateChange;\n          config.dataChannel.onerror = onDataChannelError;\n        }\n        // Create offer/answer now\n        if(jsep === null || jsep === undefined) {\n          createOffer(handleId, media, callbacks);\n        } else {\n          if(adapter.browserDetails.browser === \"edge\") {\n            // This is Edge, add an a=end-of-candidates at the end\n            jsep.sdp += \"a=end-of-candidates\\r\\n\";\n          }\n          config.pc.setRemoteDescription(\n            new RTCSessionDescription(jsep),\n            function() {\n              Janus.log(\"Remote description accepted!\");\n              createAnswer(handleId, media, callbacks);\n            }, callbacks.error);\n        }\n      }\n    \n      function prepareWebrtc(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : webrtcError;\n        var jsep = callbacks.jsep;\n        var media = callbacks.media;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        // Are we updating a session?\n        if(config.pc !== undefined && config.pc !== null) {\n          Janus.log(\"Updating existing media session\");\n          // Create offer/answer now\n          if(jsep === null || jsep === undefined) {\n            createOffer(handleId, media, callbacks);\n          } else {\n            if(adapter.browserDetails.browser === \"edge\") {\n              // This is Edge, add an a=end-of-candidates at the end\n              jsep.sdp += \"a=end-of-candidates\\r\\n\";\n            }\n            config.pc.setRemoteDescription(\n              new RTCSessionDescription(jsep),\n              function() {\n                Janus.log(\"Remote description accepted!\");\n                createAnswer(handleId, media, callbacks);\n              }, callbacks.error);\n          }\n          return;\n        }\n        // Was a MediaStream object passed, or do we need to take care of that?\n        if(callbacks.stream !== null && callbacks.stream !== undefined) {\n          var stream = callbacks.stream;\n          Janus.log(\"MediaStream provided by the application\");\n          Janus.debug(stream);\n          // Skip the getUserMedia part\n          config.streamExternal = true;\n          streamsDone(handleId, jsep, media, callbacks, stream);\n          return;\n        }\n        config.trickle = isTrickleEnabled(callbacks.trickle);\n        if(isAudioSendEnabled(media) || isVideoSendEnabled(media)) {\n          var constraints = { mandatory: {}, optional: []};\n          pluginHandle.consentDialog(true);\n          var audioSupport = isAudioSendEnabled(media);\n          if(audioSupport === true && media != undefined && media != null) {\n            if(typeof media.audio === 'object') {\n              audioSupport = media.audio;\n            }\n          }\n          var videoSupport = isVideoSendEnabled(media);\n          if(videoSupport === true && media != undefined && media != null) {\n            if(media.video && media.video != 'screen' && media.video != 'window') {\n              var width = 0;\n              var height = 0, maxHeight = 0;\n              if(media.video === 'lowres') {\n                // Small resolution, 4:3\n                height = 240;\n                maxHeight = 240;\n                width = 320;\n              } else if(media.video === 'lowres-16:9') {\n                // Small resolution, 16:9\n                height = 180;\n                maxHeight = 180;\n                width = 320;\n              } else if(media.video === 'hires' || media.video === 'hires-16:9' ) {\n                // High resolution is only 16:9\n                height = 720;\n                maxHeight = 720;\n                width = 1280;\n                if(navigator.mozGetUserMedia) {\n                  var firefoxVer = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n                  if(firefoxVer < 38) {\n                    // Unless this is and old Firefox, which doesn't support it\n                    Janus.warn(media.video + \" unsupported, falling back to stdres (old Firefox)\");\n                    height = 480;\n                    maxHeight = 480;\n                    width  = 640;\n                  }\n                }\n              } else if(media.video === 'stdres') {\n                // Normal resolution, 4:3\n                height = 480;\n                maxHeight = 480;\n                width  = 640;\n              } else if(media.video === 'stdres-16:9') {\n                // Normal resolution, 16:9\n                height = 360;\n                maxHeight = 360;\n                width = 640;\n              } else {\n                Janus.log(\"Default video setting (\" + media.video + \") is stdres 4:3\");\n                height = 480;\n                maxHeight = 480;\n                width = 640;\n              }\n              Janus.log(\"Adding media constraint \" + media.video);\n              if(navigator.mozGetUserMedia) {\n                var firefoxVer = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n                if(firefoxVer < 38) {\n                  videoSupport = {\n                    'require': ['height', 'width'],\n                    'height': {'max': maxHeight, 'min': height},\n                    'width':  {'max': width,  'min': width}\n                  };\n                } else {\n                  // http://stackoverflow.com/questions/28282385/webrtc-firefox-constraints/28911694#28911694\n                  // https://github.com/meetecho/janus-gateway/pull/246\n                  videoSupport = {\n                    'height': {'ideal': height},\n                    'width':  {'ideal': width}\n                  };\n                }\n              } else {\n                videoSupport = {\n                  'mandatory': {\n                    'maxHeight': maxHeight,\n                    'minHeight': height,\n                    'maxWidth':  width,\n                    'minWidth':  width\n                  },\n                  'optional': []\n                };\n              }\n              if(typeof media.video === 'object') {\n                videoSupport = media.video;\n              }\n              Janus.debug(videoSupport);\n            } else if(media.video === 'screen' || media.video === 'window') {\n              if (!media.screenshareFrameRate) {\n                media.screenshareFrameRate = 3;\n              }\n              // Not a webcam, but screen capture\n              if(window.location.protocol !== 'https:') {\n                // Screen sharing mandates HTTPS\n                Janus.warn(\"Screen sharing only works on HTTPS, try the https:// version of this page\");\n                pluginHandle.consentDialog(false);\n                callbacks.error(\"Screen sharing only works on HTTPS, try the https:// version of this page\");\n                return;\n              }\n              // We're going to try and use the extension for Chrome 34+, the old approach\n              // for older versions of Chrome, or the experimental support in Firefox 33+\n              var cache = {};\n              function callbackUserMedia (error, stream) {\n                pluginHandle.consentDialog(false);\n                if(error) {\n                  callbacks.error({code: error.code, name: error.name, message: error.message});\n                } else {\n                  streamsDone(handleId, jsep, media, callbacks, stream);\n                }\n              };\n              function getScreenMedia(constraints, gsmCallback, useAudio) {\n                Janus.log(\"Adding media constraint (screen capture)\");\n                Janus.debug(constraints);\n                navigator.mediaDevices.getUserMedia(constraints)\n                  .then(function(stream) {\n                    if(useAudio){\n                      navigator.mediaDevices.getUserMedia({ audio: true, video: false })\n                        .then(function (audioStream) {\n                          stream.addTrack(audioStream.getAudioTracks()[0]);\n                          gsmCallback(null, stream);\n                        })\n                    } else {\n                      gsmCallback(null, stream);\n                    }\n                  })\n                  .catch(function(error) { pluginHandle.consentDialog(false); gsmCallback(error); });\n              };\n              if(adapter.browserDetails.browser === 'chrome') {\n                var chromever = adapter.browserDetails.version;\n                var maxver = 33;\n                if(window.navigator.userAgent.match('Linux'))\n                  maxver = 35;\t// \"known\" crash in chrome 34 and 35 on linux\n                if(chromever >= 26 && chromever <= maxver) {\n                  // Chrome 26->33 requires some awkward chrome://flags manipulation\n                  constraints = {\n                    video: {\n                      mandatory: {\n                        googLeakyBucket: true,\n                        maxWidth: window.screen.width,\n                        maxHeight: window.screen.height,\n                        minFrameRate: media.screenshareFrameRate,\n                        maxFrameRate: media.screenshareFrameRate,\n                        chromeMediaSource: 'screen'\n                      }\n                    },\n                    audio: isAudioSendEnabled(media)\n                  };\n                  getScreenMedia(constraints, callbackUserMedia);\n                } else {\n                  // Chrome 34+ requires an extension\n                  var pending = window.setTimeout(\n                    function () {\n                      error = new Error('NavigatorUserMediaError');\n                      error.name = 'The required Chrome extension is not installed: click <a href=\"#\">here</a> to install it. (NOTE: this will need you to refresh the page)';\n                      pluginHandle.consentDialog(false);\n                      return callbacks.error(error);\n                    }, 1000);\n                  cache[pending] = [callbackUserMedia, null];\n                  window.postMessage({ type: 'janusGetScreen', id: pending }, '*');\n                }\n              } else if (window.navigator.userAgent.match('Firefox')) {\n                var ffver = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n                if(ffver >= 33) {\n                  // Firefox 33+ has experimental support for screen sharing\n                  constraints = {\n                    video: {\n                      mozMediaSource: media.video,\n                      mediaSource: media.video\n                    },\n                    audio: isAudioSendEnabled(media)\n                  };\n                  getScreenMedia(constraints, function (err, stream) {\n                    callbackUserMedia(err, stream);\n                    // Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=1045810\n                    if (!err) {\n                      var lastTime = stream.currentTime;\n                      var polly = window.setInterval(function () {\n                        if(!stream)\n                          window.clearInterval(polly);\n                        if(stream.currentTime == lastTime) {\n                          window.clearInterval(polly);\n                          if(stream.onended) {\n                            stream.onended();\n                          }\n                        }\n                        lastTime = stream.currentTime;\n                      }, 500);\n                    }\n                  });\n                } else {\n                  var error = new Error('NavigatorUserMediaError');\n                  error.name = 'Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)';\n                  pluginHandle.consentDialog(false);\n                  callbacks.error(error);\n                  return;\n                }\n              }\n    \n              // Wait for events from the Chrome Extension\n              window.addEventListener('message', function (event) {\n                if(event.origin != window.location.origin)\n                  return;\n                if(event.data.type == 'janusGotScreen' && cache[event.data.id]) {\n                  var data = cache[event.data.id];\n                  var callback = data[0];\n                  delete cache[event.data.id];\n    \n                  if (event.data.sourceId === '') {\n                    // user canceled\n                    var error = new Error('NavigatorUserMediaError');\n                    error.name = 'You cancelled the request for permission, giving up...';\n                    pluginHandle.consentDialog(false);\n                    callbacks.error(error);\n                  } else {\n                    constraints = {\n                      audio: false,\n                      video: {\n                        mandatory: {\n                          chromeMediaSource: 'desktop',\n                          maxWidth: window.screen.width,\n                          maxHeight: window.screen.height,\n                          minFrameRate: media.screenshareFrameRate,\n                          maxFrameRate: media.screenshareFrameRate,\n                        },\n                        optional: [\n                          {googLeakyBucket: true},\n                          {googTemporalLayeredScreencast: true}\n                        ]\n                      }\n                    };\n                    constraints.video.mandatory.chromeMediaSourceId = event.data.sourceId;\n                    getScreenMedia(constraints, callback, isAudioSendEnabled(media));\n                  }\n                } else if (event.data.type == 'janusGetScreenPending') {\n                  window.clearTimeout(event.data.id);\n                }\n              });\n              return;\n            }\n          }\n          // If we got here, we're not screensharing\n          if(media === null || media === undefined || media.video !== 'screen') {\n            // Check whether all media sources are actually available or not\n            navigator.mediaDevices.enumerateDevices().then(function(devices) {\n              var audioExist = devices.some(function(device) {\n                  return device.kind === 'audioinput';\n                }),\n                videoExist = devices.some(function(device) {\n                  return device.kind === 'videoinput';\n                });\n    \n              // Check whether a missing device is really a problem\n              var audioSend = isAudioSendEnabled(media);\n              var videoSend = isVideoSendEnabled(media);\n              var needAudioDevice = isAudioSendRequired(media);\n              var needVideoDevice = isVideoSendRequired(media);\n              if(audioSend || videoSend || needAudioDevice || needVideoDevice) {\n                // We need to send either audio or video\n                var haveAudioDevice = audioSend ? audioExist : false;\n                var haveVideoDevice = videoSend ? videoExist : false;\n                if(!haveAudioDevice && !haveVideoDevice) {\n                  // FIXME Should we really give up, or just assume recvonly for both?\n                  pluginHandle.consentDialog(false);\n                  callbacks.error('No capture device found');\n                  return false;\n                } else if(!haveAudioDevice && needAudioDevice) {\n                  pluginHandle.consentDialog(false);\n                  callbacks.error('Audio capture is required, but no capture device found');\n                  return false;\n                } else if(!haveVideoDevice && needVideoDevice) {\n                  pluginHandle.consentDialog(false);\n                  callbacks.error('Video capture is required, but no capture device found');\n                  return false;\n                }\n              }\n    \n              navigator.mediaDevices.getUserMedia({\n                audio: audioExist ? audioSupport : false,\n                video: videoExist ? videoSupport : false\n              })\n                .then(function(stream) { pluginHandle.consentDialog(false); streamsDone(handleId, jsep, media, callbacks, stream); })\n                .catch(function(error) { pluginHandle.consentDialog(false); callbacks.error({code: error.code, name: error.name, message: error.message}); });\n            })\n              .catch(function(error) {\n                pluginHandle.consentDialog(false);\n                callbacks.error('enumerateDevices error', error);\n              });\n          }\n        } else {\n          // No need to do a getUserMedia, create offer/answer right away\n          streamsDone(handleId, jsep, media, callbacks);\n        }\n      }\n    \n      function prepareWebrtcPeer(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : webrtcError;\n        var jsep = callbacks.jsep;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        if(jsep !== undefined && jsep !== null) {\n          if(config.pc === null) {\n            Janus.warn(\"Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep\");\n            callbacks.error(\"No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep\");\n            return;\n          }\n          if(adapter.browserDetails.browser === \"edge\") {\n            // This is Edge, add an a=end-of-candidates at the end\n            jsep.sdp += \"a=end-of-candidates\\r\\n\";\n          }\n          config.pc.setRemoteDescription(\n            new RTCSessionDescription(jsep),\n            function() {\n              Janus.log(\"Remote description accepted!\");\n              callbacks.success();\n            }, callbacks.error);\n        } else {\n          callbacks.error(\"Invalid JSEP\");\n        }\n      }\n    \n      function createOffer(handleId, media, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        Janus.log(\"Creating offer (iceDone=\" + config.iceDone + \")\");\n        // https://code.google.com/p/webrtc/issues/detail?id=3508\n        var mediaConstraints = null;\n        if(adapter.browserDetails.browser == \"firefox\" || adapter.browserDetails.browser == \"edge\") {\n          mediaConstraints = {\n            'offerToReceiveAudio':isAudioRecvEnabled(media),\n            'offerToReceiveVideo':isVideoRecvEnabled(media)\n          };\n        } else {\n          mediaConstraints = {\n            'mandatory': {\n              'OfferToReceiveAudio':isAudioRecvEnabled(media),\n              'OfferToReceiveVideo':isVideoRecvEnabled(media)\n            }\n          };\n        }\n        Janus.debug(mediaConstraints);\n        config.pc.createOffer(\n          function(offer) {\n            Janus.debug(offer);\n            if(config.mySdp === null || config.mySdp === undefined) {\n              Janus.log(\"Setting local description\");\n              config.mySdp = offer.sdp;\n              config.pc.setLocalDescription(offer);\n            }\n            if(!config.iceDone && !config.trickle) {\n              // Don't do anything until we have all candidates\n              Janus.log(\"Waiting for all candidates...\");\n              return;\n            }\n            if(config.sdpSent) {\n              Janus.log(\"Offer already sent, not sending it again\");\n              return;\n            }\n            Janus.log(\"Offer ready\");\n            Janus.debug(callbacks);\n            config.sdpSent = true;\n            // JSON.stringify doesn't work on some WebRTC objects anymore\n            // See https://code.google.com/p/chromium/issues/detail?id=467366\n            var jsep = {\n              \"type\": offer.type,\n              \"sdp\": offer.sdp\n            };\n            callbacks.success(jsep);\n          }, callbacks.error, mediaConstraints);\n      }\n    \n      function createAnswer(handleId, media, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          callbacks.error(\"Invalid handle\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        Janus.log(\"Creating answer (iceDone=\" + config.iceDone + \")\");\n        var mediaConstraints = null;\n        if(adapter.browserDetails.browser == \"firefox\" || adapter.browserDetails.browser == \"edge\") {\n          mediaConstraints = {\n            'offerToReceiveAudio':isAudioRecvEnabled(media),\n            'offerToReceiveVideo':isVideoRecvEnabled(media)\n          };\n        } else {\n          mediaConstraints = {\n            'mandatory': {\n              'OfferToReceiveAudio':isAudioRecvEnabled(media),\n              'OfferToReceiveVideo':isVideoRecvEnabled(media)\n            }\n          };\n        }\n        Janus.debug(mediaConstraints);\n        config.pc.createAnswer(\n          function(answer) {\n            Janus.debug(answer);\n            if(config.mySdp === null || config.mySdp === undefined) {\n              Janus.log(\"Setting local description\");\n              config.mySdp = answer.sdp;\n              config.pc.setLocalDescription(answer);\n            }\n            if(!config.iceDone && !config.trickle) {\n              // Don't do anything until we have all candidates\n              Janus.log(\"Waiting for all candidates...\");\n              return;\n            }\n            if(config.sdpSent) {\t// FIXME badly\n              Janus.log(\"Answer already sent, not sending it again\");\n              return;\n            }\n            config.sdpSent = true;\n            // JSON.stringify doesn't work on some WebRTC objects anymore\n            // See https://code.google.com/p/chromium/issues/detail?id=467366\n            var jsep = {\n              \"type\": answer.type,\n              \"sdp\": answer.sdp\n            };\n            callbacks.success(jsep);\n          }, callbacks.error, mediaConstraints);\n      }\n    \n      function sendSDP(handleId, callbacks) {\n        callbacks = callbacks || {};\n        callbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : Janus.noop;\n        callbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : Janus.noop;\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle, not sending anything\");\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        Janus.log(\"Sending offer/answer SDP...\");\n        if(config.mySdp === null || config.mySdp === undefined) {\n          Janus.warn(\"Local SDP instance is invalid, not sending anything...\");\n          return;\n        }\n        config.mySdp = {\n          \"type\": config.pc.localDescription.type,\n          \"sdp\": config.pc.localDescription.sdp\n        };\n        if(config.sdpSent) {\n          Janus.log(\"Offer/Answer SDP already sent, not sending it again\");\n          return;\n        }\n        if(config.trickle === false)\n          config.mySdp[\"trickle\"] = false;\n        Janus.debug(callbacks);\n        config.sdpSent = true;\n        callbacks.success(config.mySdp);\n      }\n    \n      function getVolume(handleId) {\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          return 0;\n        }\n        var config = pluginHandle.webrtcStuff;\n        // Start getting the volume, if getStats is supported\n        if(config.pc.getStats && adapter.browserDetails.browser == \"chrome\") {\t// FIXME\n          if(config.remoteStream === null || config.remoteStream === undefined) {\n            Janus.warn(\"Remote stream unavailable\");\n            return 0;\n          }\n          // http://webrtc.googlecode.com/svn/trunk/samples/js/demos/html/constraints-and-stats.html\n          if(config.volume.timer === null || config.volume.timer === undefined) {\n            Janus.log(\"Starting volume monitor\");\n            config.volume.timer = setInterval(function() {\n              config.pc.getStats(function(stats) {\n                var results = stats.result();\n                for(var i=0; i<results.length; i++) {\n                  var res = results[i];\n                  if(res.type == 'ssrc' && res.stat('audioOutputLevel')) {\n                    config.volume.value = res.stat('audioOutputLevel');\n                  }\n                }\n              });\n            }, 200);\n            return 0;\t// We don't have a volume to return yet\n          }\n          return config.volume.value;\n        } else {\n          Janus.log(\"Getting the remote volume unsupported by browser\");\n          return 0;\n        }\n      }\n    \n      function isMuted(handleId, video) {\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          return true;\n        }\n        var config = pluginHandle.webrtcStuff;\n        if(config.pc === null || config.pc === undefined) {\n          Janus.warn(\"Invalid PeerConnection\");\n          return true;\n        }\n        if(config.myStream === undefined || config.myStream === null) {\n          Janus.warn(\"Invalid local MediaStream\");\n          return true;\n        }\n        if(video) {\n          // Check video track\n          if(config.myStream.getVideoTracks() === null\n            || config.myStream.getVideoTracks() === undefined\n            || config.myStream.getVideoTracks().length === 0) {\n            Janus.warn(\"No video track\");\n            return true;\n          }\n          return !config.myStream.getVideoTracks()[0].enabled;\n        } else {\n          // Check audio track\n          if(config.myStream.getAudioTracks() === null\n            || config.myStream.getAudioTracks() === undefined\n            || config.myStream.getAudioTracks().length === 0) {\n            Janus.warn(\"No audio track\");\n            return true;\n          }\n          return !config.myStream.getAudioTracks()[0].enabled;\n        }\n      }\n    \n      function mute(handleId, video, mute) {\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          return false;\n        }\n        var config = pluginHandle.webrtcStuff;\n        if(config.pc === null || config.pc === undefined) {\n          Janus.warn(\"Invalid PeerConnection\");\n          return false;\n        }\n        if(config.myStream === undefined || config.myStream === null) {\n          Janus.warn(\"Invalid local MediaStream\");\n          return false;\n        }\n        if(video) {\n          // Mute/unmute video track\n          if(config.myStream.getVideoTracks() === null\n            || config.myStream.getVideoTracks() === undefined\n            || config.myStream.getVideoTracks().length === 0) {\n            Janus.warn(\"No video track\");\n            return false;\n          }\n          config.myStream.getVideoTracks()[0].enabled = mute ? false : true;\n          return true;\n        } else {\n          // Mute/unmute audio track\n          if(config.myStream.getAudioTracks() === null\n            || config.myStream.getAudioTracks() === undefined\n            || config.myStream.getAudioTracks().length === 0) {\n            Janus.warn(\"No audio track\");\n            return false;\n          }\n          config.myStream.getAudioTracks()[0].enabled = mute ? false : true;\n          return true;\n        }\n      }\n    \n      function getBitrate(handleId) {\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined ||\n          pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n          Janus.warn(\"Invalid handle\");\n          return \"Invalid handle\";\n        }\n        var config = pluginHandle.webrtcStuff;\n        if(config.pc === null || config.pc === undefined)\n          return \"Invalid PeerConnection\";\n        // Start getting the bitrate, if getStats is supported\n        if(config.pc.getStats && adapter.browserDetails.browser == \"chrome\") {\n          // Do it the Chrome way\n          if(config.remoteStream === null || config.remoteStream === undefined) {\n            Janus.warn(\"Remote stream unavailable\");\n            return \"Remote stream unavailable\";\n          }\n          // http://webrtc.googlecode.com/svn/trunk/samples/js/demos/html/constraints-and-stats.html\n          if(config.bitrate.timer === null || config.bitrate.timer === undefined) {\n            Janus.log(\"Starting bitrate timer (Chrome)\");\n            config.bitrate.timer = setInterval(function() {\n              config.pc.getStats(function(stats) {\n                var results = stats.result();\n                for(var i=0; i<results.length; i++) {\n                  var res = results[i];\n                  if(res.type == 'ssrc' && res.stat('googFrameHeightReceived')) {\n                    config.bitrate.bsnow = res.stat('bytesReceived');\n                    config.bitrate.tsnow = res.timestamp;\n                    if(config.bitrate.bsbefore === null || config.bitrate.tsbefore === null) {\n                      // Skip this round\n                      config.bitrate.bsbefore = config.bitrate.bsnow;\n                      config.bitrate.tsbefore = config.bitrate.tsnow;\n                    } else {\n                      // Calculate bitrate\n                      var bitRate = Math.round((config.bitrate.bsnow - config.bitrate.bsbefore) * 8 / (config.bitrate.tsnow - config.bitrate.tsbefore));\n                      config.bitrate.value = bitRate + ' kbits/sec';\n                      //~ Janus.log(\"Estimated bitrate is \" + config.bitrate.value);\n                      config.bitrate.bsbefore = config.bitrate.bsnow;\n                      config.bitrate.tsbefore = config.bitrate.tsnow;\n                    }\n                  }\n                }\n              });\n            }, 1000);\n            return \"0 kbits/sec\";\t// We don't have a bitrate value yet\n          }\n          return config.bitrate.value;\n        } else if(config.pc.getStats && adapter.browserDetails.browser == \"firefox\") {\n          // Do it the Firefox way\n          if(config.remoteStream === null || config.remoteStream === undefined\n            || config.remoteStream.streams[0] === null || config.remoteStream.streams[0] === undefined) {\n            Janus.warn(\"Remote stream unavailable\");\n            return \"Remote stream unavailable\";\n          }\n          var videoTracks = config.remoteStream.streams[0].getVideoTracks();\n          if(videoTracks === null || videoTracks === undefined || videoTracks.length < 1) {\n            Janus.warn(\"No video track\");\n            return \"No video track\";\n          }\n          // https://github.com/muaz-khan/getStats/blob/master/getStats.js\n          if(config.bitrate.timer === null || config.bitrate.timer === undefined) {\n            Janus.log(\"Starting bitrate timer (Firefox)\");\n            config.bitrate.timer = setInterval(function() {\n              // We need a helper callback\n              var cb = function(res) {\n                if(res === null || res === undefined ||\n                  res.inbound_rtp_video_1 == null || res.inbound_rtp_video_1 == null) {\n                  config.bitrate.value = \"Missing inbound_rtp_video_1\";\n                  return;\n                }\n                config.bitrate.bsnow = res.inbound_rtp_video_1.bytesReceived;\n                config.bitrate.tsnow = res.inbound_rtp_video_1.timestamp;\n                if(config.bitrate.bsbefore === null || config.bitrate.tsbefore === null) {\n                  // Skip this round\n                  config.bitrate.bsbefore = config.bitrate.bsnow;\n                  config.bitrate.tsbefore = config.bitrate.tsnow;\n                } else {\n                  // Calculate bitrate\n                  var bitRate = Math.round((config.bitrate.bsnow - config.bitrate.bsbefore) * 8 / (config.bitrate.tsnow - config.bitrate.tsbefore));\n                  config.bitrate.value = bitRate + ' kbits/sec';\n                  config.bitrate.bsbefore = config.bitrate.bsnow;\n                  config.bitrate.tsbefore = config.bitrate.tsnow;\n                }\n              };\n              // Actually get the stats\n              config.pc.getStats(videoTracks[0], function(stats) {\n                cb(stats);\n              }, cb);\n            }, 1000);\n            return \"0 kbits/sec\";\t// We don't have a bitrate value yet\n          }\n          return config.bitrate.value;\n        } else {\n          Janus.warn(\"Getting the video bitrate unsupported by browser\");\n          return \"Feature unsupported by browser\";\n        }\n      }\n    \n      function webrtcError(error) {\n        Janus.error(\"WebRTC error:\", error);\n      }\n    \n      function cleanupWebrtc(handleId, hangupRequest) {\n        Janus.log(\"Cleaning WebRTC stuff\");\n        var pluginHandle = pluginHandles[handleId];\n        if(pluginHandle === null || pluginHandle === undefined) {\n          // Nothing to clean\n          return;\n        }\n        var config = pluginHandle.webrtcStuff;\n        if(config !== null && config !== undefined) {\n          if(hangupRequest === true) {\n            // Send a hangup request (we don't really care about the response)\n            var request = { \"janus\": \"hangup\", \"transaction\": Janus.randomString(12) };\n            if(token !== null && token !== undefined)\n              request[\"token\"] = token;\n            if(apisecret !== null && apisecret !== undefined)\n              request[\"apisecret\"] = apisecret;\n            Janus.debug(\"Sending hangup request (handle=\" + handleId + \"):\");\n            Janus.debug(request);\n            if(websockets) {\n              request[\"session_id\"] = sessionId;\n              request[\"handle_id\"] = handleId;\n              ws.send(JSON.stringify(request));\n            } else {\n              Janus.ajax({\n                type: 'POST',\n                url: server + \"/\" + sessionId + \"/\" + handleId,\n                withCredentials: withCredentials,\n                cache: false,\n                contentType: \"application/json\",\n                data: JSON.stringify(request),\n                dataType: \"json\"\n              });\n            }\n          }\n          // Cleanup stack\n          config.remoteStream = null;\n          if(config.volume.timer)\n            clearInterval(config.volume.timer);\n          config.volume.value = null;\n          if(config.bitrate.timer)\n            clearInterval(config.bitrate.timer);\n          config.bitrate.timer = null;\n          config.bitrate.bsnow = null;\n          config.bitrate.bsbefore = null;\n          config.bitrate.tsnow = null;\n          config.bitrate.tsbefore = null;\n          config.bitrate.value = null;\n          try {\n            // Try a MediaStream.stop() first\n            if(!config.streamExternal && config.myStream !== null && config.myStream !== undefined) {\n              Janus.log(\"Stopping local stream\");\n              config.myStream.stop();\n            }\n          } catch(e) {\n            // Do nothing if this fails\n          }\n          try {\n            // Try a MediaStreamTrack.stop() for each track as well\n            if(!config.streamExternal && config.myStream !== null && config.myStream !== undefined) {\n              Janus.log(\"Stopping local stream tracks\");\n              var tracks = config.myStream.getTracks();\n              for(var i in tracks) {\n                var mst = tracks[i];\n                Janus.log(mst);\n                if(mst !== null && mst !== undefined)\n                  mst.stop();\n              }\n            }\n          } catch(e) {\n            // Do nothing if this fails\n          }\n          config.streamExternal = false;\n          config.myStream = null;\n          // Close PeerConnection\n          try {\n            config.pc.close();\n          } catch(e) {\n            // Do nothing\n          }\n          config.pc = null;\n          config.mySdp = null;\n          config.iceDone = false;\n          config.sdpSent = false;\n          config.dataChannel = null;\n          config.dtmfSender = null;\n        }\n        pluginHandle.oncleanup();\n      }\n    \n      // Helper methods to parse a media object\n      function isAudioSendEnabled(media) {\n        Janus.debug(\"isAudioSendEnabled:\", media);\n        if(media === undefined || media === null)\n          return true;\t// Default\n        if(media.audio === false)\n          return false;\t// Generic audio has precedence\n        if(media.audioSend === undefined || media.audioSend === null)\n          return true;\t// Default\n        return (media.audioSend === true);\n      }\n    \n      function isAudioSendRequired(media) {\n        Janus.debug(\"isAudioSendRequired:\", media);\n        if(media === undefined || media === null)\n          return false;\t// Default\n        if(media.audio === false || media.audioSend === false)\n          return false;\t// If we're not asking to capture audio, it's not required\n        if(media.failIfNoAudio === undefined || media.failIfNoAudio === null)\n          return false;\t// Default\n        return (media.failIfNoAudio === true);\n      }\n    \n      function isAudioRecvEnabled(media) {\n        Janus.debug(\"isAudioRecvEnabled:\", media);\n        if(media === undefined || media === null)\n          return true;\t// Default\n        if(media.audio === false)\n          return false;\t// Generic audio has precedence\n        if(media.audioRecv === undefined || media.audioRecv === null)\n          return true;\t// Default\n        return (media.audioRecv === true);\n      }\n    \n      function isVideoSendEnabled(media) {\n        Janus.debug(\"isVideoSendEnabled:\", media);\n        if(media === undefined || media === null)\n          return true;\t// Default\n        if(media.video === false)\n          return false;\t// Generic video has precedence\n        if(media.videoSend === undefined || media.videoSend === null)\n          return true;\t// Default\n        return (media.videoSend === true);\n      }\n    \n      function isVideoSendRequired(media) {\n        Janus.debug(\"isVideoSendRequired:\", media);\n        if(media === undefined || media === null)\n          return false;\t// Default\n        if(media.video === false || media.videoSend === false)\n          return false;\t// If we're not asking to capture video, it's not required\n        if(media.failIfNoVideo === undefined || media.failIfNoVideo === null)\n          return false;\t// Default\n        return (media.failIfNoVideo === true);\n      }\n    \n      function isVideoRecvEnabled(media) {\n        Janus.debug(\"isVideoRecvEnabled:\", media);\n        if(media === undefined || media === null)\n          return true;\t// Default\n        if(media.video === false)\n          return false;\t// Generic video has precedence\n        if(media.videoRecv === undefined || media.videoRecv === null)\n          return true;\t// Default\n        return (media.videoRecv === true);\n      }\n    \n      function isDataEnabled(media) {\n        Janus.debug(\"isDataEnabled:\", media);\n        if(adapter.browserDetails.browser == \"edge\") {\n          Janus.warn(\"Edge doesn't support data channels yet\");\n          return false;\n        }\n        if(media === undefined || media === null)\n          return false;\t// Default\n        return (media.data === true);\n      }\n    \n      function isTrickleEnabled(trickle) {\n        Janus.debug(\"isTrickleEnabled:\", trickle);\n        if(trickle === undefined || trickle === null)\n          return true;\t// Default is true\n        return (trickle === true);\n      }\n    };\n    \n    export default Janus\n    "]}]}